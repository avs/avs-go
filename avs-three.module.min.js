// @license Licensed by Advanced Visual Systems Inc. to You under the Apache License, Version 2.0.
import{Vector3 as e,Group as t,Matrix4 as i,Points as n,LineSegments as a,Mesh as r,PointLight as s,DirectionalLight as o,AmbientLight as l,OrthographicCamera as c,PerspectiveCamera as d,Scene as h,Matrix3 as p,Vector2 as u,Color as f,UniformsUtils as m,UniformsLib as v,ShaderMaterial as g,LessEqualDepth as y,AlwaysStencilFunc as b,KeepStencilOp as w,Loader as x,FileLoader as S,Vector4 as O,Plane as k,Float32BufferAttribute as C,Box3 as E,InstancedBufferGeometry as _,InstancedInterleavedBuffer as T,InterleavedBufferAttribute as L,Sphere as P,Ray as M,Object3D as j,MathUtils as A,LoaderUtils as R,BufferGeometryLoader as I,SphereGeometry as D,LoadingManager as N,ImageLoader as F,CubeTexture as z,Texture as H,Fog as W,FogExp2 as Y,UVMapping as G,CubeReflectionMapping as U,CubeRefractionMapping as B,EquirectangularReflectionMapping as X,EquirectangularRefractionMapping as Z,CubeUVReflectionMapping as V,CubeUVRefractionMapping as q,RepeatWrapping as J,ClampToEdgeWrapping as K,MirroredRepeatWrapping as Q,NearestFilter as $,NearestMipmapNearestFilter as ee,NearestMipmapLinearFilter as te,LinearFilter as ie,LinearMipmapNearestFilter as ne,LinearMipmapLinearFilter as ae,Raycaster as re,WebGLRenderTarget as se,InstancedBufferAttribute as oe,BufferGeometry as le,EventDispatcher as ce,TOUCH as de,Quaternion as he,MOUSE as pe,Spherical as ue,Clock as fe,NumberKeyframeTrack as me,BooleanKeyframeTrack as ve,AnimationClip as ge,AnimationObjectGroup as ye,AnimationMixer as be}from"three";var we="1",xe=400,Se=400,Oe=.03,ke={All:0,Closest:1},Ce={Ray:0,Rectangle:1},Ee={Cell:0,CellSet:1,SceneNode:2},_e={Points:1,Lines:2,Triangles:3,Quads:4};const Te=new e;class Le extends t{constructor(){super(),this.scaleFactorX=1,this.scaleFactorY=1,this.scaleFactorZ=1}updateMatrix(){Te.set(this.scale.x*this.scaleFactorX,this.scale.y*this.scaleFactorY,this.scale.z*this.scaleFactorZ),this.matrix.compose(this.position,this.quaternion,Te),this.matrixWorldNeedsUpdate=!0}toJSON(e){const t=super.toJSON(e);return"{}"!==JSON.stringify(this.internalData)&&(t.object.internalData=this.internalData),t.metadata=void 0,1===this.layers.mask&&(t.object.layers=void 0),this.matrix.equals(new i)&&(t.object.matrix=void 0),t}}const Pe=new e,Me=new e;class je extends n{constructor(e,t){super(e,t),this.scaleFactorX=1,this.scaleFactorY=1,this.scaleFactorZ=1}updateMatrix(){Me.set(this.scale.x*this.scaleFactorX,this.scale.y*this.scaleFactorY,this.scale.z*this.scaleFactorZ),this.matrix.compose(this.position,this.quaternion,Me),this.matrixWorldNeedsUpdate=!0}toJSON(e){const t=super.toJSON(e);return t.metadata=void 0,1===this.layers.mask&&(t.object.layers=void 0),this.matrix.equals(new i)&&(t.object.matrix=void 0),t}raycast(e,t){const i=this.geometry.attributes,n=i.position.array;let a,r,s,o,l,c,d=.5;void 0===this.material.vertexSizes&&(d=this.material.size/2);for(let h=0,p=n.length/3;h<p;h++)Pe.fromArray(n,3*h),Pe.applyMatrix4(this.matrixWorld),Pe.project(e.camera),a=(Pe.x+1)/2*e.landscapeWidth,r=(1-(Pe.y+1)/2)*e.landscapeHeight,this.material.vertexSizes&&(d=i.vsize.array[h]/2),s=a-d,o=a+d,l=r-d,c=r+d,e.x>=s&&e.x<=o&&e.y>=l&&e.y<=c&&t.push({distance:null,distanceToRay:null,point:null,index:h,face:null,object:this})}}const Ae=new e;class Re extends a{constructor(e,t){super(e,t),this.scaleFactorX=1,this.scaleFactorY=1,this.scaleFactorZ=1}updateMatrix(){Ae.set(this.scale.x*this.scaleFactorX,this.scale.y*this.scaleFactorY,this.scale.z*this.scaleFactorZ),this.matrix.compose(this.position,this.quaternion,Ae),this.matrixWorldNeedsUpdate=!0}toJSON(e){const t=super.toJSON(e);return t.metadata=void 0,1===this.layers.mask&&(t.object.layers=void 0),this.matrix.equals(new i)&&(t.object.matrix=void 0),t}}const Ie=new i,De=new i,Ne=new i,Fe=[],ze=new r,He=new e;class We extends r{constructor(e,t){super(e,t),this.scaleFactorX=1,this.scaleFactorY=1,this.scaleFactorZ=1}updateMatrix(){He.set(this.scale.x*this.scaleFactorX,this.scale.y*this.scaleFactorY,this.scale.z*this.scaleFactorZ),this.matrix.compose(this.position,this.quaternion,He),this.matrixWorldNeedsUpdate=!0}raycast(e,t){if(ze.geometry=this.geometry,ze.material=this.material,void 0===ze.material||void 0===ze.geometry)return;if(!ze.material.glyphs)return super.raycast(e,t);const i=this.matrixWorld,n=ze.geometry.attributes.offset.array,a=n.length/3;let r,s,o;for(let l=0;l<a;l++){if(r=3*l,ze.material.vertexScales?(s=ze.geometry.attributes.scale.array,Ie.makeScale(s[r],s[r+1],s[r+2])):Ie.makeScale(ze.material.scale.x,ze.material.scale.y,ze.material.scale.z),ze.material.vertexOrientations&&(o=ze.geometry.attributes.orientation.array,Ne.set(o[r],o[r+3],o[r+6],0,o[r+1],o[r+4],o[r+7],0,o[r+2],o[r+5],o[r+8],0,0,0,0,1),Ie.multiply(Ne)),Ie.setPosition(n[r],n[r+1],n[r+2]),De.multiplyMatrices(i,Ie),ze.matrixWorld=De,ze.raycast(e,Fe),Fe.length>0){const e=Fe[0];e.faceIndex=l,e.object=this,t.push(e)}Fe.length=0}}toJSON(e){const t=super.toJSON(e);return t.metadata=void 0,1===this.layers.mask&&(t.object.layers=void 0),this.matrix.equals(new i)&&(t.object.matrix=void 0),t}}class Ye extends s{toJSON(e){const t=super.toJSON(e);return t.metadata=void 0,1===this.layers.mask&&(t.object.layers=void 0),this.matrix.equals(new i)&&(t.object.matrix=void 0),16777215===this.color.getHex()&&(t.object.color=void 0),1===this.intensity&&(t.object.intensity=void 0),t.object.shadow=void 0,t}}class Ge extends o{toJSON(e){const t=super.toJSON(e);return t.metadata=void 0,1===this.layers.mask&&(t.object.layers=void 0),this.matrix.equals(new i)&&(t.object.matrix=void 0),16777215===this.color.getHex()&&(t.object.color=void 0),1===this.intensity&&(t.object.intensity=void 0),t.object.shadow=void 0,t}}class Ue extends l{toJSON(e){const t=super.toJSON(e);return t.metadata=void 0,1===this.layers.mask&&(t.object.layers=void 0),this.matrix.equals(new i)&&(t.object.matrix=void 0),16777215===this.color.getHex()&&(t.object.color=void 0),1===this.intensity&&(t.object.intensity=void 0),t}}class Be extends c{constructor(e,t,i,n,a,r){super(e,t,i,n,a,r),this.keepAspectRatio=!1,this.origLeft=e,this.origRight=t,this.origTop=i,this.origBottom=n}toJSON(e){const t=super.toJSON(e);return t.metadata=void 0,1===this.layers.mask&&(t.object.layers=void 0),this.matrix.equals(new i)&&(t.object.matrix=void 0),1===this.zoom&&(t.object.zoom=void 0),-1===this.left&&(t.object.left=void 0),1===this.right&&(t.object.right=void 0),1===this.top&&(t.object.top=void 0),-1===this.bottom&&(t.object.bottom=void 0),.1===this.near&&(t.object.near=void 0),2e3===this.far&&(t.object.far=void 0),this.keepAspectRatio&&(t.object.keepAspectRatio=!0),t}}class Xe extends d{toJSON(e){const t=super.toJSON(e);return t.metadata=void 0,1===this.layers.mask&&(t.object.layers=void 0),this.matrix.equals(new i)&&(t.object.matrix=void 0),50===this.fov&&(t.object.fov=void 0),1===this.zoom&&(t.object.zoom=void 0),.1===this.near&&(t.object.near=void 0),2e3===this.far&&(t.object.far=void 0),10===this.focus&&(t.object.focus=void 0),1===this.aspect&&(t.object.aspect=void 0),35===this.filmGauge&&(t.object.filmGauge=void 0),0===this.filmOffset&&(t.object.filmOffset=void 0),t}}class Ze extends h{toJSON(e){const t=super.toJSON(e);return t.metadata=void 0,1===this.layers.mask&&(t.object.layers=void 0),this.matrix.equals(new i)&&(t.object.matrix=void 0),t}}const Ve={base:{pickState:{value:new Float32Array(1)},startCell:{value:0},uscale:{value:new e(1,1,1)},scaleFactorX:{value:1},scaleFactorY:{value:1},scaleFactorZ:{value:1},uorientation:{value:new p},opacityFactor:{value:1}},line:{linePattern:{value:65535},resolution:{value:new u(1,1)}},mesh:{stipple:{value:0},stippleColor:{value:new f(0)},stipplePattern:{value:new Float32Array(64)}}},qe="uniform vec3 diffuse;\nuniform float opacity;\nuniform float opacityFactor;\nuniform float linePattern;\nuniform float pickState[ 1 ];\nvarying vec3 vPickColor;\n#ifdef USE_PATTERN\nvarying float vPattern;\n#endif\nvarying float vDistance;\n#include <common>\n#include <color_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tif ( pickState[ 0 ] > 0.5 ) {\n\t\tgl_FragColor = vec4( vPickColor, 1.0 );\n\t} else {\n\tfloat pattern;\n#ifdef USE_PATTERN\n\tpattern = floor( vPattern );\n#else\n\tpattern = linePattern;\n#endif\n\tfloat shift = pow( 2.0, floor( mod( vDistance, 16.0 ) ) );\n\tif( mod( floor( pattern / shift ), 2.0 ) < 0.5 ) {\n\t\tdiscard;\n\t}\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity * opacityFactor );\n\t#include <logdepthbuf_fragment>\n\t#include <color_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\t#include <output_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t}\n}",Je="attribute float vsize;\nattribute float cellCount;\nattribute vec3 offset;\nattribute vec3 scale;\nuniform vec3 uscale;\nuniform float scaleFactorX;\nuniform float scaleFactorY;\nuniform float scaleFactorZ;\nattribute mat3 orientation;\nuniform mat3 uorientation;\nuniform float size;\nuniform float pickState[ 1 ];\nuniform float startCell;\nvarying vec3 vPickColor;\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\tif ( pickState[ 0 ] > 0.5 ) {\n\t\tfloat cellNum = startCell + cellCount;\n\t\t\n\t\tfloat red = fract( cellNum / (255.0*255.0*255.0) );\n\t\tif ( pickState[ 0 ] > 1.5 ) {\n\t\n\t\t\tfloat red2 = fract( cellNum / (255.0*255.0*255.0*255.0*255.0*255.0) );\n\t\t\tfloat green2 = fract( cellNum / (255.0*255.0*255.0*255.0*255.0) );\n\t\t\tfloat blue2 = fract( cellNum / (255.0*255.0*255.0*255.0) );\n\t\n\t\t\tred2 -= green2 / 255.0;\n\t\t\tgreen2 -= blue2 / 255.0;\n\t\t\tblue2 -= red / 255.0;\n\t\t\tvPickColor = vec3( red2, green2, blue2 );\n\t\t} else {\n\t\t\tfloat green = fract( cellNum / (255.0*255.0) );\n\t\t\tfloat blue = fract( cellNum / 255.0 );\n\t\t\tred -= green / 255.0;\n\t\t\tgreen -= blue / 255.0;\n\t\t\tvPickColor = vec3( red, green, blue );\n\t\t}\n\t}\n\t#include <color_vertex>\n\t#include <begin_vertex>\n#ifdef GLYPH\n#ifdef USE_SCALE\n\ttransformed *= scale;\n#else\n\ttransformed *= uscale;\n#endif\n\tvec3 scaleFactor = vec3( scaleFactorX, scaleFactorY, scaleFactorZ );\n\ttransformed *= scaleFactor;\n#ifdef USE_ORIENTATION\n\ttransformed = orientation * transformed;\n#else\n\ttransformed = uorientation * transformed;\n#endif\n\ttransformed += offset;\n#endif\n\t#include <project_vertex>\n#ifdef USE_SIZE\n\tgl_PointSize = vsize;\n#else\n\tgl_PointSize = size;\n#endif\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <fog_vertex>\n}",Ke="uniform vec3 diffuse;\nuniform float opacity;\nuniform float opacityFactor;\nuniform float pickState[ 1 ];\nvarying vec3 vPickColor;\n#include <common>\n#include <color_pars_fragment>\n#include <map_particle_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tif ( pickState[ 0 ] > 0.5 ) {\n\t\tgl_FragColor = vec4( vPickColor, 1.0 );\n\t} else {\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity * opacityFactor );\n\t#include <logdepthbuf_fragment>\n\t#include <map_particle_fragment>\n\t#include <color_fragment>\n\t#include <alphatest_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\t#include <output_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t}\n}",Qe="attribute vec3 otherPosition;\nattribute float pattern;\nattribute float cellCount;\nattribute vec3 offset;\nattribute vec3 scale;\nuniform vec3 uscale;\nuniform float scaleFactorX;\nuniform float scaleFactorY;\nuniform float scaleFactorZ;\nattribute mat3 orientation;\nuniform mat3 uorientation;\nuniform float pickState[ 1 ];\nuniform float startCell;\nuniform vec2 resolution;\n#ifdef USE_PATTERN\nvarying float vPattern;\n#endif\nvarying float vDistance;\nvarying vec3 vPickColor;\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\tif ( pickState[ 0 ] > 0.5 ) {\n\t\tfloat cellNum = startCell + cellCount;\n\t\t\n\t\tfloat red = fract( cellNum / (255.0*255.0*255.0) );\n\t\tif ( pickState[ 0 ] > 1.5 ) {\n\t\n\t\t\tfloat red2 = fract( cellNum / (255.0*255.0*255.0*255.0*255.0*255.0) );\n\t\t\tfloat green2 = fract( cellNum / (255.0*255.0*255.0*255.0*255.0) );\n\t\t\tfloat blue2 = fract( cellNum / (255.0*255.0*255.0*255.0) );\n\t\n\t\t\tred2 -= green2 / 255.0;\n\t\t\tgreen2 -= blue2 / 255.0;\n\t\t\tblue2 -= red / 255.0;\n\t\t\tvPickColor = vec3( red2, green2, blue2 );\n\t\t} else {\n\t\t\tfloat green = fract( cellNum / (255.0*255.0) );\n\t\t\tfloat blue = fract( cellNum / 255.0 );\n\t\t\tred -= green / 255.0;\n\t\t\tgreen -= blue / 255.0;\n\t\t\tvPickColor = vec3( red, green, blue );\n\t\t}\n\t}\n\t#include <color_vertex>\n\tvec3 transformed = vec3( position );\n\tvec3 otherTransformed = vec3( otherPosition );\n#ifdef GLYPH\n#ifdef USE_SCALE\n\ttransformed *= scale;\n\totherTransformed *= scale;\n#else\n\ttransformed *= uscale;\n\totherTransformed *= uscale;\n#endif\n\tvec3 scaleFactor = vec3( scaleFactorX, scaleFactorY, scaleFactorZ );\n\ttransformed *= scaleFactor;\n\totherTransformed *= scaleFactor;\n#ifdef USE_ORIENTATION\n\ttransformed = orientation * transformed;\n\totherTransformed = orientation * otherTransformed;\n#else\n\ttransformed = uorientation * transformed;\n\totherTransformed = uorientation * otherTransformed;\n#endif\n\ttransformed += offset;\n\totherTransformed += offset;\n#endif\n\tvec4 mvPosition = modelViewMatrix * vec4( transformed, 1.0 );\n\tgl_Position = projectionMatrix * mvPosition;\n\tvec2 ndcPos1 = gl_Position.xy / gl_Position.w;\n\tvec4 other_Position = projectionMatrix * modelViewMatrix * vec4( otherTransformed, 1.0 );\n\tvec2 ndcPos2 = other_Position.xy / other_Position.w;\n\tfloat aspect = resolution.x / resolution.y;\n\tvec2 dir = ndcPos2 - ndcPos1;\n\tdir.x *= aspect;\n\tbool end = false;\n\tif ( dir.y < -EPSILON ) {\n\t\tend = true;\n\t}\n\telse if ( dir.y > EPSILON ) {\n\t\tend = false;\n\t}\n\telse if ( dir.x < -EPSILON ) {\n\t\tend = true;\n\t}\n\tvDistance = end ? 0.0 : length( dir * resolution ) / 2.0;\n#ifdef USE_PATTERN\n\tvPattern = pattern + 0.5;\n#endif\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}",$e=qe,et="attribute vec3 instanceStart;\nattribute vec3 instanceEnd;\nattribute vec3 instanceColorStart;\nattribute vec3 instanceColorEnd;\nattribute float instancePattern;\nattribute float instanceLinewidthStart;\nattribute float instanceLinewidthEnd;\nattribute float cellCount;\nuniform float pickState[ 1 ];\nuniform float startCell;\nuniform float linewidth;\nuniform vec2 resolution;\n#ifdef USE_PATTERN\nvarying float vPattern;\n#endif\nvarying float vDistance;\nvarying vec3 vPickColor;\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\tif ( pickState[ 0 ] > 0.5 ) {\n\t\tfloat cellNum = startCell + cellCount;\n\t\t\n\t\tfloat red = fract( cellNum / (255.0*255.0*255.0) );\n\t\tif ( pickState[ 0 ] > 1.5 ) {\n\t\n\t\t\tfloat red2 = fract( cellNum / (255.0*255.0*255.0*255.0*255.0*255.0) );\n\t\t\tfloat green2 = fract( cellNum / (255.0*255.0*255.0*255.0*255.0) );\n\t\t\tfloat blue2 = fract( cellNum / (255.0*255.0*255.0*255.0) );\n\t\n\t\t\tred2 -= green2 / 255.0;\n\t\t\tgreen2 -= blue2 / 255.0;\n\t\t\tblue2 -= red / 255.0;\n\t\t\tvPickColor = vec3( red2, green2, blue2 );\n\t\t} else {\n\t\t\tfloat green = fract( cellNum / (255.0*255.0) );\n\t\t\tfloat blue = fract( cellNum / 255.0 );\n\t\t\tred -= green / 255.0;\n\t\t\tgreen -= blue / 255.0;\n\t\t\tvPickColor = vec3( red, green, blue );\n\t\t}\n\t}\n#ifdef USE_COLOR\n\tvColor.xyz = ( position.y < 0.5 ) ? instanceColorStart.xyz : instanceColorEnd.xyz;\n#endif\n#ifdef USE_PATTERN\n\tvPattern = instancePattern + 0.5;\n#endif\n\tfloat widthFactor, avgWidthFactor;\n#ifdef USE_LINEWIDTH\n\twidthFactor = ( position.y < 0.5 ) ? instanceLinewidthStart : instanceLinewidthEnd;\n\tavgWidthFactor = ( instanceLinewidthStart + instanceLinewidthEnd ) / 2.0;\n#else\n\twidthFactor = avgWidthFactor = linewidth;\n#endif\n\tfloat aspect = resolution.x / resolution.y;\n\tvec4 start = vec4( instanceStart, 1.0 );\n\tvec4 end = vec4( instanceEnd, 1.0 );\n#ifdef LINEWIDTH_SCALE\n\tvec2 xyStart = start.xy;\n\tvec2 xyEnd = end.xy;\n\tvec2 scaleDir = xyEnd - xyStart;\n\tscaleDir = normalize( scaleDir );\n\tvec2 scaleOffset = vec2( scaleDir.y, -scaleDir.x );\n\tscaleOffset.y /= aspect;\n\tif ( position.x < 0.5 ) scaleOffset *= -1.0;\n\tscaleOffset *= ( widthFactor * 0.5 );\n\tvec4 startEnd = ( position.y < 0.5 ) ? start : end;\n\tvec4 scaleClip = vec4( startEnd );\n\tscaleClip.xy += scaleOffset;\n\tvec4 scalePosition = projectionMatrix * modelViewMatrix * scaleClip;\n\tvec4 scalePosition2 = projectionMatrix * modelViewMatrix * startEnd;\n\twidthFactor = length( scalePosition2.xy - scalePosition.xy ) * resolution.y * 2.0;\n#endif\n\tif ( widthFactor < 1.0 ) {\n\t\twidthFactor = 1.0;\n\t}\n\tif ( avgWidthFactor < 1.0 ) {\n\t\tavgWidthFactor = 1.0;\n\t}\n\tvec4 mvStart = modelViewMatrix * start;\n\tvec4 mvEnd = modelViewMatrix * end;\n\tvec4 clipStart = projectionMatrix * mvStart;\n\tvec4 clipEnd = projectionMatrix * mvEnd;\n\tvec2 ndcStart = clipStart.xy / clipStart.w;\n\tvec2 ndcEnd = clipEnd.xy / clipEnd.w;\n\tvec2 dir = ndcEnd - ndcStart;\n\tvec2 dirOrig = dir;\n\tdir.x *= aspect;\n\tdir = normalize( dir );\n\tvec2 offset = vec2( dir.y, -dir.x );\n\tdir.x /= aspect;\n\toffset.x /= aspect;\n\tif ( position.x < 0.5 ) offset *= -1.0;\n\toffset += ( position.y < 0.5 ) ? -dir * 0.3 : dir * 0.3;\n\toffset *= widthFactor;\n\tdir *= widthFactor;\n\toffset /= resolution.y;\n\tdir /= resolution.y;\n\tvec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;\n\toffset *= clip.w;\n\tclip.xy += offset;\n\tif ( clip.z > -1.0 ) {\n\t\tclip.z -= 5.0e-4;\n\t\tif ( clip.z < -1.0 ) clip.z = -1.0;\n\t}\n\tgl_Position = clip;\n\tvDistance = ( position.y < 0.5 ) ? 0.0 : ( length( dirOrig * resolution ) + 2.0 * length( dir * resolution ) ) / avgWidthFactor / 2.0;\n\tvec4 mvPosition = ( position.y < 0.5 ) ? mvStart : mvEnd;\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}",tt=qe,it="attribute float cellCount;\nattribute vec3 offset;\nattribute vec3 scale;\nuniform vec3 uscale;\nuniform float scaleFactorX;\nuniform float scaleFactorY;\nuniform float scaleFactorZ;\nattribute mat3 orientation;\nuniform mat3 uorientation;\nuniform float pickState[ 1 ];\nuniform float startCell;\nvarying vec3 vPickColor;\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\tif ( pickState[ 0 ] > 0.5 ) {\n\t\tfloat cellNum = startCell + cellCount;\n\t\t\n\t\tfloat red = fract( cellNum / (255.0*255.0*255.0) );\n\t\tif ( pickState[ 0 ] > 1.5 ) {\n\t\n\t\t\tfloat red2 = fract( cellNum / (255.0*255.0*255.0*255.0*255.0*255.0) );\n\t\t\tfloat green2 = fract( cellNum / (255.0*255.0*255.0*255.0*255.0) );\n\t\t\tfloat blue2 = fract( cellNum / (255.0*255.0*255.0*255.0) );\n\t\n\t\t\tred2 -= green2 / 255.0;\n\t\t\tgreen2 -= blue2 / 255.0;\n\t\t\tblue2 -= red / 255.0;\n\t\t\tvPickColor = vec3( red2, green2, blue2 );\n\t\t} else {\n\t\t\tfloat green = fract( cellNum / (255.0*255.0) );\n\t\t\tfloat blue = fract( cellNum / 255.0 );\n\t\t\tred -= green / 255.0;\n\t\t\tgreen -= blue / 255.0;\n\t\t\tvPickColor = vec3( red, green, blue );\n\t\t}\n\t}\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#if defined ( USE_ENVMAP ) || defined ( USE_SKINNING )\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinbase_vertex>\n\t\t#include <skinnormal_vertex>\n\t\t#include <defaultnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n#ifdef GLYPH\n#ifdef USE_SCALE\n\ttransformed *= scale;\n#else\n\ttransformed *= uscale;\n#endif\n\tvec3 scaleFactor = vec3( scaleFactorX, scaleFactorY, scaleFactorZ );\n\ttransformed *= scaleFactor;\n#ifdef USE_ORIENTATION\n\ttransformed = orientation * transformed;\n#else\n\ttransformed = uorientation * transformed;\n#endif\n\ttransformed += offset;\n#endif\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <fog_vertex>\n}",nt="uniform float stipple;\nuniform vec3 stippleColor;\nuniform vec4 stipplePattern[ 16 ];\nuniform vec3 diffuse;\nuniform float opacity;\nuniform float opacityFactor;\nuniform float pickState[ 1 ];\nvarying vec3 vPickColor;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <cube_uv_reflection_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tif ( pickState[ 0 ] > 0.5 ) {\n\t\tgl_FragColor = vec4( vPickColor, 1.0 );\n\t} else {\n\tvec4 diffuseColor = vec4( diffuse, opacity * opacityFactor );\n\tif ( stipple > 0.5 ) {\n\t\tvec2 coord = floor( mod( gl_FragCoord.xy, 32.0 ) );\n\t\tint index = int( floor( coord.x / 64.0 ) + ( coord.y / 2.0 ) );\n\t\tint comp = int( floor( coord.x / 16.0 ) + mod( coord.y , 2.0 ) * 2.0 );\n\t\tfor ( int i = 0; i < 16; i ++ ) {\n\t\t\tif ( i == index ) {\n\t\t\t\tfloat shift = pow( 2.0, floor( mod( gl_FragCoord.x, 16.0 ) ) );\n\t\t\t\tfloat shortPattern;\n\t\t\t\tif ( comp == 0 ) {\n\t\t\t\t\tshortPattern = stipplePattern[ i ].x;\n\t\t\t\t} else if ( comp == 1 ) {\n\t\t\t\t\tshortPattern = stipplePattern[ i ].y;\n\t\t\t\t} else if ( comp == 2 ) {\n\t\t\t\t\tshortPattern = stipplePattern[ i ].z;\n\t\t\t\t} else {\n\t\t\t\t\tshortPattern = stipplePattern[ i ].w;\n\t\t\t\t}\n\t\t\t\tif ( mod( floor( shortPattern / shift ), 2.0 ) > 0.5 ) {\n\t\t\t\t\tdiffuseColor = vec4( stippleColor, opacity );\n\t\t\t\t} else if ( stipple < 1.5 ) {\n\t\t\t\t\tdiscard;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphatest_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\t#ifdef USE_LIGHTMAP\n\t\tvec4 lightMapTexel= texture2D( lightMap, vUv2 );\n\t\treflectedLight.indirectDiffuse += lightMapTexel.rgb * lightMapIntensity;\n\t#else\n\t\treflectedLight.indirectDiffuse += vec3( 1.0 );\n\t#endif\n\treflectedLight.indirectDiffuse *= diffuseColor.rgb;\n\tvec3 outgoingLight = reflectedLight.indirectDiffuse;\n\t#include <output_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n\t}\n}",at="attribute float cellCount;\nattribute vec3 offset;\nattribute vec3 scale;\nuniform vec3 uscale;\nuniform float scaleFactorX;\nuniform float scaleFactorY;\nuniform float scaleFactorZ;\nattribute mat3 orientation;\nuniform mat3 uorientation;\nuniform float pickState[ 1 ];\nuniform float startCell;\nvarying vec3 vPickColor;\n#define PHONG\nvarying vec3 vViewPosition;\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\tif ( pickState[ 0 ] > 0.5 ) {\n\t\tfloat cellNum = startCell + cellCount;\n\t\t\n\t\tfloat red = fract( cellNum / (255.0*255.0*255.0) );\n\t\tif ( pickState[ 0 ] > 1.5 ) {\n\t\n\t\t\tfloat red2 = fract( cellNum / (255.0*255.0*255.0*255.0*255.0*255.0) );\n\t\t\tfloat green2 = fract( cellNum / (255.0*255.0*255.0*255.0*255.0) );\n\t\t\tfloat blue2 = fract( cellNum / (255.0*255.0*255.0*255.0) );\n\t\n\t\t\tred2 -= green2 / 255.0;\n\t\t\tgreen2 -= blue2 / 255.0;\n\t\t\tblue2 -= red / 255.0;\n\t\t\tvPickColor = vec3( red2, green2, blue2 );\n\t\t} else {\n\t\t\tfloat green = fract( cellNum / (255.0*255.0) );\n\t\t\tfloat blue = fract( cellNum / 255.0 );\n\t\t\tred -= green / 255.0;\n\t\t\tgreen -= blue / 255.0;\n\t\t\tvPickColor = vec3( red, green, blue );\n\t\t}\n\t}\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n#ifdef GLYPH\n#ifdef USE_SCALE\n\ttransformed *= scale;\n#else\n\ttransformed *= uscale;\n#endif\n\tvec3 scaleFactor = vec3( scaleFactorX, scaleFactorY, scaleFactorZ );\n\ttransformed *= scaleFactor;\n#ifdef USE_ORIENTATION\n\ttransformed = orientation * transformed;\n#else\n\ttransformed = uorientation * transformed;\n#endif\n\ttransformed += offset;\n#endif\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",rt="uniform float ambientIntensity;\nuniform float diffuseIntensity;\nuniform float stipple;\nuniform vec3 stippleColor;\nuniform vec4 stipplePattern[ 16 ];\nuniform float pickState[ 1 ];\nvarying vec3 vPickColor;\n#define PHONG\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform vec3 specular;\nuniform float shininess;\nuniform float opacity;\nuniform float opacityFactor;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <cube_uv_reflection_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_phong_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tif ( pickState[ 0 ] > 0.5 ) {\n\t\tgl_FragColor = vec4( vPickColor, 1.0 );\n\t} else {\n\tvec4 diffuseColor = vec4( diffuse, opacity * opacityFactor );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\tif ( stipple > 0.5 ) {\n\t\tvec2 coord = floor( mod( gl_FragCoord.xy, 32.0 ) );\n\t\tint index = int( floor( coord.x / 64.0 ) + ( coord.y / 2.0 ) );\n\t\tint comp = int( floor( coord.x / 16.0 ) + mod( coord.y , 2.0 ) * 2.0 );\n\t\tfor ( int i = 0; i < 16; i ++ ) {\n\t\t\tif ( i == index ) {\n\t\t\t\tfloat shift = pow( 2.0, floor( mod( gl_FragCoord.x, 16.0 ) ) );\n\t\t\t\tfloat shortPattern;\n\t\t\t\tif ( comp == 0 ) {\n\t\t\t\t\tshortPattern = stipplePattern[ i ].x;\n\t\t\t\t} else if ( comp == 1 ) {\n\t\t\t\t\tshortPattern = stipplePattern[ i ].y;\n\t\t\t\t} else if ( comp == 2 ) {\n\t\t\t\t\tshortPattern = stipplePattern[ i ].z;\n\t\t\t\t} else {\n\t\t\t\t\tshortPattern = stipplePattern[ i ].w;\n\t\t\t\t}\n\t\t\t\tif ( mod( floor( shortPattern / shift ), 2.0 ) > 0.5 ) {\n\t\t\t\t\tdiffuseColor = vec4( stippleColor, opacity );\n\t\t\t\t} else if ( stipple < 1.5 ) {\n\t\t\t\t\tdiscard;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <lights_phong_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\tvec3 outgoingLight = ( reflectedLight.directDiffuse * diffuseIntensity ) + ( reflectedLight.indirectDiffuse * ambientIntensity ) + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\n\t#include <output_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n\t}\n}",st={points:{uniforms:m.merge([v.points,v.fog,Ve.base]),vertexShader:Je,fragmentShader:Ke},line:{uniforms:m.merge([v.common,v.fog,Ve.base,Ve.line]),vertexShader:Qe,fragmentShader:$e},thick:{uniforms:m.merge([v.common,v.fog,Ve.base,Ve.line,{linewidth:{value:1}}]),vertexShader:et,fragmentShader:tt},basic:{uniforms:m.merge([v.common,v.fog,Ve.base,Ve.mesh]),vertexShader:it,fragmentShader:nt},phong:{uniforms:m.merge([v.common,v.fog,v.lights,Ve.base,Ve.mesh,{ambientIntensity:{value:.31},diffuseIntensity:{value:.7},emissive:{value:new f(0)},specular:{value:new f(2039583)},shininess:{value:63.8386159788056}}]),vertexShader:at,fragmentShader:rt}};class ot extends g{constructor(e){super(),Object.defineProperties(this,{pickState:{get:function(){return this.uniforms.pickState.value},set:function(e){this.uniforms.pickState.value=e}},startCell:{get:function(){return this.uniforms.startCell.value},set:function(e){this.uniforms.startCell.value=e}},glyphs:{get:function(){return this.defines.GLYPH},set:function(e){this.defines.GLYPH=e}},scale:{get:function(){return this.uniforms.uscale.value},set:function(e){this.uniforms.uscale.value=e}},scaleFactorX:{get:function(){return this.uniforms.scaleFactorX.value},set:function(e){this.uniforms.scaleFactorX.value=e}},scaleFactorY:{get:function(){return this.uniforms.scaleFactorY.value},set:function(e){this.uniforms.scaleFactorY.value=e}},scaleFactorZ:{get:function(){return this.uniforms.scaleFactorZ.value},set:function(e){this.uniforms.scaleFactorZ.value=e}},vertexScales:{get:function(){return this.defines.USE_SCALE},set:function(e){this.defines.USE_SCALE=e}},orientation:{get:function(){return this.uniforms.uorientation.value},set:function(e){this.uniforms.uorientation.value=e}},vertexOrientations:{get:function(){return this.defines.USE_ORIENTATION},set:function(e){this.defines.USE_ORIENTATION=e}},opacityFactor:{get:function(){return this.uniforms.opacityFactor.value},set:function(e){this.uniforms.opacityFactor.value=e}}}),this.color=new f(16777215),this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this}toJSON(e){const t=super.toJSON(e);return this.depthFunc===y&&(t.depthFunc=void 0),!0===this.depthTest&&(t.depthTest=void 0),!0===this.depthWrite&&(t.depthWrite=void 0),!1===this.stencilWrite&&(t.stencilWrite=void 0),255===this.stencilWriteMask&&(t.stencilWriteMask=void 0),this.stencilFunc===b&&(t.stencilFunc=void 0),0===this.stencilRef&&(t.stencilRef=void 0),255===this.stencilFuncMask&&(t.stencilFuncMask=void 0),this.stencilFail===w&&(t.stencilFail=void 0),this.stencilZFail===w&&(t.stencilZFail=void 0),this.stencilZPass===w&&(t.stencilZPass=void 0),this.vertexScales&&(t.vertexScales=!0),this.vertexOrientations&&(t.vertexOrientations=!0),t.uniforms=void 0,t.fragmentShader=void 0,t.vertexShader=void 0,t}equals(e){return e.color.getHex()===this.color.getHex()&&(e.opacity===this.opacity&&(e.transparent===this.transparent&&(e.side===this.side&&e.vertexColors===this.vertexColors)))}}class lt extends ot{constructor(e){super({uniforms:m.clone(st.points.uniforms),vertexShader:st.points.vertexShader,fragmentShader:st.points.fragmentShader}),Object.defineProperties(this,{vertexSizes:{get:function(){return this.defines.USE_SIZE},set:function(e){this.defines.USE_SIZE=e}}}),this.map=null,this.size=1,this.setValues(e)}copy(e){return super.copy(e),this.map=e.map,this.size=e.size,this}toJSON(e){const t=super.toJSON(e);return t.type="PointsMaterial",this.vertexSizes&&(t.vertexSizes=!0),t}equals(e){return!1!==super.equals(e)&&!!e.isPointsMaterial}}lt.prototype.isPointsMaterial=!0;class ct extends ot{constructor(e){super({uniforms:m.clone(st.basic.uniforms),vertexShader:st.basic.vertexShader,fragmentShader:st.basic.fragmentShader}),Object.defineProperties(this,{stipple:{get:function(){return this.uniforms.stipple.value},set:function(e){this.uniforms.stipple.value=e}},stippleColor:{get:function(){return this.uniforms.stippleColor.value},set:function(e){this.uniforms.stippleColor.value=e}},stipplePattern:{get:function(){return this.uniforms.stipplePattern.value},set:function(e){this.uniforms.stipplePattern.value=e}}}),this.map=null,this.setValues(e)}copy(e){return super.copy(e),this.map=e.map,this}toJSON(e){const t=super.toJSON(e);return t.type="MeshBasicMaterial",0!==this.stipple&&(t.stipple=this.stipple),0!==this.stippleColor.getHex()&&(t.stippleColor=this.stippleColor.getHex()),JSON.stringify(this.stipplePattern)!==JSON.stringify(new Float32Array(64))&&(t.stipplePattern=Array.prototype.slice.call(this.stipplePattern)),t}equals(e){return!1!==super.equals(e)&&!(!e.isMeshBasicMaterial&&!e.isMeshPhongMaterial)}}ct.prototype.isMeshBasicMaterial=!0;class dt extends ct{constructor(e){super({uniforms:m.clone(st.phong.uniforms),vertexShader:st.phong.vertexShader,fragmentShader:st.phong.fragmentShader}),Object.defineProperties(this,{ambientIntensity:{get:function(){return this.uniforms.ambientIntensity.value},set:function(e){this.uniforms.ambientIntensity.value=e}},diffuseIntensity:{get:function(){return this.uniforms.diffuseIntensity.value},set:function(e){this.uniforms.diffuseIntensity.value=e}}}),this.specular=new f(2039583),this.shininess=63.8386159788056,this.emissive=new f(0),this.emissiveIntensity=1,this.lights=!0,this.setValues(e)}copy(e){return super.copy(e),this.specular.copy(e.specular),this.shininess=e.shininess,this.flatShading=e.flatShading,this}toJSON(e){const t=super.toJSON(e);return t.type="MeshPhongMaterial",.31!==this.ambientIntensity&&(t.ambientIntensity=this.ambientIntensity),.7!==this.diffuseIntensity&&(t.diffuseIntensity=this.diffuseIntensity),2039583===this.specular.getHex()&&(t.specular=void 0),63.8386159788056===this.shininess&&(t.shininess=void 0),t}equals(e){return!1!==super.equals(e)&&(!!e.isMeshPhongMaterial&&(e.ambientIntensity===this.ambientIntensity&&(e.diffuseIntensity===this.diffuseIntensity&&(e.specular.getHex()===this.specular.getHex()&&e.shininess===this.shininess))))}}dt.prototype.isMeshPhongMaterial=!0,dt.prototype.isMeshBasicMaterial=!1;class ht extends ot{constructor(e){super({uniforms:m.clone(st.line.uniforms),vertexShader:st.line.vertexShader,fragmentShader:st.line.fragmentShader}),Object.defineProperties(this,{pattern:{get:function(){return this.uniforms.linePattern.value},set:function(e){this.uniforms.linePattern.value=e}},vertexPatterns:{get:function(){return this.defines.USE_PATTERN},set:function(e){this.defines.USE_PATTERN=e}},resolution:{get:function(){return this.uniforms.resolution.value},set:function(e){this.uniforms.resolution.value=e}}}),this.setValues(e)}toJSON(e){const t=super.toJSON(e);return t.type="LineMaterial",65535!==this.pattern&&(t.pattern=this.pattern),this.vertexPatterns&&(t.vertexPatterns=!0),t}equals(e){return!1!==super.equals(e)&&!!e.isLineBasicMaterial}}ht.prototype.isLineBasicMaterial=!0;class pt extends ht{constructor(e){super({uniforms:m.clone(st.thick.uniforms),vertexShader:st.thick.vertexShader,fragmentShader:st.thick.fragmentShader}),Object.defineProperties(this,{linewidth:{get:function(){return this.uniforms.linewidth.value},set:function(e){this.uniforms.linewidth.value=e}},vertexLinewidths:{get:function(){return this.defines.USE_LINEWIDTH},set:function(e){this.defines.USE_LINEWIDTH=e}},linewidthScale:{get:function(){return this.defines.LINEWIDTH_SCALE},set:function(e){this.defines.LINEWIDTH_SCALE=e}}}),this.setValues(e)}toJSON(e){const t=super.toJSON(e);return t.type="ThickLineMaterial",this.vertexLinewidths&&(t.vertexLinewidths=!0),this.linewidthScale&&(t.linewidthScale=!0),t}equals(e){return!1!==super.equals(e)&&(!!e.isThickLineMaterial&&e.vertexLinewidths===this.vertexLinewidths)}}pt.prototype.isThickLineMaterial=!0;var ut=Object.freeze({__proto__:null,PointsMaterial:lt,MeshPhongMaterial:dt,MeshBasicMaterial:ct,LineMaterial:ht,ThickLineMaterial:pt});class ft extends x{constructor(e){super(e),this.textures={}}load(e,t,i,n){const a=this,r=new S(a.manager);r.setPath(a.path),r.setRequestHeader(a.requestHeader),r.setWithCredentials(a.withCredentials),r.load(e,(function(i){try{t(a.parse(JSON.parse(i)))}catch(t){n?n(t):console.error(t),a.manager.itemError(e)}}),i,n)}parse(t){const n=this.textures;function a(e){return void 0===n[e]&&console.warn("AVS.Three.MaterialLoader: Undefined texture",e),n[e]}const r=new ut[t.type];if(void 0!==t.uuid&&(r.uuid=t.uuid),void 0!==t.name&&(r.name=t.name),void 0!==t.color&&void 0!==r.color&&r.color.setHex(t.color),void 0!==t.roughness&&(r.roughness=t.roughness),void 0!==t.metalness&&(r.metalness=t.metalness),void 0!==t.sheen&&(r.sheen=t.sheen),void 0!==t.sheenColor&&(r.sheenColor=(new f).setHex(t.sheenColor)),void 0!==t.sheenRoughness&&(r.sheenRoughness=t.sheenRoughness),void 0!==t.emissive&&void 0!==r.emissive&&r.emissive.setHex(t.emissive),void 0!==t.specular&&void 0!==r.specular&&r.specular.setHex(t.specular),void 0!==t.specularIntensity&&(r.specularIntensity=t.specularIntensity),void 0!==t.specularColor&&void 0!==r.specularColor&&r.specularColor.setHex(t.specularColor),void 0!==t.shininess&&(r.shininess=t.shininess),void 0!==t.clearcoat&&(r.clearcoat=t.clearcoat),void 0!==t.clearcoatRoughness&&(r.clearcoatRoughness=t.clearcoatRoughness),void 0!==t.transmission&&(r.transmission=t.transmission),void 0!==t.thickness&&(r.thickness=t.thickness),void 0!==t.attenuationDistance&&(r.attenuationDistance=t.attenuationDistance),void 0!==t.attenuationColor&&void 0!==r.attenuationColor&&r.attenuationColor.setHex(t.attenuationColor),void 0!==t.fog&&(r.fog=t.fog),void 0!==t.flatShading&&(r.flatShading=t.flatShading),void 0!==t.blending&&(r.blending=t.blending),void 0!==t.combine&&(r.combine=t.combine),void 0!==t.side&&(r.side=t.side),void 0!==t.shadowSide&&(r.shadowSide=t.shadowSide),void 0!==t.opacity&&(r.opacity=t.opacity),void 0!==t.transparent&&(r.transparent=t.transparent),void 0!==t.alphaTest&&(r.alphaTest=t.alphaTest),void 0!==t.depthTest&&(r.depthTest=t.depthTest),void 0!==t.depthWrite&&(r.depthWrite=t.depthWrite),void 0!==t.colorWrite&&(r.colorWrite=t.colorWrite),void 0!==t.stencilWrite&&(r.stencilWrite=t.stencilWrite),void 0!==t.stencilWriteMask&&(r.stencilWriteMask=t.stencilWriteMask),void 0!==t.stencilFunc&&(r.stencilFunc=t.stencilFunc),void 0!==t.stencilRef&&(r.stencilRef=t.stencilRef),void 0!==t.stencilFuncMask&&(r.stencilFuncMask=t.stencilFuncMask),void 0!==t.stencilFail&&(r.stencilFail=t.stencilFail),void 0!==t.stencilZFail&&(r.stencilZFail=t.stencilZFail),void 0!==t.stencilZPass&&(r.stencilZPass=t.stencilZPass),void 0!==t.wireframe&&(r.wireframe=t.wireframe),void 0!==t.wireframeLinewidth&&(r.wireframeLinewidth=t.wireframeLinewidth),void 0!==t.wireframeLinecap&&(r.wireframeLinecap=t.wireframeLinecap),void 0!==t.wireframeLinejoin&&(r.wireframeLinejoin=t.wireframeLinejoin),void 0!==t.rotation&&(r.rotation=t.rotation),1!==t.linewidth&&(r.linewidth=t.linewidth),void 0!==t.polygonOffset&&(r.polygonOffset=t.polygonOffset),void 0!==t.polygonOffsetFactor&&(r.polygonOffsetFactor=t.polygonOffsetFactor),void 0!==t.polygonOffsetUnits&&(r.polygonOffsetUnits=t.polygonOffsetUnits),void 0!==t.dithering&&(r.dithering=t.dithering),void 0!==t.alphaToCoverage&&(r.alphaToCoverage=t.alphaToCoverage),void 0!==t.premultipliedAlpha&&(r.premultipliedAlpha=t.premultipliedAlpha),void 0!==t.visible&&(r.visible=t.visible),void 0!==t.toneMapped&&(r.toneMapped=t.toneMapped),void 0!==t.userData&&(r.userData=t.userData),void 0!==t.vertexColors&&("number"==typeof t.vertexColors?r.vertexColors=t.vertexColors>0:r.vertexColors=t.vertexColors),void 0!==t.uniforms)for(const n in t.uniforms){const s=t.uniforms[n];switch(r.uniforms[n]={},s.type){case"t":r.uniforms[n].value=a(s.value);break;case"c":r.uniforms[n].value=(new f).setHex(s.value);break;case"v2":r.uniforms[n].value=(new u).fromArray(s.value);break;case"v3":r.uniforms[n].value=(new e).fromArray(s.value);break;case"v4":r.uniforms[n].value=(new O).fromArray(s.value);break;case"m3":r.uniforms[n].value=(new p).fromArray(s.value);break;case"m4":r.uniforms[n].value=(new i).fromArray(s.value);break;default:r.uniforms[n].value=s.value}}if(void 0!==t.defines&&(r.defines=t.defines),void 0!==t.vertexShader&&(r.vertexShader=t.vertexShader),void 0!==t.fragmentShader&&(r.fragmentShader=t.fragmentShader),void 0!==t.extensions)for(const e in t.extensions)r.extensions[e]=t.extensions[e];if(void 0!==t.shading&&(r.flatShading=1===t.shading),void 0!==t.glyphs&&(r.glyphs=t.glyphs),void 0!==t.vertexScales&&(r.vertexScales=t.vertexScales),void 0!==t.scale&&r.scale.fromArray(t.scale),void 0!==t.vertexOrientations&&(r.vertexOrientations=t.vertexOrientations),void 0!==t.orientation&&r.orientation.fromArray(t.orientation),void 0!==t.size&&(r.size=t.size),void 0!==t.sizeAttenuation&&(r.sizeAttenuation=t.sizeAttenuation),void 0!==t.vertexSizes&&(r.vertexSizes=t.vertexSizes),void 0!==t.pattern&&(r.pattern=t.pattern),void 0!==t.vertexPatterns&&(r.vertexPatterns=t.vertexPatterns),void 0!==t.vertexLinewidths&&(r.vertexLinewidths=t.vertexLinewidths),void 0!==t.linewidthScale&&(r.linewidthScale=t.linewidthScale),void 0!==t.stipple&&(r.stipple=t.stipple),void 0!==t.stippleColor&&void 0!==r.stippleColor&&r.stippleColor.setHex(t.stippleColor),void 0!==t.stipplePattern&&(r.stipplePattern=t.stipplePattern),void 0!==t.ambientIntensity&&(r.ambientIntensity=t.ambientIntensity),void 0!==t.diffuseIntensity&&(r.diffuseIntensity=t.diffuseIntensity),void 0!==t.map&&(r.map=a(t.map)),void 0!==t.matcap&&(r.matcap=a(t.matcap)),void 0!==t.alphaMap&&(r.alphaMap=a(t.alphaMap)),void 0!==t.bumpMap&&(r.bumpMap=a(t.bumpMap)),void 0!==t.bumpScale&&(r.bumpScale=t.bumpScale),void 0!==t.normalMap&&(r.normalMap=a(t.normalMap)),void 0!==t.normalMapType&&(r.normalMapType=t.normalMapType),void 0!==t.normalScale){let e=t.normalScale;!1===Array.isArray(e)&&(e=[e,e]),r.normalScale=(new u).fromArray(e)}if(void 0!==t.displacementMap&&(r.displacementMap=a(t.displacementMap)),void 0!==t.displacementScale&&(r.displacementScale=t.displacementScale),void 0!==t.displacementBias&&(r.displacementBias=t.displacementBias),void 0!==t.roughnessMap&&(r.roughnessMap=a(t.roughnessMap)),void 0!==t.metalnessMap&&(r.metalnessMap=a(t.metalnessMap)),void 0!==t.emissiveMap&&(r.emissiveMap=a(t.emissiveMap)),void 0!==t.emissiveIntensity&&(r.emissiveIntensity=t.emissiveIntensity),void 0!==t.specularMap&&(r.specularMap=a(t.specularMap)),void 0!==t.specularIntensityMap&&(r.specularIntensityMap=a(t.specularIntensityMap)),void 0!==t.specularColorMap&&(r.specularColorMap=a(t.specularColorMap)),void 0!==t.envMap&&(r.envMap=a(t.envMap)),void 0!==t.envMapIntensity&&(r.envMapIntensity=t.envMapIntensity),void 0!==t.reflectivity&&(r.reflectivity=t.reflectivity),void 0!==t.refractionRatio&&(r.refractionRatio=t.refractionRatio),void 0!==t.lightMap&&(r.lightMap=a(t.lightMap)),void 0!==t.lightMapIntensity&&(r.lightMapIntensity=t.lightMapIntensity),void 0!==t.aoMap&&(r.aoMap=a(t.aoMap)),void 0!==t.aoMapIntensity&&(r.aoMapIntensity=t.aoMapIntensity),void 0!==t.gradientMap&&(r.gradientMap=a(t.gradientMap)),void 0!==t.clearcoatMap&&(r.clearcoatMap=a(t.clearcoatMap)),void 0!==t.clearcoatRoughnessMap&&(r.clearcoatRoughnessMap=a(t.clearcoatRoughnessMap)),void 0!==t.clearcoatNormalMap&&(r.clearcoatNormalMap=a(t.clearcoatNormalMap)),void 0!==t.clearcoatNormalScale&&(r.clearcoatNormalScale=(new u).fromArray(t.clearcoatNormalScale)),void 0!==t.transmissionMap&&(r.transmissionMap=a(t.transmissionMap)),void 0!==t.thicknessMap&&(r.thicknessMap=a(t.thicknessMap)),void 0!==t.sheenColorMap&&(r.sheenColorMap=a(t.sheenColorMap)),void 0!==t.sheenRoughnessMap&&(r.sheenRoughnessMap=a(t.sheenRoughnessMap)),void 0!==t.clippingPlanes){r.clippingPlanes=[];for(let i=0,n=t.clippingPlanes.length;i<n;i++){const n=t.clippingPlanes[i],a=new k(new e(n.normal[0],n.normal[1],n.normal[2]),n.constant);r.clippingPlanes.push(a)}}return r.origTransparent=r.transparent,r}setTextures(e){return this.textures=e,this}}class mt{constructor(e){this.bufferGeometryLoader=e}parse(e){const t=this.bufferGeometryLoader.parse(e),i=t.attributes.position;if(void 0!==i){const e=new C(i.array.length,3);for(let t=0,n=i.array.length/6;t<n;t++)e.array[6*t+0]=i.array[6*t+3],e.array[6*t+1]=i.array[6*t+4],e.array[6*t+2]=i.array[6*t+5],e.array[6*t+3]=i.array[6*t+0],e.array[6*t+4]=i.array[6*t+1],e.array[6*t+5]=i.array[6*t+2];t.setAttribute("otherPosition",e)}return t}}const vt=new E,gt=new e;class yt extends _{constructor(){super(),this.type="ThickLineSegmentsBufferGeometry";this.setAttribute("position",new C([0,0,0,1,1,0,0,1,0,0,0,0,1,0,0,1,1,0],3))}applyMatrix4(e){const t=this.attributes.instanceStart,i=this.attributes.instanceEnd;return void 0!==t&&(t.applyMatrix4(e),i.applyMatrix4(e),t.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this}setPositions(e){let t;e instanceof Float32Array?t=e:Array.isArray(e)&&(t=new Float32Array(e));const i=new T(t,6,1);return this.setAttribute("instanceStart",new L(i,3,0)),this.setAttribute("instanceEnd",new L(i,3,3)),this.computeBoundingBox(),this.computeBoundingSphere(),this}setColors(e){let t;e instanceof Float32Array?t=e:Array.isArray(e)&&(t=new Float32Array(e));const i=new T(t,6,1);return this.setAttribute("instanceColorStart",new L(i,3,0)),this.setAttribute("instanceColorEnd",new L(i,3,3)),this}setPatterns(e){let t;e instanceof Float32Array?t=e:Array.isArray(e)&&(t=new Float32Array(e));const i=new T(t,2,1);return this.setAttribute("instancePattern",new L(i,1,0)),this}setLinewidths(e){let t;e instanceof Float32Array?t=e:Array.isArray(e)&&(t=new Float32Array(e));const i=new T(t,2,1);return this.setAttribute("instanceLinewidthStart",new L(i,1,0)),this.setAttribute("instanceLinewidthEnd",new L(i,1,1)),this}computeBoundingBox(){null===this.boundingBox&&(this.boundingBox=new E);const e=this.attributes.instanceStart,t=this.attributes.instanceEnd;void 0!==e&&void 0!==t&&(this.boundingBox.setFromBufferAttribute(e),vt.setFromBufferAttribute(t),this.boundingBox.union(vt))}computeBoundingSphere(){null===this.boundingSphere&&(this.boundingSphere=new P),null===this.boundingBox&&this.computeBoundingBox();const e=this.attributes.instanceStart,t=this.attributes.instanceEnd;if(void 0!==e&&void 0!==t){const i=this.boundingSphere.center;this.boundingBox.getCenter(i);let n=0;for(let a=0,r=e.count;a<r;a++)gt.fromBufferAttribute(e,a),n=Math.max(n,i.distanceToSquared(gt)),gt.fromBufferAttribute(t,a),n=Math.max(n,i.distanceToSquared(gt));this.boundingSphere.radius=Math.sqrt(n),isNaN(this.boundingSphere.radius)&&console.error("AVS.Three.ThickLineSegmentsBufferGeometry.computeBoundingSphere(): Computed radius is NaN. The instanced position data is likely to have NaN values.",this)}}applyMatrix(e){return console.warn("AVS.Three.ThickLineSegmentsBufferGeometry: applyMatrix() has been renamed to applyMatrix4()."),this.applyMatrix4(e)}}yt.prototype.isThickLineSegmentsBufferGeometry=!0;class bt{parse(e){const t=new yt,i=e.data.attributes;return void 0!==i.position&&t.setPositions(i.position.array),void 0!==i.color&&t.setColors(i.color.array),void 0!==i.pattern&&t.setPatterns(i.pattern.array),void 0!==i.linewidth&&t.setLinewidths(i.linewidth.array),t}}const wt=new i,xt=new M,St=new P;class Ot extends We{constructor(e,t){super(e,t),this.type="ThickLineSegments"}raycast(t,i){const n=this.geometry,a=this.matrixWorld,r=t.params.Line.threshold;if(null===n.boundingSphere&&n.computeBoundingSphere(),St.copy(n.boundingSphere),St.applyMatrix4(a),St.radius+=r,!1===t.ray.intersectsSphere(sphere))return;wt.copy(a).invert(),xt.copy(t.ray).applyMatrix4(wt);const s=r/((this.scale.x+this.scale.y+this.scale.z)/3),o=s*s,l=new e,c=new e,d=new e,h=new e,p=n.attributes.instanceStart.array;for(let e=0,n=p.length/3-1;e<n;e+=2){l.fromArray(p,3*e),c.fromArray(p,3*e+3);if(ray.distanceSqToSegment(l,c,h,d)>o)continue;h.applyMatrix4(this.matrixWorld);const n=t.ray.origin.distanceTo(h);n<t.near||n>t.far||i.push({distance:n,point:d.clone().applyMatrix4(this.matrixWorld),index:e,face:null,faceIndex:null,object:this})}}}Ot.prototype.isThickLineSegments=!0;class kt{constructor(){this.uuid=A.generateUUID(),this.transparent=!1,this.opacity=1,this.opacityFactor=1}dispose(){}}class Ct extends j{constructor(){super(),this.type="BillboardText",this.text="Label",this.fontSize=16,this.fontStyle="normal",this.fontWeight="normal",this.textDecoration="",this.fontFamily="sans-serif",this.color=new f(0),this.textAlign="",this.transform="",this.transformOrigin="",this.material=new kt,this.div=document.createElement("div"),this.div.style.position="absolute",this.div.style.whiteSpace="nowrap",this.div.style.lineHeight="normal",this.div.style.userSelect="none",this.scene=null,this.scaleFactor=1,this.left=0,this.top=0,this.updateStyle()}addToScene(e){null===this.scene&&(this.scene=e,e.labels.push(this),e.landscapeDiv.appendChild(this.div),this.updateStyle())}updateStyle(){this.div.innerHTML=this.text,this.div.style.fontStyle=this.fontStyle,this.div.style.fontWeight=this.fontWeight,this.div.style.textDecoration=this.textDecoration,this.div.style.color="#"+this.color.getHexString(),this.div.style.textAlign=this.textAlign,this.div.style.transform=this.transform,this.div.style.transformOrigin=this.transformOrigin,this.material.transparent?this.div.style.opacity=this.material.opacity*this.material.opacityFactor:this.div.style.opacity=1,this.div.style.visibility=this.visible?"visible":"hidden",void 0!==this.div.firstChild.style&&(this.div.firstChild.style.float="left"),/\s/.test(this.fontFamily)?this.div.style.fontFamily="'"+this.fontFamily+"'":this.div.style.fontFamily=this.fontFamily,this.textScale||(this.div.style.fontSize=this.fontSize+"px")}updatePosition(){this.updateMatrixWorld();const t=(new e).setFromMatrixPosition(this.matrixWorld);if(t.project(this.scene.camera),this.left=(t.x+1)/2*this.scene.landscapeWidth,this.top=(1-(t.y+1)/2)*this.scene.landscapeHeight,this.moveText(),this.textScale){const t=new e(0,1,0).multiplyScalar(this.fontSize).add(this.position);t.applyMatrix4(this.parent.matrixWorld),t.project(this.scene.camera);const i=(1-(t.y+1)/2)*this.scene.landscapeHeight;this.div.style.fontSize=Math.abs(i-this.top)+"px"}this.material.transparent?this.div.style.opacity=this.material.opacity*this.material.opacityFactor:this.div.style.opacity=1,this.div.style.visibility=this.visible?"visible":"hidden"}moveText(){this.div.style.left=(this.panOffsetX??0)+this.left+"px",this.div.style.top=(this.panOffsetY??0)+this.top+"px"}}Ct.prototype.isBillboardText=!0;class Et extends x{constructor(e){super(e)}load(e,t,i,n){const a=this,r=""===this.path?R.extractUrlBase(e):this.path;this.resourcePath=this.resourcePath||r;const s=new S(this.manager);s.setPath(this.path),s.setRequestHeader(this.requestHeader),s.setWithCredentials(this.withCredentials),s.load(e,(function(i){let r=null;try{r=JSON.parse(i)}catch(t){return void 0!==n&&n(t),void console.error("AVS.Three.ObjectLoader: Can't parse "+e+".",t.message)}const s=r.metadata;void 0!==s&&void 0!==s.type&&"geometry"!==s.type.toLowerCase()?a.parse(r,t):console.error("AVS.Three.ObjectLoader: Can't load "+e)}),i,n)}parse(e,t,i,n,a,r,s){const o=this.parseGeometries(e.geometries);r=Object.assign(r??{},o);const l=this.parseImages(e.images,(function(){void 0!==t&&t(h)}));i=Object.assign(i??{},l);const c=this.parseTextures(e.textures,i);n=Object.assign(n??{},c);const d=this.parseMaterials(e.materials,n);a=Object.assign(a??{},d);const h=this.parseObject(e.object,r,a,n);if(void 0!==s&&(s.add(h),h.saveVisible=h.visible,h.visible=!1),void 0!==t){let e=!1;for(const t in l)if(l[t]instanceof HTMLImageElement){e=!0;break}!1===e&&t(h)}return h}parseGeometries(e,t){const i={};if(void 0!==e){const t=new I,n=new mt(t),a=new bt;for(let r=0,s=e.length;r<s;r++){let s;const o=e[r];switch(o.type){case"BufferGeometry":case"InstancedBufferGeometry":s=t.parse(o);break;case"LinePatternBufferGeometry":s=n.parse(o);break;case"ThickLineBufferGeometry":s=a.parse(o);break;case"Geometry":console.error("AVS.Three.ObjectLoader: The legacy Geometry type is no longer supported.");break;case"SphereGeometry":s=D.fromJSON(o);break;default:console.warn(`AVS.Three.ObjectLoader: Unsupported geometry type "${o.type}"`)}s.uuid=o.uuid,void 0!==o.name&&(s.name=o.name),!0===s.isBufferGeometry&&void 0!==o.userData&&(s.userData=o.userData),i[o.uuid]=s}}return i}parseMaterials(e,t){const i={},n={};if(void 0!==e){const a=new ft;a.setTextures(t);for(let t=0,r=e.length;t<r;t++){const r=e[t];if("MultiMaterial"===r.type){const e=[];for(let t=0;t<r.materials.length;t++){const n=r.materials[t];void 0===i[n.uuid]&&(i[n.uuid]=a.parse(n)),e.push(i[n.uuid])}n[r.uuid]=e}else void 0===i[r.uuid]&&(i[r.uuid]=a.parse(r)),n[r.uuid]=i[r.uuid]}}return n}parseImages(e,t){const i=this,n={};let a;function r(e){if("string"==typeof e){const t=e;return function(e){return i.manager.itemStart(e),a.load(e,(function(){i.manager.itemEnd(e)}),void 0,(function(){i.manager.itemError(e),i.manager.itemEnd(e)}))}(/^(\/\/)|([a-z]+:(\/\/)?)/i.test(t)?t:i.resourcePath+t)}return e.data?{data:getTypedArray(e.type,e.data),width:e.width,height:e.height}:null}if(void 0!==e&&e.length>0){const i=new N(t);a=new F(i),a.setCrossOrigin(this.crossOrigin);for(let t=0,i=e.length;t<i;t++){const i=e[t];i.url;{const e=r(i.url);null!==e&&(n[i.uuid]=e)}}}return n}parseTextures(e,t){function i(e,t){return"number"==typeof e?e:(console.warn("AVS.Three.ObjectLoader.parseTextures: Constant should be in numeric form.",e),t[e])}const n={};if(void 0!==e)for(let a=0,r=e.length;a<r;a++){const r=e[a];let s;void 0===r.image&&console.warn('AVS.Three.ObjectLoader: No "image" specified for',r.uuid),void 0===t[r.image]&&console.warn("AVS.Three.ObjectLoader: Undefined image",r.image);const o=t[r.image];Array.isArray(o)?(s=new z(o),6===o.length&&(s.needsUpdate=!0)):(s=o&&o.data?new DataTexture(o.data,o.width,o.height):new H(o),o&&(s.needsUpdate=!0)),s.uuid=r.uuid,void 0!==r.name&&(s.name=r.name),void 0!==r.mapping&&(s.mapping=i(r.mapping,_t)),void 0!==r.offset&&s.offset.fromArray(r.offset),void 0!==r.repeat&&s.repeat.fromArray(r.repeat),void 0!==r.center&&s.center.fromArray(r.center),void 0!==r.rotation&&(s.rotation=r.rotation),void 0!==r.wrap&&(s.wrapS=i(r.wrap[0],Tt),s.wrapT=i(r.wrap[1],Tt)),void 0!==r.format&&(s.format=r.format),void 0!==r.type&&(s.type=r.type),void 0!==r.encoding&&(s.encoding=r.encoding),void 0!==r.minFilter&&(s.minFilter=i(r.minFilter,Lt)),void 0!==r.magFilter&&(s.magFilter=i(r.magFilter,Lt)),void 0!==r.anisotropy&&(s.anisotropy=r.anisotropy),void 0!==r.flipY&&(s.flipY=r.flipY),void 0!==r.premultiplyAlpha&&(s.premultiplyAlpha=r.premultiplyAlpha),void 0!==r.unpackAlignment&&(s.unpackAlignment=r.unpackAlignment),void 0!==r.userData&&(s.userData=r.userData),n[r.uuid]=s}return n}parseObject(e,t,i,n){let a,r,s;function o(e){return void 0===t[e]&&console.warn("AVS.Three.ObjectLoader: Undefined geometry",e),t[e]}function l(e){if(void 0!==e){if(Array.isArray(e)){const t=[];for(let n=0,a=e.length;n<a;n++){const a=e[n];void 0===i[a]&&console.warn("AVS.Three.ObjectLoader: Undefined material",a),t.push(i[a])}return t}return void 0===i[e]&&console.warn("AVS.Three.ObjectLoader: Undefined material",e),i[e]}}function c(e){return void 0===n[e]&&console.warn("AVS.Three.ObjectLoader: Undefined texture",e),n[e]}switch(e.type){case"Scene":a=new Ze,void 0!==e.background&&(Number.isInteger(e.background)?a.background=new f(e.background):a.background=c(e.background)),void 0!==e.environment&&(a.environment=c(e.environment)),void 0!==e.fog&&("Fog"===e.fog.type?a.fog=new W(e.fog.color,e.fog.near,e.fog.far):"FogExp2"===e.fog.type&&(a.fog=new Y(e.fog.color,e.fog.density)));break;case"PerspectiveCamera":a=new Xe(e.fov,e.aspect,e.near,e.far),void 0!==e.focus&&(a.focus=e.focus),void 0!==e.zoom&&(a.zoom=e.zoom),void 0!==e.filmGauge&&(a.filmGauge=e.filmGauge),void 0!==e.filmOffset&&(a.filmOffset=e.filmOffset),void 0!==e.view&&(a.view=Object.assign({},e.view));break;case"OrthographicCamera":a=new Be(e.left,e.right,e.top,e.bottom,e.near,e.far),void 0!==e.zoom&&(a.zoom=e.zoom),void 0!==e.view&&(a.view=Object.assign({},e.view)),void 0!==e.keepAspectRatio&&(a.keepAspectRatio=e.keepAspectRatio);break;case"AmbientLight":a=new Ue(e.color,e.intensity);break;case"DirectionalLight":a=new Ge(e.color,e.intensity);break;case"PointLight":a=new Ye(e.color,e.intensity,e.distance,e.decay);break;case"Mesh":case"Quads":r=o(e.geometry),s=l(e.material),a=new We(r,s),a.cellType="Quads"===e.type?_e.Quads:_e.Triangles,a.frustumCulled=void 0===s.glyphs;break;case"LineSegments":a=new Re(o(e.geometry),l(e.material)),a.cellType=_e.Lines,a.frustumCulled=void 0===a.material.glyphs;break;case"ThickLineSegments":a=new Ot(o(e.geometry),l(e.material)),a.cellType=_e.Quads,a.frustumCulled=void 0===a.material.glyphs;break;case"PointCloud":case"Points":a=new je(o(e.geometry),l(e.material)),a.cellType=_e.Points,a.frustumCulled=void 0===a.material.glyphs;break;case"Group":a=new Le;break;case"BillboardText":a=new Ct,void 0!==e.text&&(a.text=e.text),void 0!==e.fontSize&&(a.fontSize=e.fontSize),void 0!==e.fontStyle&&(a.fontStyle=e.fontStyle),void 0!==e.fontWeight&&(a.fontWeight=e.fontWeight),void 0!==e.fontFamily&&(a.fontFamily=e.fontFamily),void 0!==e.textDecoration&&(a.textDecoration=e.textDecoration),void 0!==e.color&&a.color.setHex(e.color),void 0!==e.textAlign&&(a.textAlign=e.textAlign),void 0!==e.transform&&(a.transform=e.transform),void 0!==e.transformOrigin&&(a.transformOrigin=e.transformOrigin),void 0!==e.textScale&&(a.textScale=e.textScale);break;default:a=new j}if(a.uuid=e.uuid,void 0!==e.name&&(a.name=e.name),void 0!==e.matrix?(a.matrix.fromArray(e.matrix),void 0!==e.matrixAutoUpdate&&(a.matrixAutoUpdate=e.matrixAutoUpdate),a.matrixAutoUpdate&&a.matrix.decompose(a.position,a.quaternion,a.scale)):(void 0!==e.position&&a.position.fromArray(e.position),void 0!==e.rotation&&a.rotation.fromArray(e.rotation),void 0!==e.quaternion&&a.quaternion.fromArray(e.quaternion),void 0!==e.scale&&a.scale.fromArray(e.scale)),void 0!==e.castShadow&&(a.castShadow=e.castShadow),void 0!==e.receiveShadow&&(a.receiveShadow=e.receiveShadow),e.shadow&&(void 0!==e.shadow.bias&&(a.shadow.bias=e.shadow.bias),void 0!==e.shadow.normalBias&&(a.shadow.normalBias=e.shadow.normalBias),void 0!==e.shadow.radius&&(a.shadow.radius=e.shadow.radius),void 0!==e.shadow.mapSize&&a.shadow.mapSize.fromArray(e.shadow.mapSize),void 0!==e.shadow.camera&&(a.shadow.camera=this.parseObject(e.shadow.camera))),void 0!==e.visible&&(a.visible=e.visible),void 0!==e.frustumCulled&&(a.frustumCulled=e.frustumCulled),void 0!==e.renderOrder&&(a.renderOrder=e.renderOrder),void 0!==e.userData&&(a.userData=e.userData),void 0!==e.layers&&(a.layers.mask=e.layers),void 0!==e.children){const r=e.children;for(let e=0;e<r.length;e++)a.add(this.parseObject(r[e],t,i,n))}return a.internalData={},void 0!==e.internalData&&(a.internalData=e.internalData),a}setTexturePath(e){return console.warn("AVS.Three.ObjectLoader: .setTexturePath() has been renamed to .setResourcePath()."),this.setResourcePath(e)}}const _t={UVMapping:G,CubeReflectionMapping:U,CubeRefractionMapping:B,EquirectangularReflectionMapping:X,EquirectangularRefractionMapping:Z,CubeUVReflectionMapping:V,CubeUVRefractionMapping:q},Tt={RepeatWrapping:J,ClampToEdgeWrapping:K,MirroredRepeatWrapping:Q},Lt={NearestFilter:$,NearestMipmapNearestFilter:ee,NearestMipmapLinearFilter:te,LinearFilter:ie,LinearMipmapNearestFilter:ne,LinearMipmapLinearFilter:ae};class Pt{constructor(e){var t=e;this.getID=function(){return t},this.container=document.createElement("div"),this.container.style.position="relative",this.container.style.outline="none",this.container.style.overflow="hidden",this.container.style.width="100%",this.container.style.height="100%",this.container.id="avsthreeDiv",this.domElement=this.container,this.scenes=[],this.currentScene=null,this.objectLoader=new Et,this.startCell=1,this.raycaster=new re,this.raycaster.params.Line.threshold=.001,this.validPick=!1,this.pickType=Ce.Ray,this.pickDepth=ke.Closest,this.pickRayX=0,this.pickRayY=0,this.pickRectangleLeft=0,this.pickRectangleTop=0,this.pickRectangleRight=1,this.pickRectangleBottom=1,this.selectionListeners=[],this.intersects=[],this.highlightList=[],this.updateHighlight=!1,this.highlightColor=new f(16711680),this.updatePicking=!1,this.pickState=new Float32Array(1),this.resolution=new u,this.loading=!1,this.firstChunk=!1,this.animator=null,this.displayCanvas=!1}setWebGLRenderer(e){this.renderer=e,this.renderer.autoClear=!1,this.renderer.localClippingEnabled=!0,this.renderer.sortObjects=!1}updateSize(){var e=this.container.clientWidth,t=this.container.clientHeight;if(e!==this.width||t!==this.height){this.width=e,this.height=t,this.updateHighlight=!0,this.updatePicking=!0,this.validPick=!1;for(var i=0;i<this.scenes.length;i++)this.updateSceneSize(this.scenes[i])}}updateSceneSize(e){if(e.windowX=Math.floor(e.windowFractionX*this.width),e.windowWidth=Math.floor(e.windowFractionWidth*this.width),e.windowY=Math.floor(e.windowFractionY*this.height),e.windowHeight=Math.floor(e.windowFractionHeight*this.height),e.windowTop=this.height-e.windowHeight-e.windowY,e.windowDiv.style.left=e.windowX+"px",e.windowDiv.style.width=e.windowWidth+"px",e.windowDiv.style.top=e.windowTop+"px",e.windowDiv.style.height=e.windowHeight+"px",e.panScene||(e.landscapeWidth=e.windowWidth,e.landscapeHeight=e.windowHeight),e.landscapeDiv.style.width=e.landscapeWidth+"px",e.landscapeDiv.style.height=e.landscapeHeight+"px",e.landscapeDiv.style.left=(e.baseLeft??0)+(e.panOffsetX??0)+"px",e.landscapeDiv.style.top=(e.baseTop??0)+(e.panOffsetY??0)+"px",e.landscapeGrid&&this.sizeLandscapeGrid(e),e.rectCanvas&&(e.rectCanvas.width=e.windowWidth,e.rectCanvas.height=e.windowHeight),e.camera.isOrthographicCamera&&e.camera.keepAspectRatio){var t=e.landscapeWidth/e.internalData.width,i=e.landscapeHeight/e.internalData.height,n=e.internalData.width/e.internalData.height;e.landscapeWidth,e.landscapeHeight,n<1||(e.camera.left=e.camera.origLeft*t/i,e.camera.right=e.camera.origRight*t/i),e.camera.updateProjectionMatrix()}}sizeLandscapeGrid(e){for(var t=[],i=[],n=Math.floor(e.landscapeHeight/e.landscapeRows),a=0,r=0;r<e.landscapeRows;r++){var s=r==e.landscapeRows-1?e.landscapeHeight-a:n;t.push(a),i.push(s),a+=s}for(var o=[],l=[],c=Math.floor(e.landscapeWidth/e.landscapeColumns),d=0,h=0;h<e.landscapeColumns;h++){var p=h==e.landscapeColumns-1?e.landscapeWidth-d:c;o.push(d),l.push(p),d+=p}for(r=0;r<e.landscapeRows;r++)for(h=0;h<e.landscapeColumns;h++){var u=e.landscapeGrid[r][h];u.left=o[h],u.top=t[r];var f=!1;u.width===l[h]&&u.height===i[r]||(u.width=l[h],u.height=i[r],f=!0),this.isGridItemVisible(u)?u.initialized&&!f||(u.initialized||this.initializeGridItem(u),this.sizeGridItem(u)):u.initialized&&this.disposeGridItem(u)}}sizeGridItem(e){e.initialized&&(e.canvas.style.left=e.left+"px",e.canvas.style.top=e.top+"px",e.canvas.style.width=e.width+"px",e.canvas.style.height=e.height+"px",e.highlightCanvas.style.left=e.left+"px",e.highlightCanvas.style.top=e.top+"px",e.highlightCanvas.style.width=e.width+"px",e.highlightCanvas.style.height=e.height+"px",e.pixelX=Math.floor(e.left*window.devicePixelRatio),e.pixelY=Math.floor(e.top*window.devicePixelRatio),e.pixelWidth=Math.floor(e.width*window.devicePixelRatio),e.pixelHeight=Math.floor(e.height*window.devicePixelRatio),e.canvas.width=e.pixelWidth,e.canvas.height=e.pixelHeight,e.highlightCanvas.width=e.pixelWidth,e.highlightCanvas.height=e.pixelHeight,e.renderTarget.setSize(e.pixelWidth,e.pixelHeight),e.pixelBuffer=new Uint8Array(4*e.pixelWidth*e.pixelHeight),e.pickingRenderTarget.setSize(e.pixelWidth,e.pixelHeight),e.pickingPixelBuffer=new Uint8Array(4*e.pixelWidth*e.pixelHeight))}clearGeometry(){for(;this.container.lastChild;)this.container.removeChild(this.container.lastChild);this.panInteractor&&this.panInteractor.clear();for(let e=0;e<this.scenes.length;e++)this.scenes[e].traverse((function(e){e.material&&(e.material.map&&e.material.map.dispose(),e.material.dispose()),e.geometry&&e.geometry.dispose()}));this.scenes=[],this.currentScene=null,this.startCell=1,null!==this.animator&&this.animator.clear()}setPickDepth(e){void 0===e&&(e=ke.Closest),this.pickDepth!==e&&(this.pickDepth=e)}setPickRay(e,t){if(e<0||t<0||e>this.width||t>this.height)return this.validPick=!1,void console.error("AVS.Three.Viewer: pick ray coordinates out of range.");this.pickType=Ce.Ray,this.pickRayX=e,this.pickRayY=t,this.validPick=!0}setPickRectangle(e,t,i,n){if(e<0||t<0||i>this.width||n>this.height)return this.validPick=!1,void console.error("AVS.Three.Viewer: pick rectangle coordinates out of range.");this.pickType=Ce.Rectangle,this.pickRectangleLeft=e,this.pickRectangleTop=t,this.pickRectangleRight=i,this.pickRectangleBottom=n,this.validPick=!0}interactorUpdate(e){e===this.transformInteractor&&void 0!==this.zoomRectangleInteractor&&e.object===this.zoomRectangleInteractor.object&&(this.zoomRectangleInteractor.scale.copy(e.object.scale),this.zoomRectangleInteractor.position.copy(e.object.position)),e===this.zoomRectangleInteractor&&void 0!==this.transformInteractor&&e.object===this.transformInteractor.object&&(this.transformInteractor.scale.copy(e.object.scale),this.transformInteractor.position.copy(e.object.position)),this.updatePicking=!0,this.render(!0),void 0!==this.stats&&this.stats.update()}panInteractorUpdate(){for(var e=0;e<this.scenes.length;e++){var t=this.scenes[e];if(t.landscapeGrid)for(var i=0;i<t.landscapeRows;i++)for(var n=0;n<t.landscapeColumns;n++){var a=t.landscapeGrid[i][n];this.isGridItemVisible(a)?a.initialized||(this.initializeGridItem(a),this.sizeGridItem(a),this.renderGridItem(a,!0),this.updatePicking=!0):a.initialized&&this.disposeGridItem(a)}}}addInteractor(e){if(e.isTransformInteractor)this.transformInteractor=e,e.addEventListener("change",this.interactorUpdate.bind(this,e));else if(e.isZoomRectangleInteractor)this.zoomRectangleInteractor=e,e.addEventListener("change",this.interactorUpdate.bind(this,e));else{if(!e.isPanInteractor)return;this.panInteractor=e,e.addEventListener("change",this.panInteractorUpdate.bind(this))}e.domElement=this.domElement}removeInteractor(e){e.isTransformInteractor?(e.removeEventListener("change",this.interactorUpdate.bind(this,this.transformInteractor)),this.transformInteractor=void 0):e.isZoomRectangleInteractor?(e.removeEventListener("change",this.interactorUpdate.bind(this,this.zoomRectangleInteractor)),this.zoomRectangleInteractor=void 0):e.isPanInteractor&&(this.panInteractor=void 0)}setAnimator(e){this.animator=e,e.addEventListener("change",this.interactorUpdate.bind(this))}addStats(){void 0===this.stats&&(this.stats=new Stats,this.container.appendChild(this.stats.dom))}addGeometry(e){e.updateMatrixWorld(),void 0!==e.internalData.background?this.container.style.backgroundColor="#"+e.internalData.background.toString(16).padStart(6,"0"):this.container.style.backgroundColor="transparent",this.processGeometry(e);for(var t=0;t<this.scenes.length;t++){var i=this.scenes[t];i.parent&&i.parent.remove(i)}}processGeometry(e){if(e.isScene){for(var t=0;t<e.children.length;t++){var i=e.children[t];if(i.isPerspectiveCamera||i.isOrthographicCamera){e.camera=i,e.remove(i);break}}null==e.camera&&null!==e.background&&(e.camera=new c),void 0!==e.camera&&this.addScene(e)}this.attachInteractors(e),this.addLabels(e),this.createPickingInfo(e),this.addMaterialReferences(e);var n=e.children,a=n.length;for(t=0;t<a;)this.processGeometry(n[t]),a!==n.length?a=n.length:t++}addScene(e,i=!1){this.scenes.push(e),this.currentScene=e,i||(this.currentRealScene=e),e.labels=[],this.calculateSceneFractions(e);var n=document.createElement("div");n.style.position="absolute",n.style.overflow="hidden",n.id=e.name+"-Window";var a=document.createElement("div");a.style.position="absolute",a.style.overflow="hidden",a.id=e.name+"-Landscape",n.appendChild(a),e.landscapeDiv=a,e.windowDiv=n,this.container.appendChild(n),this.updateSceneSize(e),e.startCell=this.startCell,e.highlightScene=new h,e.highlightScene.add(new t);for(var r=0;r<e.children.length;r++)e.children[r].isLight&&e.highlightScene.add(e.children[r].clone())}calculateSceneFractions(e){e.windowFractionX=e.internalData.x?Math.max(0,e.internalData.x/this.width):0,e.windowFractionWidth=e.internalData.width?Math.min(1,e.internalData.width/this.width):1,e.windowFractionY=e.internalData.y?Math.max(0,e.internalData.y/this.height):0,e.windowFractionHeight=e.internalData.height?Math.min(1,e.internalData.height/this.height):1}createLandscapeGrid(e){void 0===e.landscapeRows&&(e.landscapeRows=1),void 0===e.landscapeColumns&&(e.landscapeColumns=1),e.landscapeGrid=[];for(var t=0;t<e.landscapeRows;t++){e.landscapeGrid.push([]);for(var i=0;i<e.landscapeColumns;i++){var n={};n.container=e.landscapeDiv,n.scene=e,n.name=e.name+"-Landscape-Grid-Row"+t+"-Col"+i,n.initialized=!1,e.landscapeGrid[t].push(n)}}this.sizeLandscapeGrid(e)}isGridItemVisible(e){var t=e.scene,i=(t.baseLeft??0)+(t.panOffsetX??0)+e.left,n=i+e.width,a=(t.baseTop??0)+(t.panOffsetY??0)+e.top,r=a+e.height;return!(n<0||i>t.windowWidth||r<0||a>t.windowHeight)}initializeGridItem(e){var t=document.createElement("canvas");t.style.position="absolute",t.id=e.name,e.container.insertBefore(t,e.container.firstChild),e.canvas=t,e.ctx=t.getContext("2d"),this.displayCanvas&&(t.style.backgroundColor="rgba("+255*Math.random()+","+255*Math.random()+","+255*Math.random()+",0.1)");var i=document.createElement("canvas");i.style.position="absolute",i.id=e.name+"-Highlight",e.container.appendChild(i),e.highlightCanvas=i,e.highlightCtx=i.getContext("2d"),e.renderTarget=new se,e.pickingRenderTarget=new se,e.initialized=!0}disposeGridItem(e){e.container.removeChild(e.canvas),e.canvas=null,e.ctx=null,e.container.removeChild(e.highlightCanvas),e.highlightCanvas=null,e.highlightCtx=null,e.renderTarget=null,e.pickingRenderTarget=null,e.initialized=!1}attachInteractors(t){if(t.internalData.attachTransformInteractor&&this.transformInteractor&&this.transformInteractor.setObjectScene(t,this.currentScene),t.internalData.attachZoomRectangleInteractor&&this.zoomRectangleInteractor&&this.zoomRectangleInteractor.setObjectScene(t,this.currentScene),t.internalData.attachPanInteractor&&this.panInteractor){var i=this.currentRealScene,n=t.parent;n.matrix.copy(t.parent.matrixWorld),n.matrixAutoUpdate=!1,n.isScene=!0,n.autoUpdate=!0,n.overrideMaterial=null,n.internalData.is3D=!1,n.internalData.pickable=this.isObjectPickable(t.parent),n.name=t.name,n.panScene=!0,i.origCamera||(i.origCamera=i.camera.clone(),i.internalData.origWidth=i.internalData.width,i.internalData.origHeight=i.internalData.height),n.camera=i.origCamera.clone();var a=n.camera.right-n.camera.left,r=n.camera.top-n.camera.bottom,s=new e;s.set(-t.internalData.xSize/2,-t.internalData.ySize/2,0),s.applyMatrix4(n.matrix);var o=new e;o.set(t.internalData.xSize/2,t.internalData.ySize/2,0),o.applyMatrix4(n.matrix);var l=i.internalData.origWidth,c=i.internalData.origHeight,d=Math.floor((s.x-n.camera.left)/a*l),h=Math.floor((1-(o.x-n.camera.left)/a)*l),p=Math.floor((s.y-n.camera.bottom)/r*c),u=Math.floor((1-(o.y-n.camera.bottom)/r)*c);this.panInteractor.leftLimit=(l-this.width)/2,this.panInteractor.rightLimit=-this.panInteractor.leftLimit,this.panInteractor.topLimit=(c-this.height)/2,this.panInteractor.bottomLimit=-this.panInteractor.topLimit,n.baseLeft=this.panInteractor.rightLimit-d,n.baseTop=this.panInteractor.bottomLimit-u,n.landscapeWidth=l,n.landscapeHeight=c,n.landscapeRows=Math.ceil(c/this.height),n.landscapeColumns=Math.ceil(l/this.width),n.centerWidth=l-d-h,n.centerHeight=c-p-u,n.zoomOffsetLeft=2*d+n.baseLeft,n.zoomOffsetTop=2*u+n.baseTop,"center"===t.internalData.attachPanInteractor?(n.internalData.x=d,n.internalData.width=this.width-d-h,n.internalData.y=p,n.internalData.height=this.height-p-u,i.internalData.x=n.internalData.x,i.internalData.width=n.internalData.width,i.internalData.y=n.internalData.y,i.internalData.height=n.internalData.height,i.camera.left=s.x,i.camera.right=o.x,i.camera.bottom=s.y,i.camera.top=o.y,this.calculateSceneFractions(i),this.updateSceneSize(i)):"bottom"===t.internalData.attachPanInteractor?(n.landscapeHeight=this.height,n.landscapeRows=1,n.camera.top=n.camera.bottom+r*this.height/c,n.internalData.x=d,n.internalData.width=this.width-d-h,n.internalData.y=0,n.internalData.height=this.height-u,n.baseTop=-u):"top"===t.internalData.attachPanInteractor?(n.landscapeHeight=this.height,n.landscapeRows=1,n.camera.bottom=n.camera.top-r*this.height/c,n.internalData.x=d,n.internalData.width=this.width-d-h,n.internalData.y=p,n.internalData.height=this.height-p,n.baseTop=0):"left"===t.internalData.attachPanInteractor?(n.landscapeWidth=this.width,n.landscapeColumns=1,n.camera.right=n.camera.left+a*this.width/l,n.internalData.x=0,n.internalData.width=this.width-h,n.internalData.y=p,n.internalData.height=this.height-p-u,n.baseLeft=0):"right"===t.internalData.attachPanInteractor&&(n.landscapeWidth=this.width,n.landscapeColumns=1,n.camera.left=n.camera.right-a*this.width/l,n.internalData.x=d,n.internalData.width=this.width-d,n.internalData.y=p,n.internalData.height=this.height-p-u,n.baseLeft=-d),this.addScene(n,!0),n.parent&&n.parent.remove(n),"center"===t.internalData.attachPanInteractor?this.panInteractor.object=n:"bottom"===t.internalData.attachPanInteractor?this.panInteractor.linkObjectsBottom.push(n):"top"===t.internalData.attachPanInteractor?this.panInteractor.linkObjectsTop.push(n):"left"===t.internalData.attachPanInteractor?this.panInteractor.linkObjectsLeft.push(n):"right"===t.internalData.attachPanInteractor&&this.panInteractor.linkObjectsRight.push(n),this.panInteractor.restorePanOffset(n),this.panInteractor.update()}else if(t.internalData.attachPanInteractorStatic&&this.panInteractor){var f=this;t.traverseAncestors((function(e){"bottom"===e.internalData.attachPanInteractor?(f.panInteractor.linkObjectsBottomStatic.push(t),t.linkBottom=e):"top"===e.internalData.attachPanInteractor?(f.panInteractor.linkObjectsTopStatic.push(t),t.linkTop=e):"left"===e.internalData.attachPanInteractor?(f.panInteractor.linkObjectsLeftStatic.push(t),t.linkLeft=e):"right"===e.internalData.attachPanInteractor&&(f.panInteractor.linkObjectsRightStatic.push(t),t.linkRight=e)}))}}createPickingInfo(e){if(void 0!==e.geometry&&void 0!==e.material){if(void 0===e.geometry.attributes.cellCount){var t,i;if(e.material.glyphs){var n=e.geometry.attributes.offset.array.length/3;i=n;for(var a=new Float32Array(n),r=0;r<n;r++)a[r]=r;t=new oe(a,1)}else if(e.isThickLineSegments){i=(s=e.geometry.attributes.instanceStart.array.length/3)/2;for(a=new Float32Array(i),r=0;r<i;r++)a[r]=r;t=new oe(a,1)}else{var s,o=1;e.isPoints?o=1:e.isLineSegments?o=2:e.isMesh&&(o=3),i=(s=e.geometry.attributes.position.array.length/3)/o,t=new C(s,1);for(r=0;r<i;r++)for(var l=0;l<o;l++)t.array[r*o+l]=r}e.geometry.setAttribute("cellCount",t),e.geometry.nCells=i}e.nCells=e.geometry.nCells,e.startCell=this.startCell,e.onBeforeRender=function(e,t,i,n,a,r){a.uniforms.startCell.value=this.startCell,a.uniformsNeedUpdate=!0},this.startCell+=e.nCells,this.currentScene.landscapeGrid||this.createLandscapeGrid(this.currentScene),!this.pickingRenderTarget2&&this.startCell>16777215&&(this.pickingRenderTarget2=new se(this.pixelWidth,this.pixelHeight),this.pickingPixelBuffer2=new Uint8Array(4*this.pixelWidth*this.pixelHeight)),this.updatePicking=!0}}addLabels(e){e.isBillboardText&&e.addToScene(this.currentScene)}addMaterialReferences(e){void 0!==e.material&&(e.material.pickState=this.pickState,void 0!==e.material.isLineBasicMaterial&&(e.material.resolution=this.resolution))}loadGeometryAsJson(e){var t=this;this.objectLoader.parse(e,(function(e){if(t.clearGeometry(),t.updateSize(),t.addGeometry(e),null!==t.animator){for(var i=0;i<t.scenes.length;i++)t.animator.attach(t.scenes[i]);t.animator.hasAnimations()?t.animator.play():t.render()}else t.render()}))}loadGeometryAsEvents(e){var t=this,i=0,n=-1,a=0;function r(e){if(a--,e.layers.set(1),e.visible=e.saveVisible,n>0&&0==a)return t.render(),t.loading=!1,void(t.firstChunk=!1)}function s(e){if("Group"===e.type){var n=t.objectLoader.parse(e);null!==t.curGroup&&t.curGroup.add(n),"SceneRoot"===n.name&&(void 0!==n.internalData.background?t.container.style.backgroundColor="#"+n.internalData.background.toString(16).padStart(6,"0"):t.container.style.backgroundColor="transparent"),n.updateMatrixWorld(!0),t.attachInteractors(n),t.curGroup=n}else if("FinishGroup"===e.type)null!==t.curGroup.parent&&(t.curGroup=t.curGroup.parent);else if("Geometry"===e.type){a++;var s=t.objectLoader.parse(e,r,t.images,t.textures,t.materials,t.geometries,t.curGroup);i++,t.addLabels(s),t.createPickingInfo(s),t.addMaterialReferences(s)}else if("Layout"===e.type){for(var o=t.objectLoader.parse(e),l=0;l<o.children.length;l++){var d=o.children[l];if(d.isPerspectiveCamera||d.isOrthographicCamera){o.camera=d,o.remove(d);break}}null==o.camera&&null!==o.background&&(o.camera=new c),void 0!==o.camera&&t.addScene(o),t.curGroup=o}else console.log("ERROR: unknown type: "+e.type)}if(void 0!==this.chunkId&&this.chunkId===e.chunkId||(this.clearGeometry(),this.curGroup=null,this.images=[],this.textures=[],this.materials=[],this.geometries=[],this.firstChunk=!0,this.chunkId=e.chunkId),this.loading=!0,this.updateSize(),void 0!==e&&void 0!==e.events&&0!==e.events.length){for(var o=0;o<e.events.length;o++)s(e.events[o]);!0===e.moreChunks?this.render():(n=i-1,0==a&&(this.render(),this.loading=!1)),this.firstChunk=!1}else console.error("AVS.Three.Viewer.loadGeometryAsEvents: Can't get events")}highlightRender(){if(void 0!==this.renderer)for(var e=0;e<this.scenes.length;e++){var t=this.scenes[e];if(t.landscapeGrid){for(var i=0;i<t.landscapeRows;i++)for(var n=0;n<t.landscapeColumns;n++){var a=t.landscapeGrid[i][n];a.initialized&&(this.resolution.x=a.pixelWidth,this.resolution.y=a.pixelHeight,this.renderer.setSize(a.pixelWidth,a.pixelHeight),this.renderer.setClearColor(0,0),this.renderer.clear(),t.camera.setViewOffset(t.landscapeWidth,t.landscapeHeight,a.left,a.top,a.width,a.height),this.renderer.render(t.highlightScene,t.camera),a.highlightCtx.clearRect(0,0,a.pixelWidth,a.pixelHeight),a.highlightCtx.drawImage(this.renderer.domElement,0,0))}t.camera.clearViewOffset()}}else console.error("AVS.Three.Viewer: WebGLRenderer not set.")}pickRender(){if(void 0!==this.renderer){for(var e=0;e<this.scenes.length;e++){var t=this.scenes[e];if(t.landscapeGrid){t.traverse((function(e){void 0!==e.material&&(e.material.transparent=!1)}));for(var i=0;i<t.landscapeRows;i++)for(var n=0;n<t.landscapeColumns;n++){var a=t.landscapeGrid[i][n];a.initialized&&(this.resolution.x=a.pixelWidth,this.resolution.y=a.pixelHeight,this.renderer.setRenderTarget(a.pickingRenderTarget),this.pickState[0]=1,this.renderer.setClearColor(0,0),this.renderer.clear(),t.camera.setViewOffset(t.landscapeWidth,t.landscapeHeight,a.left,a.top,a.width,a.height),this.renderer.render(t,t.camera),this.renderer.readRenderTargetPixels(a.pickingRenderTarget,0,0,a.pixelWidth,a.pixelHeight,a.pickingPixelBuffer),a.pickingRenderTarget2&&(this.renderer.setRenderTarget(a.pickingRenderTarget2),this.pickState[0]=2,this.renderer.clear(),this.renderer.render(t,t.camera),this.renderer.readRenderTargetPixels(a.pickingRenderTarget2,0,0,a.pixelWidth,a.pixelHeight,a.pickingPixelBuffer2)))}t.camera.clearViewOffset(),t.traverse((function(e){void 0!==e.material&&(e.material.transparent=e.material.saveTransparent)}))}}this.pickState[0]=0,this.renderer.setRenderTarget(null)}else console.error("AVS.Three.Viewer: WebGLRenderer not set.")}render(e){if(void 0!==this.renderer){if(null!==this.domElement.offsetParent){this.updateSize();for(var t=this.loading,i=e||!t,n=0;n<this.scenes.length;n++){var a=this.scenes[n];if(a.landscapeGrid){if(!i){a.camera.layers.set(1);for(var r=0;r<a.children.length;r++)a.children[r].isLight&&a.children[r].layers.set(1)}for(var s=0;s<a.landscapeRows;s++)for(var o=0;o<a.landscapeColumns;o++){var l=a.landscapeGrid[s][o];this.renderGridItem(l,i)}i||(a.camera.layers.set(0),a.traverse((function(e){e.layers.set(0)})))}for(r=0;r<a.labels.length;r++)a.labels[r].updatePosition()}this.updateHighlight&&(this.highlightRender(),this.updateHighlight=!1)}}else console.error("AVS.Three.Viewer: WebGLRenderer not set.")}renderGridItem(e,t){if(e.initialized){var i=e.scene;if(this.resolution.x=e.pixelWidth,this.resolution.y=e.pixelHeight,t?this.renderer.setSize(e.pixelWidth,e.pixelHeight):this.renderer.setRenderTarget(e.renderTarget),(t||this.firstChunk)&&(i.internalData.background?this.renderer.setClearColor(i.internalData.background,1):this.renderer.setClearColor(0,0),this.renderer.clear()),i.camera.setViewOffset(i.landscapeWidth,i.landscapeHeight,e.left,e.top,e.width,e.height),this.renderer.render(i,i.camera),t)e.ctx.clearRect(0,0,e.pixelWidth,e.pixelHeight),e.ctx.drawImage(this.renderer.domElement,0,0);else{this.renderer.readRenderTargetPixels(e.renderTarget,0,0,e.pixelWidth,e.pixelHeight,e.pixelBuffer);for(var n,a,r=e.ctx.createImageData(e.pixelWidth,e.pixelHeight),s=4*e.pixelWidth,o=0;o<e.pixelBuffer.length;o++)n=Math.floor(o/s),a=o%s,r.data[(e.pixelHeight-n-1)*s+a]=e.pixelBuffer[o];e.ctx.putImageData(r,0,0),this.renderer.setRenderTarget(null)}i.camera.clearViewOffset()}}addSelectionListener(e){void 0!==e&&this.selectionListeners.push(e)}concatObjectsFromCellNums(e,t,i,n){if(void 0!==i&&0!==i.length&&0!==i[0]){for(void 0===n&&(n=t.startCell,i.sort((function(e,t){return e-t})));void 0!==t.nCells&&i[0]>=n&&i[0]<n+t.nCells;)if(t.material.glyphs||t.isThickLineSegments?e.push({object:t,index:i[0]-n}):t.isMesh?e.push({object:t,faceIndex:i[0]-n}):e.push({object:t,index:(t.isLineSegments?2:1)*(i[0]-n)}),i.splice(0,1),0===i.length)return;void 0!==t.nCells&&(n+=t.nCells);for(var a=0;a<t.children.length&&void 0!==(n=this.concatObjectsFromCellNums(e,t.children[a],i,n));a++);return n}}pick(){if(!1!==this.validPick){this.pickDepth===ke.Closest&&this.updatePicking&&(this.pickRender(),this.updatePicking=!1),this.intersects=[];for(var e=0;e<this.scenes.length;e++){var t=this.scenes[e];if(t.landscapeGrid)if(this.pickType===Ce.Rectangle){var i=Math.max(this.pickRectangleLeft,t.windowX),n=Math.max(this.pickRectangleTop,t.windowTop),a=Math.min(this.pickRectangleRight,t.windowX+t.windowWidth),r=Math.min(this.pickRectangleBottom,t.windowTop+t.windowHeight);i-=t.windowX,n-=t.windowTop,a-=t.windowX,r-=t.windowTop,i-=(t.panOffsetX??0)+(t.baseLeft??0),a-=(t.panOffsetX??0)+(t.baseLeft??0),n-=(t.panOffsetY??0)+(t.baseTop??0),r-=(t.panOffsetY??0)+(t.baseTop??0);for(var s=[],o=i;o<a;o++)for(var l=n;l<r;l++)if(this.pickDepth===ke.All){var c=o/t.landscapeWidth*2-1,d=(t.landscapeHeight-l-1)/t.landscapeHeight*2-1;this.raycaster.setFromCamera(new u(c,d),t.camera),this.raycaster.landscapeWidth=t.landscapeWidth,this.raycaster.landscapeHeight=t.landscapeHeight,this.raycaster.x=o,this.raycaster.y=l;var h=this.raycaster.intersectObjects(t.children,!0);this.intersects=this.intersects.concat(h)}else for(var p=0;p<t.landscapeRows;p++)for(var f=0;f<t.landscapeColumns;f++){if((b=t.landscapeGrid[p][f]).initialized&&!(o<b.left||o>b.left+b.width||l<b.top||l>b.top+b.height)){var m=Math.floor(o*window.devicePixelRatio),v=Math.floor(l*window.devicePixelRatio),g=4*(m-b.pixelX+(b.pixelHeight-(v-b.pixelY)-1)*b.pixelWidth),y=255*b.pickingPixelBuffer[g]*255+255*b.pickingPixelBuffer[g+1]+b.pickingPixelBuffer[g+2];b.pickingPixelBuffer2&&(y+=255*b.pickingPixelBuffer2[g]*255*255*255*255+255*b.pickingPixelBuffer2[g+1]*255*255*255+255*b.pickingPixelBuffer2[g+2]*255*255),y>0&&-1===s.indexOf(y)&&s.push(y)}}this.pickDepth===ke.Closest&&this.concatObjectsFromCellNums(this.intersects,t,s)}else{if(this.pickRayX<t.windowX||this.pickRayX>t.windowX+t.windowWidth||this.pickRayY<t.windowTop||this.pickRayY>t.windowTop+t.windowHeight)continue;o=this.pickRayX-t.windowX,l=this.pickRayY-t.windowTop;if(o-=(t.panOffsetX??0)+(t.baseLeft??0),l-=(t.panOffsetY??0)+(t.baseTop??0),this.pickDepth===ke.All){c=o/t.landscapeWidth*2-1,d=(t.landscapeHeight-l-1)/t.landscapeHeight*2-1;this.raycaster.setFromCamera(new u(c,d),t.camera),this.raycaster.landscapeWidth=t.landscapeWidth,this.raycaster.landscapeHeight=t.landscapeHeight,this.raycaster.x=o,this.raycaster.y=l;h=this.raycaster.intersectObjects(t.children,!0);this.intersects=this.intersects.concat(h)}else for(p=0;p<t.landscapeRows;p++)for(f=0;f<t.landscapeColumns;f++){var b;if((b=t.landscapeGrid[p][f]).initialized&&!(o<b.left||o>b.left+b.width||l<b.top||l>b.top+b.height)){m=Math.floor(o*window.devicePixelRatio),v=Math.floor(l*window.devicePixelRatio),g=4*(m-b.pixelX+(b.pixelHeight-(v-b.pixelY)-1)*b.pixelWidth),y=255*b.pickingPixelBuffer[g]*255+255*b.pickingPixelBuffer[g+1]+b.pickingPixelBuffer[g+2];b.pickingPixelBuffer2&&(y+=255*b.pickingPixelBuffer2[g]*255*255*255*255+255*b.pickingPixelBuffer2[g+1]*255*255*255+255*b.pickingPixelBuffer2[g+2]*255*255),this.concatObjectsFromCellNums(this.intersects,t,[y])}}}}for(e=0;e<this.selectionListeners.length;e++)this.selectionListeners[e]()}else console.error("AVS.Three.Viewer: invalid pick ray or rectangle.")}isObjectPickable(e){return void 0!==e.internalData.pickable?e.internalData.pickable:null===e.parent||this.isObjectPickable(e.parent)}getPickedCells(){for(var e=[],t=0;t<this.intersects.length;t++){var i=this.intersects[t].object;if(this.isObjectPickable(i)){for(var n=this.intersects[t].faceIndex??this.intersects[t].index,a=!1,r=0;r<e.length;r++)if(i===e[r].object){a=!0;for(var s=!1,o=0;o<e[r].indices.length;o++)if(n===e[r].indices[o]){s=!0;break}s||e[r].indices.push(n);break}a||e.push({object:i,indices:[n]})}}return e}getPickedCellSets(){for(var e=[],t=0;t<this.intersects.length;t++){var i=this.intersects[t].object;if(this.isObjectPickable(i)){for(var n=!1,a=0;a<e.length;a++)if(e[a].object===i){n=!0;break}n||e.push({object:i})}}return e}getPickedSceneNodes(){for(var e=[],t=0;t<this.intersects.length;t++){var i=this.intersects[t].object;if(this.isObjectPickable(i)){for(var n=i.parent,a=!1,r=0;r<e.length;r++)if(e[r].object===n){a=!0;break}a||e.push({object:n})}}return e}getSelectionInfo(e){for(var t=[],i=0;i<e.length;i++){var n=e[i].object,a=e[i].indices;if(void 0!==a)for(var r=0;r<a.length;r++)t.push(s(n,{},a[r]));else t.push(s(n,{}))}function s(e,t,i){for(var n in e.userData)void 0===t[n]&&(void 0!==i&&Array.isArray(e.userData[n])?t[n]=decodeURIComponent(e.userData[n][i]):t[n]=decodeURIComponent(e.userData[n]));return e.parent?s(e.parent,t):t}return t}highlightObjects(e,t){for(var i=!1,n=0;n<this.highlightList.length;n++){void 0!==(s=this.highlightList[n]).saveMaterial&&(s.material=s.saveMaterial,s.saveMaterial=void 0,i=!0),void 0!==s.saveGeometry&&(s.geometry=s.saveGeometry,s.saveGeometry=void 0,i=!0)}for(n=0;n<this.scenes.length;n++){var a=this.scenes[n].highlightScene.children[0].children;a.length>0&&(a.length=0,this.updateHighlight=!0)}this.highlightList.length=0;var r=this;for(n=0;n<e.length;n++){var s;o(s=e[n].object,e[n].indices)}function o(e,n){if(e.isMesh||e.isLineSegments||e.isPoints){r.highlightList.push(e);var a,s=e.material.clone();if(s.opacity=1,void 0!==n){var l=e.geometry;if(s.vertexColors=!0,s.color=new f(16777215),e.isThickLineSegments){var c;if(a=new _,l.attributes.instancedColorStart,void 0===oldColorStart){c=new T(new Float32Array(l.attributes.instanceStart.array.length),6,1);for(var d=0,h=0;h<c.array.length/3;h++)c.array[d++]=e.material.color.r,c.array[d++]=e.material.color.g,c.array[d++]=e.material.color.b}else c=oldColorStart.data.clone();d=null;var p=null;for(h=0;h<n.length;h++){d=6*Math.floor(n[h]/6),p=2;for(var u=0;u<p;u++)c.array[d++]=r.highlightColor.r,c.array[d++]=r.highlightColor.g,c.array[d++]=r.highlightColor.b}for(var m in a.setAttribute("instancedColorStart",new L(c,3,0)),a.setAttribute("instancedColorEnd",new L(c,3,3)),l.attributes)"instancedColorStart"!==m&&"instancedColorEnd"!==m&&a.setAttribute(m,l.attributes[m])}else{a=e.material.glyphs?new _:new le;var v=l.attributes.color,g=null;if(void 0===v){g=e.material.glyphs?new oe(new Float32Array(l.attributes.offset.array.length),3):new C(l.attributes.position.array.length,3);for(d=0,h=0;h<g.array.length/3;h++)g.array[d++]=e.material.color.r,g.array[d++]=e.material.color.g,g.array[d++]=e.material.color.b}else g=v.clone();for(d=null,p=null,h=0;h<n.length;h++){e.material.glyphs||e.cellType===_e.Points?(d=3*n[h],p=1):e.cellType===_e.Lines?(d=3*n[h],p=2):e.cellType===_e.Triangles?(d=9*n[h],p=3):(d=18*Math.floor(n[h]/2),p=6);for(u=0;u<p;u++)g.array[d++]=r.highlightColor.r,g.array[d++]=r.highlightColor.g,g.array[d++]=r.highlightColor.b}for(var m in a.setAttribute("color",g),l.attributes)"color"!==m&&a.setAttribute(m,l.attributes[m])}}else s.vertexColors=!1,s.color=r.highlightColor,a=e.geometry;var y=r.getObjectScene(e);if(void 0!==y.internalData.is3D&&!1===y.internalData.is3D&&void 0!==t&&!0===t){var b=e.clone();b.material=s,b.geometry=a,b.matrixAutoUpdate=!1,b.matrix.copy(e.matrixWorld),y.highlightScene.children[0].add(b),r.updateHighlight=!0}else e.saveMaterial=e.material,e.material=s,e.saveGeometry=e.geometry,e.geometry=a,i=!0}for(var w=0;w<e.children.length;w++)o(e.children[w])}i?this.render(!0):this.updateHighlight&&(this.highlightRender(),this.updateHighlight=!1)}getObjectScene(e){return e.isScene?e:this.getObjectScene(e.parent)}}const Mt={type:"change"},jt={type:"start"},At={type:"end"};class Rt extends ce{constructor(t){super(),void 0===t&&console.warn('AVS.Three.TransformInteractor: The first parameter "domElement" is now mandatory.'),t===document&&console.error('AVS.Three.TransformInteractor: "document" should not be used as the target "domElement". Please use "renderer.domElement" instead.'),this.domElement=t,this.domElement.style.touchAction="none",this.object=new j,this.scene=null,this.enabled=!0,this.enableZoom=!0,this.enableRotate=!0,this.enablePan=!0,this.keyPanSpeed=7,this.keys={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"},this.touches={ONE:de.ROTATE,TWO:de.DOLLY_PAN},this.quaternion=this.object.quaternion.clone(),this.position=this.object.position.clone(),this.scale=this.object.scale.clone(),this.clientOnly=!1,this.fullReset=!1,this.quaternion0=this.object.quaternion.clone(),this.position0=this.object.position.clone(),this.scale0=this.object.scale.clone(),this._domElementKeyEvents=null,this.listenToKeyEvents=function(e){e.addEventListener("keydown",W),this._domElementKeyEvents=e},this.setObjectScene=function(e,t){n.object=e,n.scene=t,this.fullReset||e.internalData.transformFullReset?(n.quaternion.copy(n.object.quaternion),n.scale.copy(n.object.scale),n.position.copy(n.object.position),n.quaternion0.copy(n.object.quaternion),n.scale0.copy(n.object.scale),n.position0.copy(n.object.position),this.fullReset=!1):n.clientOnly&&(n.object.quaternion.copy(n.quaternion),n.object.scale.copy(n.scale),n.object.position.copy(n.position)),e.internalData.transformWheelActions&&(s=JSON.parse(e.internalData.transformWheelActions)),e.internalData.transformTriggers&&(o=JSON.parse(e.internalData.transformTriggers))},this.reset=function(){n.quaternion.copy(n.quaternion0),n.scale.copy(n.scale0),n.position.copy(n.position0),n.object.quaternion.copy(n.quaternion0),n.object.scale.copy(n.scale0),n.object.position.copy(n.position0),n.dispatchEvent(Mt),r=a.NONE},this.zoomIn=function(){S(1.05,0,0)&&n.dispatchEvent(Mt)},this.zoomOut=function(){S(1/1.05,0,0)&&n.dispatchEvent(Mt)},this.panTo=function(e,t,i){var a=n.object.parent.matrixWorld,r=1/a.elements[0],s=1/a.elements[5],o=1/a.elements[10],l=a.elements[12]*r,c=a.elements[13]*s,d=a.elements[14]*o;e*=n.object.scale.x,t*=n.object.scale.y,i*=n.object.scale.z,e+=l,t+=c,i+=d,n.object.position.set(n.position0.x-e,n.position0.y-t,n.position0.z-i),n.position.copy(n.object.position),n.dispatchEvent(Mt)},this.dispose=function(){n.domElement.removeEventListener("contextmenu",Y),n.domElement.removeEventListener("pointerdown",D),n.domElement.removeEventListener("pointercancel",z),n.domElement.removeEventListener("wheel",H),n.domElement.removeEventListener("pointermove",N),n.domElement.removeEventListener("pointerup",F),null!==n._domElementKeyEvents&&n._domElementKeyEvents.removeEventListener("keydown",W)};const n=this,a={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6};let r=a.NONE,s=[{modifiers:0,param:"ZOOM_AT_POINTER"}],o=[{buttons:1,modifiers:0,param:"ROTATE"},{buttons:2,modifiers:0,param:"SCALE"},{buttons:4,modifiers:0,param:"TRANSLATE"}];const l=new u,c=new u,d=new u,h=new u,p=new u,f=new u,m=[],v={};function g(e){return 2*(e-n.scene.windowDiv.getBoundingClientRect().left)/n.scene.windowWidth-1}function y(e){return 1-2*(e-n.scene.windowDiv.getBoundingClientRect().top)/n.scene.windowHeight}const b=function(){const t=new i,a=new e,r=new e,s=new e,o=new i,d=new e;let h,p;const u=new he;return function(){return null!==n.object&&null!==n.object.parent&&(t.multiplyMatrices(n.scene.camera.matrixWorldInverse,n.object.parent.matrixWorld),a.set(0,0,0),r.set(l.x,l.y,1),s.set(c.x,c.y,1),o.copy(t).invert(),a.applyMatrix4(o),r.applyMatrix4(o),s.applyMatrix4(o),r.sub(a).normalize(),s.sub(a).normalize(),void 0!==n.scene.internalData.is3D&&!1===n.scene.internalData.is3D?(d.set(0,0,1),h=r.x*s.y-r.y*s.x,h<0&&(d.negate(),h=-h)):(d.crossVectors(r,s),h=d.length()),!(h<1e-5)&&(p=Math.abs(h)<1?2*Math.sin(h):Math.PI,r.dot(s)<0&&(p+=.5*Math.PI),u.setFromAxisAngle(d.normalize(),p),n.object.quaternion.premultiply(u),n.quaternion.copy(n.object.quaternion),!0))}}(),w=function(){const t=new i,a=new O,r=new e,s=new i,o=new O,l=new O,c=new e,p=new e,u=new e;return function(){return null!==n.object&&null!==n.object.parent&&(t.multiplyMatrices(n.scene.camera.matrixWorldInverse,n.object.parent.matrixWorld),t.premultiply(n.scene.camera.projectionMatrix),a.set(0,0,0,1).applyMatrix4(t),r.set(a.x/a.w,a.y/a.w,a.z/a.w),s.copy(t).invert(),o.set(d.x,d.y,r.z,1),l.set(h.x,h.y,r.z,1),o.applyMatrix4(s),l.applyMatrix4(s),c.set(o.x/o.w,o.y/o.w,o.z/o.w),p.set(l.x/l.w,l.y/l.w,l.z/l.w),u.subVectors(p,c),n.object.position.add(u),n.position.copy(n.object.position),!0)}}();function x(e){return null!==n.object&&(n.object.scale.multiplyScalar(e),n.scale.copy(n.object.scale),!0)}const S=function(){const t=new i,a=new i,r=new O,s=new O,o=new e,l=new e;return function(e,i,c){return null!==n.object&&null!==n.object.parent&&(t.multiplyMatrices(n.scene.camera.matrixWorldInverse,n.object.parent.matrixWorld),t.premultiply(n.scene.camera.projectionMatrix),r.set(0,0,0,1).applyMatrix4(t),a.copy(t).invert(),s.set(i,c,r.z/r.w,1).applyMatrix4(a),o.set(s.x/s.w,s.y/s.w,s.z/s.w),o.sub(n.object.position),l.copy(o).multiplyScalar(e).add(o.negate()),n.object.scale.multiplyScalar(e),n.object.position.sub(l),n.scale.copy(n.object.scale),n.position.copy(n.object.position),!0)}}();function k(e){l.set(g(e.clientX),y(e.clientY))}function C(e){p.set(g(e.clientX),y(e.clientY))}function E(e){d.set(g(e.clientX),y(e.clientY))}function _(e){x(e.deltaY>0?1/1.05:1.05)&&n.dispatchEvent(Mt)}function T(e){const t=e.deltaY>0?1/1.05:1.05;S(t,g(e.clientX),y(e.clientY))&&n.dispatchEvent(Mt)}function L(){if(1===m.length)l.set(g(m[0].clientX),y(m[0].clientY));else{const e=.5*(m[0].clientX+m[1].clientX),t=.5*(m[0].clientY+m[1].clientY);l.set(g(e),y(t))}}function P(){if(1===m.length)d.set(g(m[0].clientX),y(m[0].clientY));else{const e=.5*(m[0].clientX+m[1].clientX),t=.5*(m[0].clientY+m[1].clientY);d.set(g(e),y(t))}}function M(){const e=Math.abs(m[0].clientX-m[1].clientX),t=Math.abs(m[0].clientY-m[1].clientY);p.set(g(e),y(t))}function A(e){if(1==m.length)c.set(g(e.clientX),y(e.clientY));else{const t=B(e),i=.5*(e.clientX+t.x),n=.5*(e.clientY+t.y);c.set(g(i),y(n))}b()&&n.dispatchEvent(Mt),l.copy(c)}function R(e){if(1===m.length)h.set(g(e.clientX),y(e.clientY));else{const t=B(e),i=.5*(e.clientX+t.x),n=.5*(e.clientY+t.y);h.set(g(i),y(n))}w()&&n.dispatchEvent(Mt),d.copy(h)}function I(e){const t=B(e);let i=Math.abs(e.clientX-t.x),a=Math.abs(e.clientY-t.y);f.set(g(i),y(a)),i=f.x-p.x,a=f.y-p.y;const r=Math.abs(i)>Math.abs(a)?i:a;let s;s=r<0?1+.5*r:1/(1-.5*r),x(s)&&n.dispatchEvent(Mt),p.copy(f)}function D(e){!1!==n.enabled&&(0===m.length&&(n.domElement.setPointerCapture(e.pointerId),n.domElement.addEventListener("pointermove",N),n.domElement.addEventListener("pointerup",F)),function(e){m.push(e)}(e),"touch"===e.pointerType?function(e){switch(U(e),m.length){case 1:switch(n.touches.ONE){case de.ROTATE:if(!1===n.enableRotate)return;L(),r=a.TOUCH_ROTATE;break;case de.PAN:if(!1===n.enablePan)return;P(),r=a.TOUCH_PAN;break;default:r=a.NONE}break;case 2:switch(n.touches.TWO){case de.DOLLY_PAN:if(!1===n.enableZoom&&!1===n.enablePan)return;n.enableZoom&&M(),n.enablePan&&P(),r=a.TOUCH_DOLLY_PAN;break;case de.DOLLY_ROTATE:if(!1===n.enableZoom&&!1===n.enableRotate)return;n.enableZoom&&M(),n.enableRotate&&L(),r=a.TOUCH_DOLLY_ROTATE;break;default:r=a.NONE}break;default:r=a.NONE}r!==a.NONE&&n.dispatchEvent(jt)}(e):function(e){e.preventDefault();var t=0;t+=e.shiftKey?1:0,t+=e.ctrlKey?2:0,t+=e.metaKey?4:0;let i=0;switch(e.button){case 0:i=1;break;case 1:i=2;break;case 2:i=4}for(var s=0,l=o.length;s<l;s++)if(t===o[s].modifiers&&i&o[s].buttons){switch(o[s].param){case 0:case"ROTATE":if(!1===n.enableRotate)continue;k(e),r=a.ROTATE,n.domElement.ownerDocument.body.style.cursor="move";break;case 1:case"SCALE":if(!1===n.enableZoom)continue;C(e),r=a.DOLLY,n.domElement.ownerDocument.body.style.cursor="ne-resize";break;case 2:case"TRANSLATE":if(!1===n.enablePan)continue;E(e),r=a.PAN,n.domElement.ownerDocument.body.style.cursor="move";break;default:r=a.NONE}r!==a.NONE&&n.dispatchEvent(jt);break}}(e))}function N(e){!1!==n.enabled&&("touch"===e.pointerType?function(e){switch(U(e),r){case a.TOUCH_ROTATE:if(!1===n.enableRotate)return;A(e);break;case a.TOUCH_PAN:if(!1===n.enablePan)return;R(e);break;case a.TOUCH_DOLLY_PAN:if(!1===n.enableZoom&&!1===n.enablePan)return;!function(e){n.enableZoom&&I(e),n.enablePan&&R(e)}(e);break;case a.TOUCH_DOLLY_ROTATE:if(!1===n.enableZoom&&!1===n.enableRotate)return;!function(e){n.enableZoom&&I(e),n.enableRotate&&A(e)}(e);break;default:r=a.NONE}}(e):function(e){if(!1===n.enabled)return;switch(e.preventDefault(),r){case a.ROTATE:if(!1===n.enableRotate)return;!function(e){c.set(g(e.clientX),y(e.clientY)),b()&&n.dispatchEvent(Mt),l.copy(c)}(e);break;case a.DOLLY:if(!1===n.enableZoom)return;!function(e){f.set(g(e.clientX),y(e.clientY));const t=f.x-p.x,i=f.y-p.y,a=Math.abs(t)>Math.abs(i)?t:i;let r;r=a>0?1+.5*a:1/(1-.5*a),x(r)&&n.dispatchEvent(Mt),p.copy(f)}(e);break;case a.PAN:if(!1===n.enablePan)return;!function(e){h.set(g(e.clientX),y(e.clientY)),w()&&n.dispatchEvent(Mt),d.copy(h)}(e)}}(e))}function F(e){G(e),0===m.length&&(n.domElement.releasePointerCapture(e.pointerId),n.domElement.removeEventListener("pointermove",N),n.domElement.removeEventListener("pointerup",F)),n.domElement.ownerDocument.body.style.cursor="default",n.dispatchEvent(At),r=a.NONE}function z(e){G(e)}function H(e){if(!1!==n.enabled&&!1!==n.enableZoom&&r===a.NONE){var t=0;t+=e.shiftKey?1:0,t+=e.ctrlKey?2:0,t+=e.metaKey?4:0;for(var i=0,o=s.length;i<o;i++)if(t===s[i].modifiers){switch(e.preventDefault(),s[i].param){case 0:case"ZOOM":n.dispatchEvent(jt),_(e),n.dispatchEvent(At);break;case 1:case"ZOOM_AT_POINTER":n.dispatchEvent(jt),T(e),n.dispatchEvent(At)}return}}}function W(e){!1!==n.enabled&&!1!==n.enablePan&&function(e){let t=!1;switch(d.set(0,0),h.set(0,0),e.code){case n.keys.UP:h.y=n.keyPanSpeed/(n.scene.height/2),t=!0;break;case n.keys.BOTTOM:h.y=-n.keyPanSpeed/(n.scene.height/2),t=!0;break;case n.keys.LEFT:h.x=-n.keyPanSpeed/(n.scene.width/2),t=!0;break;case n.keys.RIGHT:h.x=n.keyPanSpeed/(n.scene.width/2),t=!0}let i=!1;t&&(i=w(),e.preventDefault()),i&&n.dispatchEvent(Mt)}(e)}function Y(e){!1!==n.enabled&&e.preventDefault()}function G(e){delete v[e.pointerId];for(let t=0;t<m.length;t++)if(m[t].pointerId==e.pointerId)return void m.splice(t,1)}function U(e){let t=v[e.pointerId];void 0===t&&(t=new u,v[e.pointerId]=t),t.set(e.clientX,e.clientY)}function B(e){const t=e.pointerId===m[0].pointerId?m[1]:m[0];return v[t.pointerId]}n.domElement.addEventListener("contextmenu",Y),n.domElement.addEventListener("pointerdown",D),n.domElement.addEventListener("pointercancel",z),n.domElement.addEventListener("wheel",H,{passive:!1}),n.listenToKeyEvents(window)}}Rt.prototype.isTransformInteractor=!0;const It={type:"change"},Dt={type:"zoom"},Nt={type:"start"},Ft={type:"end"};class zt extends ce{constructor(t){super(),void 0===t&&console.warn('AVS.Three.PanInteractor: The first parameter "domElement" is now mandatory.'),t===document&&console.error('AVS.Three.PanInteractor: "document" should not be used as the target "domElement". Please use "renderer.domElement" instead.'),this.domElement=t,this.domElement.style.touchAction="none",this.object=new j,this.linkObjectsBottom=[],this.linkObjectsTop=[],this.linkObjectsLeft=[],this.linkObjectsRight=[],this.linkObjectsBottomStatic=[],this.linkObjectsTopStatic=[],this.linkObjectsLeftStatic=[],this.linkObjectsRightStatic=[],this.leftLimit=0,this.rightLimit=0,this.topLimit=0,this.bottomLimit=0,this.widthZoomLevel=100,this.heightZoomLevel=100,this.domElement=t,this.enabled=!0,this.target=new e,this.enableZoom=!0,this.zoomSpeed=2,this.enableRotate=!1,this.rotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!0,this.keyPanSpeed=7,this.enableKeys=!0,this.keys={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"},this.mouseButtons={LEFT:pe.PAN,MIDDLE:pe.NONE,RIGHT:pe.NONE},this.touches={ONE:de.PAN,TWO:de.NONE},this._domElementKeyEvents=null,this.listenToKeyEvents=function(e){e.addEventListener("keydown",Y),this._domElementKeyEvents=e},this.saveState=function(){i.target0.copy(i.target),i.position0.copy(i.object.position),i.zoom0=i.object.zoom},this.reset=function(){i.target.copy(i.target0),i.object.position.copy(i.position0),i.object.zoom=i.zoom0,i.object.updateProjectionMatrix(),i.dispatchEvent(It),i.update(),a=n.NONE},this.update=function(e=!0){if(void 0!==i.object&&void 0!==i.object.landscapeDiv){i.object.panOffsetX=s.x,i.object.panOffsetY=s.y,i.object.landscapeDiv.style.left=i.object.baseLeft+s.x+"px",i.object.landscapeDiv.style.top=i.object.baseTop+s.y+"px";for(let e=0,t=i.linkObjectsBottom.length;e<t;e++){const t=i.linkObjectsBottom[e];t.panOffsetX=s.x,t.landscapeDiv.style.left=t.baseLeft+s.x+"px"}for(let e=0,t=i.linkObjectsBottomStatic.length;e<t;e++){i.linkObjectsBottomStatic[e].traverse((function(e){e.isBillboardText&&(e.panOffsetX=-s.x,e.moveText())}))}for(let e=0,t=i.linkObjectsTop.length;e<t;e++){const t=i.linkObjectsTop[e];t.panOffsetX=s.x,t.landscapeDiv.style.left=t.baseLeft+s.x+"px"}for(let e=0,t=i.linkObjectsTopStatic.length;e<t;e++){i.linkObjectsTopStatic[e].traverse((function(e){e.isBillboardText&&(e.panOffsetX=-s.x,e.moveText())}))}for(let e=0,t=i.linkObjectsLeft.length;e<t;e++){const t=i.linkObjectsLeft[e];t.panOffsetY=s.y,t.landscapeDiv.style.top=t.baseTop+s.y+"px"}for(let e=0,t=i.linkObjectsLeftStatic.length;e<t;e++){i.linkObjectsLeftStatic[e].traverse((function(e){e.isBillboardText&&(e.panOffsetY=-s.y,e.moveText())}))}for(let e=0,t=i.linkObjectsRight.length;e<t;e++){const t=i.linkObjectsRight[e];t.panOffsetY=s.y,t.landscapeDiv.style.top=t.baseTop+s.y+"px"}for(let e=0,t=i.linkObjectsRightStatic.length;e<t;e++){i.linkObjectsRightStatic[e].traverse((function(e){e.isBillboardText&&(e.panOffsetY=-s.y,e.moveText())}))}e&&i.dispatchEvent(It)}},this.restorePanOffset=function(e){f.x<0||(s.x=f.x-e.zoomOffsetLeft-Math.floor(e.centerWidth*m.x),s.y=f.y-e.zoomOffsetTop-Math.floor(e.centerHeight*m.y),k(),i.update(!1))},this.clear=function(){this.linkObjectsBottom=[],this.linkObjectsTop=[],this.linkObjectsLeft=[],this.linkObjectsRight=[],this.linkObjectsBottomStatic=[],this.linkObjectsTopStatic=[],this.linkObjectsLeftStatic=[],this.linkObjectsRightStatic=[]},this.dispose=function(){i.domElement.removeEventListener("contextmenu",G),i.domElement.removeEventListener("pointerdown",N),i.domElement.removeEventListener("pointercancel",H),i.domElement.removeEventListener("wheel",W),i.domElement.removeEventListener("pointermove",F),i.domElement.removeEventListener("pointerup",z),null!==i._domElementKeyEvents&&i._domElementKeyEvents.removeEventListener("keydown",Y)};const i=this,n={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6};let a=n.NONE;const r=new ue,s=new e,o=new u,l=new u,c=new u,d=new u,h=new u,p=new u,f=new u(-1,-1),m=new u,v=new u,g=new u,y=new u,b=[],w={};function x(){return Math.pow(.95,i.zoomSpeed)}function S(e){r.theta-=e}function O(e){r.phi-=e}function k(){s.x>i.leftLimit?s.x=i.leftLimit:s.x<i.rightLimit&&(s.x=i.rightLimit),s.y<i.bottomLimit?s.y=i.bottomLimit:s.y>i.topLimit&&(s.y=i.topLimit)}function C(e,t){var i;i=e,s.x+=i,function(e,t){s.y+=e}(t),k()}function E(e){const t=i.widthZoomLevel*e,n=i.heightZoomLevel*e;t<100||n<100?(i.widthZoomLevel=100,i.heightZoomLevel=100):(i.widthZoomLevel=t,i.heightZoomLevel=n)}function _(e){i.widthZoomLevel/=e,i.heightZoomLevel/=e}function T(e){o.set(e.clientX,e.clientY)}function L(e){d.set(e.clientX,e.clientY)}function P(){if(1===b.length)o.set(b[0].pageX,b[0].pageY);else{const e=.5*(b[0].pageX+b[1].pageX),t=.5*(b[0].pageY+b[1].pageY);o.set(e,t)}}function M(){if(1===b.length)d.set(b[0].pageX,b[0].pageY);else{const e=.5*(b[0].pageX+b[1].pageX),t=.5*(b[0].pageY+b[1].pageY);d.set(e,t)}}function A(){const e=b[0].pageX-b[1].pageX,t=b[0].pageY-b[1].pageY,i=Math.sqrt(e*e+t*t);v.set(0,i)}function R(e){if(1==b.length)l.set(e.pageX,e.pageY);else{const t=X(e),i=.5*(e.pageX+t.x),n=.5*(e.pageY+t.y);l.set(i,n)}c.subVectors(l,o).multiplyScalar(i.rotateSpeed);const t=i.domElement;S(2*Math.PI*c.x/t.clientHeight),O(2*Math.PI*c.y/t.clientHeight),o.copy(l)}function I(e){if(1===b.length)h.set(e.pageX,e.pageY);else{const t=X(e),i=.5*(e.pageX+t.x),n=.5*(e.pageY+t.y);h.set(i,n)}p.subVectors(h,d).multiplyScalar(i.panSpeed),C(p.x,p.y),d.copy(h)}function D(e){const t=X(e),n=e.pageX-t.x,a=e.pageY-t.y,r=Math.sqrt(n*n+a*a);g.set(0,r),y.set(0,Math.pow(g.y/v.y,i.zoomSpeed)),E(y.y),v.copy(g)}function N(e){!1!==i.enabled&&(0===b.length&&(i.domElement.setPointerCapture(e.pointerId),i.domElement.addEventListener("pointermove",F),i.domElement.addEventListener("pointerup",z)),function(e){b.push(e)}(e),"touch"===e.pointerType?function(e){switch(B(e),b.length){case 1:switch(i.touches.ONE){case de.ROTATE:if(!1===i.enableRotate)return;P(),a=n.TOUCH_ROTATE;break;case de.PAN:if(!1===i.enablePan)return;M(),a=n.TOUCH_PAN;break;default:a=n.NONE}break;case 2:switch(i.touches.TWO){case de.DOLLY_PAN:if(!1===i.enableZoom&&!1===i.enablePan)return;i.enableZoom&&A(),i.enablePan&&M(),a=n.TOUCH_DOLLY_PAN;break;case de.DOLLY_ROTATE:if(!1===i.enableZoom&&!1===i.enableRotate)return;i.enableZoom&&A(),i.enableRotate&&P(),a=n.TOUCH_DOLLY_ROTATE;break;default:a=n.NONE}break;default:a=n.NONE}a!==n.NONE&&i.dispatchEvent(Nt)}(e):function(e){let t;switch(e.preventDefault(),e.button){case 0:t=i.mouseButtons.LEFT;break;case 1:t=i.mouseButtons.MIDDLE;break;case 2:t=i.mouseButtons.RIGHT;break;default:t=-1}switch(t){case pe.DOLLY:if(!1===i.enableZoom)return;!function(e){v.set(e.clientX,e.clientY)}(e),a=n.DOLLY;break;case pe.ROTATE:if(e.ctrlKey||e.metaKey||e.shiftKey){if(!1===i.enablePan)return;L(e),a=n.PAN}else{if(!1===i.enableRotate)return;T(e),a=n.ROTATE}break;case pe.PAN:if(e.ctrlKey||e.metaKey||e.shiftKey){if(!1===i.enableRotate)return;T(e),a=n.ROTATE}else{if(!1===i.enablePan)return;L(e),a=n.PAN,i.domElement.ownerDocument.body.style.cursor="move"}break;default:a=n.NONE}a!==n.NONE&&i.dispatchEvent(Nt)}(e))}function F(e){!1!==i.enabled&&("touch"===e.pointerType?function(e){switch(B(e),a){case n.TOUCH_ROTATE:if(!1===i.enableRotate)return;R(e),i.update();break;case n.TOUCH_PAN:if(!1===i.enablePan)return;I(e),i.update();break;case n.TOUCH_DOLLY_PAN:if(!1===i.enableZoom&&!1===i.enablePan)return;!function(e){i.enableZoom&&D(e),i.enablePan&&I(e)}(e),i.update();break;case n.TOUCH_DOLLY_ROTATE:if(!1===i.enableZoom&&!1===i.enableRotate)return;!function(e){i.enableZoom&&D(e),i.enableRotate&&R(e)}(e),i.update();break;default:a=n.NONE}}(e):function(e){if(!1===i.enabled)return;switch(e.preventDefault(),a){case n.ROTATE:if(!1===i.enableRotate)return;!function(e){l.set(e.clientX,e.clientY),c.subVectors(l,o).multiplyScalar(i.rotateSpeed);const t=i.domElement;S(2*Math.PI*c.x/t.clientHeight),O(2*Math.PI*c.y/t.clientHeight),o.copy(l),i.update()}(e);break;case n.DOLLY:if(!1===i.enableZoom)return;!function(e){g.set(e.clientX,e.clientY),y.subVectors(g,v),y.y>0?E(x()):y.y<0&&_(x()),v.copy(g),i.update()}(e);break;case n.PAN:if(!1===i.enablePan)return;!function(e){h.set(e.clientX,e.clientY),p.subVectors(h,d).multiplyScalar(i.panSpeed),C(p.x,p.y),d.copy(h),i.update()}(e)}}(e))}function z(e){U(e),0===b.length&&(i.domElement.releasePointerCapture(e.pointerId),i.domElement.removeEventListener("pointermove",F),i.domElement.removeEventListener("pointerup",z)),i.domElement.ownerDocument.body.style.cursor="default",i.dispatchEvent(Ft),a=n.NONE}function H(e){U(e)}function W(e){!1!==i.enabled&&!1!==i.enableZoom&&a===n.NONE&&(e.preventDefault(),i.dispatchEvent(Nt),function(e){e.deltaY<0?_(x()):e.deltaY>0&&E(x());const t=i.domElement.getBoundingClientRect();f.x=Math.round(e.clientX-t.left),f.y=Math.round(e.clientY-t.top),f.x<i.object.windowX?f.x=i.object.windowX:f.x>i.object.windowX+i.object.windowWidth&&(f.x=i.object.windowX+i.object.windowWidth),f.y<i.object.windowTop?f.y=i.object.windowTop:f.y>i.object.windowTop+i.object.windowHeight&&(f.y=i.object.windowTop+i.object.windowHeight),m.x=(f.x-i.object.panOffsetX-i.object.zoomOffsetLeft)/i.object.centerWidth,m.y=(f.y-i.object.panOffsetY-i.object.zoomOffsetTop)/i.object.centerHeight,i.dispatchEvent(Dt)}(e),i.dispatchEvent(Ft))}function Y(e){!1!==i.enabled&&!1!==i.enablePan&&function(e){let t=!1;switch(e.code){case i.keys.UP:C(0,i.keyPanSpeed),t=!0;break;case i.keys.BOTTOM:C(0,-i.keyPanSpeed),t=!0;break;case i.keys.LEFT:C(i.keyPanSpeed,0),t=!0;break;case i.keys.RIGHT:C(-i.keyPanSpeed,0),t=!0}t&&(e.preventDefault(),i.update())}(e)}function G(e){!1!==i.enabled&&e.preventDefault()}function U(e){delete w[e.pointerId];for(let t=0;t<b.length;t++)if(b[t].pointerId==e.pointerId)return void b.splice(t,1)}function B(e){let t=w[e.pointerId];void 0===t&&(t=new u,w[e.pointerId]=t),t.set(e.pageX,e.pageY)}function X(e){const t=e.pointerId===b[0].pointerId?b[1]:b[0];return w[t.pointerId]}i.domElement.addEventListener("contextmenu",G),i.domElement.addEventListener("pointerdown",N),i.domElement.addEventListener("pointercancel",H),i.domElement.addEventListener("wheel",W,{passive:!1}),i.listenToKeyEvents(window)}}zt.prototype.isPanInteractor=!0;const Ht={type:"change"},Wt={type:"start"},Yt={type:"end"};class Gt extends ce{constructor(t){super(),void 0===t&&console.warn('AVS.Three.ZoomRectangleInteractor: The first parameter "domElement" is now mandatory.'),t===document&&console.error('AVS.Three.ZoomRectangleInteractor: "document" should not be used as the target "domElement". Please use "renderer.domElement" instead.'),this.domElement=t,this.domElement.style.touchAction="none",this.object=new j,this.scene=null,this.enabled=!0,this.position=this.object.position.clone(),this.scale=this.object.scale.clone(),this.clientOnly=!1,this.fullReset=!1,this.scale0=this.object.scale.clone(),this.position0=this.object.position.clone(),this.setObjectScene=function(e,t){switch(n.object=e,n.scene=t,this.fullReset||e.internalData.zoomRectangleFullReset?(n.scale.copy(n.object.scale),n.position.copy(n.object.position),n.scale0.copy(n.object.scale),n.position0.copy(n.object.position),this.fullReset=!1):n.clientOnly&&(n.object.scale.copy(n.scale),n.object.position.copy(n.position)),e.internalData.zoomRectangleTriggers&&(l=JSON.parse(e.internalData.zoomRectangleTriggers)),r=e.internalData.zoomInMaxLimit,s=e.internalData.zoomOutMaxLimit,h=void 0!==e.internalData.zoomRectangleColor?"#"+e.internalData.zoomRectangleColor.toString(16).padStart(6,"0"):null,p=e.internalData.zoomRectangleWidth?e.internalData.zoomRectangleWidth:null,e.internalData.zoomRectanglePattern){case 0:f=[];break;case 1:f=[4,4];break;case 2:f=[1,3];break;case 3:f=[5,1,1,1];break;default:f=null}const i=document.createElement("canvas");i.style.position="absolute",i.style.width="100%",i.style.height="100%",i.id=n.scene.name+"RectCanvas",i.width=n.scene.windowWidth,i.height=n.scene.windowHeight,n.scene.windowDiv.appendChild(i),n.scene.rectCanvas=i,n.scene.rectCtx=i.getContext("2d")},this.reset=function(){n.scale.copy(n.scale0),n.position.copy(n.position0),n.object.scale.copy(n.scale0),n.object.position.copy(n.position0),n.dispatchEvent(Ht),o=a.NONE},this.dispose=function(){n.domElement.removeEventListener("contextmenu",T),n.domElement.removeEventListener("pointerdown",k),n.domElement.removeEventListener("pointercancel",_),n.domElement.removeEventListener("pointermove",C),n.domElement.removeEventListener("pointerup",E)};const n=this,a={NONE:-1,ZOOM_IN:0,ZOOM_OUT:1};let r,s,o=a.NONE,l=[{buttons:1,modifiers:0,param:"ZOOM_IN"},{buttons:1,modifiers:1,param:"ZOOM_OUT"}],c=0;const d=[];let h=null,p=null,f=null;const m=new u,v=new u,g=[],y={};function b(e){return Math.max(0,Math.min(e.clientX-n.scene.windowDiv.getBoundingClientRect().left,n.scene.windowWidth))}function w(e){return Math.max(0,Math.min(e.clientY-n.scene.windowDiv.getBoundingClientRect().top,n.scene.windowHeight))}const x=function(){const t=new i,l=new i,c=new O,d=new O,h=new e,p=new O,u=new e;return function(e,i,f,m){const v=n.scene.windowWidth/(i-e),g=n.scene.windowHeight/(m-f);t.multiplyMatrices(n.scene.camera.matrixWorldInverse,n.object.parent.matrixWorld),t.premultiply(n.scene.camera.projectionMatrix),c.set(0,0,0,1).applyMatrix4(t),l.copy(t).invert();let y=1;if(o===a.ZOOM_IN){if(y=g<v?g:v,void 0!==r){const e=Math.max(Math.max(n.object.scale.x,n.object.scale.y),n.object.scale.z);y*e>r&&(y=r/e)}const t=(e+i)/n.scene.windowWidth-1,a=1-(f+m)/n.scene.windowHeight;d.set(t,a,c.z/c.w,1).applyMatrix4(l),h.set(d.x/d.w,d.y/d.w,d.z/d.w),p.set(0,0,c.z/c.w,1).applyMatrix4(l),u.set(p.x/p.w,p.y/p.w,p.z/p.w),h.sub(n.object.position),u.sub(n.object.position),h.multiplyScalar(y).sub(u),n.object.position.sub(h)}else if(o===a.ZOOM_OUT){if(y=g>v?1/g:1/v,void 0!==s){const e=Math.max(Math.max(n.object.scale.x,n.object.scale.y),n.object.scale.z);y*e<1/s&&(y=1/s/e)}d.set(0,0,c.z/c.w,1).applyMatrix4(l),h.set(d.x/d.w,d.y/d.w,d.z/d.w),h.sub(n.object.position),u.copy(h),h.multiplyScalar(y).sub(u),n.object.position.sub(h)}return n.object.scale.multiplyScalar(y),!0}}();function S(e){m.set(b(e),w(e));const t=window.getComputedStyle(n.scene.rectCanvas);let i="#ff0000";const a=t.getPropertyValue("--avs-drag-rectangle-stroke-style").trim();null!==h?i=h:null!==a&&a.length>0&&(i=a),n.scene.rectCtx.strokeStyle=i;let r=1;const s=t.getPropertyValue("--avs-drag-rectangle-line-width").trim();null!==p?r=p:null!==s&&s.length>0&&(r=s),n.scene.rectCtx.lineWidth=r;let o=d;const l=t.getPropertyValue("--avs-drag-rectangle-line-dash").trim();null!==f?o=f:null!==l&&l.length>0&&(o=JSON.parse(l)),n.scene.rectCtx.setLineDash(o),c=1}function k(e){!1!==n.enabled&&(0===g.length&&(n.domElement.setPointerCapture(e.pointerId),n.domElement.addEventListener("pointermove",C),n.domElement.addEventListener("pointerup",E)),function(e){g.push(e)}(e),function(e){let t=0;t+=e.shiftKey?1:0,t+=e.ctrlKey?2:0,t+=e.metaKey?4:0;let i=0;switch(e.button){case 0:i=1;break;case 1:i=2;break;case 2:i=4}for(let r=0,s=l.length;r<s;r++)if(t===l[r].modifiers&&i&l[r].buttons){switch(l[r].param){case 1:case"ZOOM_IN":S(e),o=a.ZOOM_IN,n.domElement.ownerDocument.body.style.cursor="zoom-in";break;case 2:case"ZOOM_OUT":S(e),o=a.ZOOM_OUT,n.domElement.ownerDocument.body.style.cursor="zoom-out";break;default:o=a.NONE}o!==a.NONE&&n.dispatchEvent(Wt);break}}(e))}function C(e){!1!==n.enabled&&function(e){if(!1===n.enabled)return;!function(e){if(c<1)return;if(v.set(b(e),w(e)),n.scene.rectCtx.clearRect(0,0,n.scene.windowWidth,n.scene.windowHeight),1==c){const e=Math.abs(m.x-v.x),t=Math.abs(m.y-v.y);if(e*e+t*t<25)return;c=2}const t=Math.min(m.x,v.x),i=Math.max(m.x,v.x),a=Math.min(m.y,v.y),r=Math.max(m.y,v.y);n.scene.rectCtx.strokeRect(t+.5,a+.5,i-t,r-a)}(e)}(e)}function E(e){!1!==n.enabled&&(!function(e){(function(e){if(c<2)return;v.set(b(e),w(e)),n.scene.rectCtx.clearRect(0,0,n.scene.windowWidth,n.scene.windowHeight);const t=Math.min(m.x,v.x),i=Math.max(m.x,v.x),a=Math.min(m.y,v.y),r=Math.max(m.y,v.y);x(t,i,a,r)&&(n.scale.copy(n.object.scale),n.position.copy(n.object.position),n.dispatchEvent(Ht)),c=0})(e),n.domElement.ownerDocument.body.style.cursor="default",n.dispatchEvent(Yt),o=a.NONE}(e),L(e),0===g.length&&(n.domElement.releasePointerCapture(e.pointerId),n.domElement.removeEventListener("pointermove",C),n.domElement.removeEventListener("pointerup",E)))}function _(e){L(e)}function T(e){!1!==n.enabled&&e.preventDefault()}function L(e){delete y[e.pointerId];for(let t=0;t<g.length;t++)if(g[t].pointerId==e.pointerId)return void g.splice(t,1)}n.domElement.addEventListener("contextmenu",T),n.domElement.addEventListener("pointerdown",k),n.domElement.addEventListener("pointercancel",_)}}Gt.prototype.isZoomRectangleInteractor=!0;const Ut={type:"change"},Bt={type:"start"},Xt={type:"end"};class Zt extends ce{constructor(e){super(),this.hasStyleAnimations=!1,this.hasObjectAnimations=!1,this.createAnimationLibrary(),this.createStyleAnimationClips(e),this.clock=new fe,this.animating=0,this.mixers=[]}createAnimationLibrary(){const e=[0,2],t=new me(".material.opacityFactor",e,[0,1]),i=new ve(".material.transparent",e,[!0,!1]);this.fadeInClip=new ge("fade-in",-1,[t,i]),this.fadeInClip.setOnChildren=!0;const n=new me(".material.opacityFactor",e,[1,0]),a=new ve(".material.transparent",e,[!0,!0]);this.fadeOutClip=new ge("fade-out",-1,[n,a]),this.fadeOutClip.setOnChildren=!0;const r=new me(".scaleFactorX",e,[0,1]);this.growXClip=new ge("grow-x",-1,[r]);const s=new me(".scaleFactorY",e,[0,1]);this.growYClip=new ge("grow-y",-1,[s]);const o=new me(".scaleFactorZ",e,[0,1]);this.growZClip=new ge("grow-z",-1,[o]);const l=new me(".material.scaleFactorX",e,[0,1]);this.growXGlyphClip=new ge("grow-x-glyph",-1,[l]),this.growXGlyphClip.setOnChildren=!0;const c=new me(".material.scaleFactorY",e,[0,1]);this.growYGlyphClip=new ge("grow-y-glyph",-1,[c]),this.growYGlyphClip.setOnChildren=!0;const d=new me(".material.scaleFactorZ",e,[0,1]);this.growZGlyphClip=new ge("grow-z-glyph",-1,[d]),this.growZGlyphClip.setOnChildren=!0;const h=new ve(".visible",e,[!1,!0]);this.enterAfterClip=new ge("enter-after",-1,[h]),this.enterAfterClip.setOnChildren=!0}createStyleAnimationClips(e){if(void 0===e)return;const t=["scene","sceneTitle","chart","chartTitle","axis","legend","legendTitle","glyph"];this.styleAnimationClips={};for(let i=0,n=t.length;i<n;i++){const n=t[i];void 0!==e[n]&&(this.styleAnimationClips[n]=this.fillStyleClipsArray(e[n].split(","),"glyph"===n))}}fillStyleClipsArray(e,t){const i=[];for(let n=0,a=e.length;n<a;n++){const a=e[n].trim();"fade-in"===a?(i.push(this.fadeInClip),this.hasStyleAnimations=!0):"fade-out"===a?(i.push(this.fadeOutClip),this.hasStyleAnimations=!0):"grow-x"===a?(i.push(t?this.growXGlyphClip:this.growXClip),this.hasStyleAnimations=!0):"grow-y"===a?(i.push(t?this.growYGlyphClip:this.growYClip),this.hasStyleAnimations=!0):"grow-z"===a?(i.push(t?this.growZGlyphClip:this.growZClip),this.hasStyleAnimations=!0):"enter-after"===a&&(i.push(this.enterAfterClip),this.hasStyleAnimations=!0)}return i}fillObjectClipsArray(e,t){const i=[];return 0!=(1&e)&&(i.push(this.fadeInClip),this.hasObjectAnimations=!0),0!=(2&e)&&(i.push(this.fadeOutClip),this.hasObjectAnimations=!0),0!=(4&e)&&(i.push(t?this.growXGlyphClip:this.growXClip),this.hasObjectAnimations=!0),0!=(8&e)&&(i.push(t?this.growYGlyphClip:this.growYClip),this.hasObjectAnimations=!0),0!=(16&e)&&(i.push(t?this.growZGlyphClip:this.growZClip),this.hasObjectAnimations=!0),0!=(32&e)&&(i.push(this.enterAfterClip),this.hasObjectAnimations=!0),i}hasAnimations(){return this.hasStyleAnimations||this.hasObjectAnimations}clear(){this.mixers=[],this.hasObjectAnimations=!1}attach(e){const t=this,i=this.createMixers.bind(this);this.createMixers(e,this.styleAnimationClips.scene),e.traverse((function(e){if(e.internalData.animations){const n=t.fillObjectClipsArray(e.internalData.animations,"GLYPH"===e.internalData.visualizationGroup);i(e,n)}else"SCENE_TITLE"===e.internalData.visualizationGroup?i(e,t.styleAnimationClips.sceneTitle):"CHART"===e.internalData.visualizationGroup?i(e,t.styleAnimationClips.chart):"CHART_TITLE"===e.internalData.visualizationGroup?i(e,t.styleAnimationClips.chartTitle):"AXIS"===e.internalData.visualizationGroup?i(e,t.styleAnimationClips.axis):"LEGEND"===e.internalData.visualizationGroup?i(e,t.styleAnimationClips.legend):"LEGEND_TITLE"===e.internalData.visualizationGroup?i(e,t.styleAnimationClips.legendTitle):"GLYPH"===e.internalData.visualizationGroup&&i(e,t.styleAnimationClips.glyph)}))}createMixers(e,t){if(void 0!==t)for(let i=0,n=t.length;i<n;i++){let n;if(t[i].type,t[i].setOnChildren?e.traverse((function(e){e.material&&(void 0===n&&(n=new ye),n.add(e))})):n=e,void 0!==n){const e=new be(n);e.clip=t[i],this.mixers.push(e)}}}play(){this.mixers.length<=0&&(this.dispatchEvent(Bt),this.dispatchEvent(Ut),this.dispatchEvent(Xt)),this.animating=0,this.finishedFunc=this.animationFinished.bind(this);for(let e=0,t=this.mixers.length;e<t;e++){const t=this.mixers[e];t.addEventListener("finished",this.finishedFunc);const i=t.clipAction(t.clip);t.action=i,i.repetitions=1,i.clampWhenFinished=!0,i.play(),this.animating++}this.dispatchEvent(Bt),this.animate()}animationFinished(e){e.target.removeEventListener("finished",this.finishedFunc),this.animating--}animate(){if(this.animating<=0)return void this.dispatchEvent(Xt);requestAnimationFrame(this.animate.bind(this));const e=this.clock.getDelta();for(let t=0,i=this.mixers.length;t<i;t++)this.mixers[t].action.isRunning()&&this.mixers[t].update(e);this.dispatchEvent(Ut)}}export{Zt as Animator,_e as CellTypeEnum,Se as DEFAULT_VIEWER_HEIGHT,xe as DEFAULT_VIEWER_WIDTH,zt as PanInteractor,ke as PickDepthEnum,Ee as PickLevelEnum,Ce as PickTypeEnum,Oe as RAYCASTER_LINE_PRECISION,we as REVISION,Rt as TransformInteractor,Pt as Viewer,Gt as ZoomRectangleInteractor};
