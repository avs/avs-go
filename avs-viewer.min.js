// Licensed by Advanced Visual Systems Inc. to You under the Apache License, Version 2.0.
class AvsViewer extends Polymer.mixinBehaviors([Polymer.IronResizableBehavior,Polymer.GestureEventListeners],Polymer.Element){static get is(){return"avs-viewer"}static get properties(){return{width:{type:Number},height:{type:Number},sceneProperties:{type:Object},viewerProperties:{type:Object},hoverProperties:{type:Object},pickProperties:{type:Object},streamProperties:{type:Object},transformProperties:{type:Object},defaultLineProperties:{type:Object},defaultTextProperties:{type:Object},resizeThreshold:{type:Object,value:10},initialized:{type:Boolean},viewer:{type:Object},drag:{type:Boolean,value:!1},rect:{type:Object},rectCtx:{type:Object}}}constructor(){super()}rectangleStyle(){this.rectCtx.setLineDash([3]),this.rectCtx.strokeStyle="#ff0000"}drawRect(){this.rectangleStyle(),this.rectCtx.strokeRect(this.rect.startX,this.rect.startY,this.rect.w,this.rect.h)}buildChartRequest(){var a=this;void 0==this.sceneProperties&&(this.sceneProperties={});var b=Object.assign(this.sceneProperties,{width:this.width,height:this.height});if(void 0==this.viewerProperties&&(this.viewerProperties={}),b=Object.assign(b,{viewerProperties:this.viewerProperties}),void 0==this.viewerProperties.backgroundColor){var c=window.getComputedStyle(this,null).getPropertyValue("background-color");b.viewerProperties=Object.assign(b.viewerProperties,{backgroundColor:c})}if(void 0==this.defaultTextProperties&&(this.defaultTextProperties={}),b=Object.assign(b,{defaultTextProperties:this.defaultTextProperties}),void 0==this.defaultTextProperties.color){var d=window.getComputedStyle(this,null).getPropertyValue("color");b.defaultTextProperties=Object.assign(b.defaultTextProperties,{color:d})}if(void 0==this.defaultTextProperties.fontFamily){var e=window.getComputedStyle(this,null).getPropertyValue("font-family");e=e.replace("\"",""),b.defaultTextProperties=Object.assign(b.defaultTextProperties,{fontFamily:e})}return void 0!=this.defaultLineProperties&&(b=Object.assign(b,{defaultLineProperties:this.defaultLineProperties})),void 0!=this.streamProperties&&(this.streamProperties.chunkId=void 0,this.streamProperties.streamUpdate=function(b){console.log("Stream count = "+b),a.viewer.render()},b=Object.assign(b,{streamProperties:this.streamProperties})),b}onResize(){var a=this.$.viewerDiv.getBoundingClientRect();a.width<this.lowResizeWidth||a.width>this.highResizeWidth||a.height<this.lowResizeHeight||a.height>this.highResizeHeight?this.updateViewer():this.updateViewerClient()}updateSize(){var a=this.$.viewerDiv.getBoundingClientRect();if(this.width=a.width,0==this.width&&(this.width=200),0==this.height||void 0==this.height){var b=a.height;this.height=0<b?b:200}"THREEJS"!==this.viewerProperties.renderer&&void 0!=this.pickProperties&&"RECTANGLE"===this.pickProperties.type&&(this.$$("#rectCanvas").width=this.width,this.$$("#rectCanvas").height=this.height),this.lowResizeWidth=(100-this.resizeThreshold)/100*this.width,this.highResizeWidth=(100+this.resizeThreshold)/100*this.width,this.lowResizeHeight=(100-this.resizeThreshold)/100*this.height,this.highResizeHeight=(100+this.resizeThreshold)/100*this.height}updateViewer(){if(this.updateStyles(),this.updateSize(),"THREEJS"===this.viewerProperties.renderer){this.viewer.setSize(this.width,this.height);var a=this,b=this.buildChartRequest();void 0!=this.viewerProperties.backgroundColor&&this.viewer.setBackgroundColor(this.viewerProperties.backgroundColor),this.viewer.loadGeometryAsUrl({url:this.sceneProperties.url,success:function(){a.viewer.render()},jsonRequest:b})}else this.$.getScene.body=this.buildChartRequest(),this.$.getScene.url=this.sceneProperties.url,this.$.getScene.generateRequest()}updateViewerClient(){if("THREEJS"===this.viewerProperties.renderer){var a=this.$.viewerDiv.getBoundingClientRect();this.viewer.setSize(a.width,a.height),this.viewer.render()}}handleResponse(a){if("IMAGE"===this.viewerProperties.renderer){var b=null;try{b=JSON.parse(a.detail.response)}catch(a){return void console.warn("Failed to parse JSON requested from "+this.sceneProperties.url)}if(void 0==b||null==b)return void console.log("Null JSON response");this.$$("#sceneImage").src=b.imageurl,b.imagemap!=void 0,b.selectionInfo!=void 0&&console.log("selection info = "+b.selectionInfo)}else"SVG"===this.viewerProperties.renderer&&(this.$.viewerDiv.innerHTML=a.detail.response)}handleOnMouseDown(a){"THREEJS"!=this.viewerProperties.renderer&&this.pickProperties!=void 0&&"RECTANGLE"===this.pickProperties.type&&this.pickProperties.active&&(this.rect.startX=a.pageX-this.$.viewerDiv.offsetLeft,this.rect.startY=a.pageY-this.$.viewerDiv.offsetTop,this.rect.startEvent=a,this.drag=!0)}handleOnMouseMove(a){"THREEJS"!=this.viewerProperties.renderer&&this.drag&&this.pickProperties!=void 0&&"RECTANGLE"===this.pickProperties.type&&this.pickProperties.active&&(this.rect.w=a.pageX-this.$.viewerDiv.offsetLeft-this.rect.startX,this.rect.h=a.pageY-this.$.viewerDiv.offsetTop-this.rect.startY,this.rectCtx.clearRect(0,0,this.$$("#rectCanvas").width,this.$$("#rectCanvas").height),this.drawRect())}handleOnMouseUp(a){if("THREEJS"!=this.viewerProperties.renderer)if(void 0!=this.pickProperties&&"RECTANGLE"===this.pickProperties.type&&this.pickProperties.active)this.rect.finishX=a.pageX-this.$.viewerDiv.offsetLeft,this.rect.finishY=a.pageY-this.$.viewerDiv.offsetTop,this.drag=!1,this.rectCtx.clearRect(0,0,this.$$("#rectCanvas").width,this.$$("#rectCanvas").height),this.$.getScene.body=this.buildChartRequest(),this.pickProperties.mouseX=[a.offsetX-this.rect.w,a.offsetX],this.pickProperties.mouseY=[a.offsetY-this.rect.h,a.offsetY],console.log("mouse x1 = "+this.pickProperties.mouseX[0]+", "+this.pickProperties.mouseX[1]),console.log("mouse y1 = "+this.pickProperties.mouseY[0]+", "+this.pickProperties.mouseY[1]),this.$.getScene.body=Object.assign(this.$.getScene.body,{pickProperties:this.pickProperties}),this.$.getScene.url=this.sceneProperties.url,this.$.getScene.generateRequest();else if(void 0!==this.pickProperties){this.$.getScene.body=this.buildChartRequest(),this.pickProperties.mouseX=[a.offsetX],this.pickProperties.mouseY=[a.offsetY],this.$.getScene.body=Object.assign(this.$.getScene.body,{pickProperties:this.pickProperties}),this.$.getScene.url=this.sceneProperties.url,this.$.getScene.generateRequest();this.dispatchEvent(new CustomEvent("onPick",{pickInfo:"went to server to get new scene"}))}}handleClick(){}getPickDepth(a){return"ALL"==a?AVS.Three.PickDepthEnum.All:AVS.Three.PickDepthEnum.Closest}getPickLevel(a){return"CELL_SET"==a?AVS.Three.PickLevelEnum.CellSet:"SCENE_NODE"==a?AVS.Three.PickLevelEnum.SceneNode:AVS.Three.PickLevelEnum.Cell}connectedCallback(){if(super.connectedCallback(),Polymer.RenderStatus.afterNextRender(this,function(){this.updateViewer(),!0!=this.initialized&&(this.addEventListener("iron-resize",this.onResize),this.initialized=!0)}),"THREEJS"===this.viewerProperties.renderer){void 0!=this.viewer&&this.$.viewerDiv.removeChild(this.viewer.getCanvas()),this.viewer=new AVS.Three.Viewer,this.$.viewerDiv.appendChild(this.viewer.getCanvas());var a=document.getElementById("avsRenderer");if((void 0===a||null===a)&&(a=new AvsRenderer,a.setAttribute("id","avsRenderer"),document.body.appendChild(a)),this.viewer.setWebGLRenderer(a.getWebGLRenderer()),void 0!=this.transformProperties&&void 0!=this.transformProperties.sceneNode){var b=new AVS.Three.TransformInteractor(this.viewer.container);b.setSceneNodeByName(this.transformProperties.sceneNode),this.viewer.addInteractor(b)}if(void 0!=this.hoverProperties){this.hoverProperties.depth=this.getPickDepth(this.hoverProperties.depth),this.hoverProperties.level=this.getPickLevel(this.hoverProperties.level);var c=this;this.hoverProperties.onHover=function(a){void 0!=a&&c.dispatchEvent(new CustomEvent("onHover",a))},this.viewer.addHoverListener(this.hoverProperties)}if(void 0!=this.pickProperties){this.pickProperties.depth=this.getPickDepth(this.pickProperties.depth),this.pickProperties.level=this.getPickLevel(this.pickProperties.level);var c=this;this.pickProperties.onPick=function(a){void 0!=a&&c.dispatchEvent(new CustomEvent("onPick",a))},"RECTANGLE"===this.pickProperties.type?this.viewer.addRectanglePickListener(this.pickProperties):this.viewer.addPickListener(this.pickProperties)}}else if("IMAGE"===this.viewerProperties.renderer){var d=document.createElement("img");d.setAttribute("id","sceneImage"),d.setAttribute("usemap","#sceneImageMap"),this.$.viewerDiv.appendChild(d)}if(("IMAGE"===this.viewerProperties.renderer||"SVG"===this.viewerProperties.renderer)&&void 0!=this.pickProperties&&"RECTANGLE"===this.pickProperties.type){var e=document.createElement("canvas");e.setAttribute("id","rectCanvas"),this.$.viewerDiv.appendChild(e),this.pickProperties.active=!0,this.rectCtx=e.getContext("2d"),this.rect={}}}}customElements.define(AvsViewer.is,AvsViewer);