// Licensed by Advanced Visual Systems Inc. to You under the Apache License, Version 2.0.
import{Cache,DefaultLoadingManager,Vector2,Color,UniformsUtils,UniformsLib as UniformsLib$1,ShaderMaterial,Material,Vector3,Vector4,Matrix3,Matrix4,Plane,Float32BufferAttribute,InstancedBufferGeometry,InstancedInterleavedBuffer,InterleavedBufferAttribute,Box3,Sphere,Mesh,Ray,Object3D,LoaderUtils,BufferGeometryLoader,LoadingManager,ImageLoader,CubeTexture,Texture,Scene,Fog,FogExp2,PerspectiveCamera,OrthographicCamera,AmbientLight,DirectionalLight,PointLight,SkinnedMesh,LineSegments,Points,Sprite,Group,UVMapping,CubeReflectionMapping,CubeRefractionMapping,EquirectangularReflectionMapping,EquirectangularRefractionMapping,SphericalReflectionMapping,CubeUVReflectionMapping,CubeUVRefractionMapping,RepeatWrapping,ClampToEdgeWrapping,MirroredRepeatWrapping,NearestFilter,NearestMipMapNearestFilter,NearestMipMapLinearFilter,LinearFilter,LinearMipMapNearestFilter,LinearMipMapLinearFilter,Raycaster,WebGLRenderTarget,InstancedBufferAttribute,VertexColors,BufferGeometry,NoColors,MOUSE,Quaternion,Euler,Spherical,EventDispatcher}from"three";var REVISION="1",DEFAULT_VIEWER_WIDTH=400,DEFAULT_VIEWER_HEIGHT=400,RAYCASTER_LINE_PRECISION=.03,PickDepthEnum={All:0,Closest:1},PickTypeEnum={Ray:0,Rectangle:1},PickLevelEnum={Cell:0,CellSet:1,SceneNode:2},CellTypeEnum={Points:1,Lines:2,Triangles:3,Quads:4};function FileLoader(e){this.manager=void 0!==e?e:DefaultLoadingManager}Object.assign(FileLoader.prototype,{load:function(e,t,i,n,r){void 0===e&&(e=""),void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e);var a=this,o=Cache.get(e);if(void 0!==o)return a.manager.itemStart(e),setTimeout(function(){t&&t(o),a.manager.itemEnd(e)},0),o;var s=e.match(/^data:(.*?)(;base64)?,(.*)$/);if(s){var l=s[1],c=!!s[2],h=s[3];h=decodeURIComponent(h),c&&(h=atob(h));try{var d,p=(this.responseType||"").toLowerCase();switch(p){case"arraybuffer":case"blob":for(var u=new Uint8Array(h.length),f=0;f<h.length;f++)u[f]=h.charCodeAt(f);d="blob"===p?new Blob([u.buffer],{type:l}):u.buffer;break;case"document":var m=new DOMParser;d=m.parseFromString(h,l);break;case"json":d=JSON.parse(h);break;default:d=h}setTimeout(function(){t&&t(d),a.manager.itemEnd(e)},0)}catch(t){setTimeout(function(){n&&n(t),a.manager.itemError(e),a.manager.itemEnd(e)},0)}}else{var g=new XMLHttpRequest;for(var v in void 0===r?g.open("GET",e,!0):g.open("POST",e,!0),g.addEventListener("load",function(i){var r=this.response;Cache.add(e,r),200===this.status||0===this.status?(0===this.status&&console.warn("AVS.Three.FileLoader: HTTP Status 0 received."),t&&t(r),a.manager.itemEnd(e)):(n&&n(i),a.manager.itemError(e),a.manager.itemEnd(e))},!1),g.addEventListener("progress",function(e){i&&i(e)},!1),g.addEventListener("error",function(t){n&&n(t),a.manager.itemError(e),a.manager.itemEnd(e)},!1),g.addEventListener("abort",function(t){n&&n(t),a.manager.itemError(e),a.manager.itemEnd(e)},!1),void 0!==this.responseType&&(g.responseType=this.responseType),void 0!==this.withCredentials&&(g.withCredentials=this.withCredentials),g.overrideMimeType&&g.overrideMimeType(void 0!==this.mimeType?this.mimeType:"text/plain"),this.requestHeader)g.setRequestHeader(v,this.requestHeader[v]);g.send(JSON.stringify(r))}return a.manager.itemStart(e),g},setPath:function(e){return this.path=e,this},setResponseType:function(e){return this.responseType=e,this},setWithCredentials:function(e){return this.withCredentials=e,this},setMimeType:function(e){return this.mimeType=e,this},setRequestHeader:function(e){return this.requestHeader=e,this}});var UniformsLib={pick:{pickState:{value:new Float32Array(1)},startCell:{value:0}},line:{linePattern:{value:65535},resolution:{value:new Vector2(1,1)}},thick:{linewidth:{value:1}},mesh:{stipple:{value:0},stippleColor:{value:new Color(0)},stipplePattern:{value:new Float32Array(64)}}},points_frag="uniform vec3 diffuse;\nuniform float opacity;\nuniform float pickState[ 1 ];\nvarying vec3 pickColor;\n#include <common>\n#include <color_pars_fragment>\n#include <map_particle_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tif ( pickState[ 0 ] > 0.5 ) {\n\t\tgl_FragColor = vec4( pickColor, 1.0 );\n\t} else {\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_particle_fragment>\n\t#include <color_fragment>\n\t#include <alphatest_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <premultiplied_alpha_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t}\n}",points_vert="attribute float vsize;\nattribute float cellCount;\nuniform float size;\nuniform float pickState[ 1 ];\nuniform float startCell;\nvarying vec3 pickColor;\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\tif ( pickState[ 0 ] > 0.5 ) {\n\t\tfloat cellNum = startCell + cellCount;\n\t\t\n\t\tfloat red = fract( cellNum / (255.0*255.0*255.0) );\n\t\tif ( pickState[ 0 ] > 1.5 ) {\n\t\n\t\t\tfloat red2 = fract( cellNum / (255.0*255.0*255.0*255.0*255.0*255.0) );\n\t\t\tfloat green2 = fract( cellNum / (255.0*255.0*255.0*255.0*255.0) );\n\t\t\tfloat blue2 = fract( cellNum / (255.0*255.0*255.0*255.0) );\n\t\n\t\t\tred2 -= green2 / 255.0;\n\t\t\tgreen2 -= blue2 / 255.0;\n\t\t\tblue2 -= red / 255.0;\n\t\t\tpickColor = vec3( red2, green2, blue2 );\n\t\t} else {\n\t\t\tfloat green = fract( cellNum / (255.0*255.0) );\n\t\t\tfloat blue = fract( cellNum / 255.0 );\n\t\t\tred -= green / 255.0;\n\t\t\tgreen -= blue / 255.0;\n\t\t\tpickColor = vec3( red, green, blue );\n\t\t}\n\t}\n\t#include <color_vertex>\n\t#include <begin_vertex>\n\t#include <project_vertex>\n#ifdef USE_SIZE\n\tgl_PointSize = vsize;\n#else\n\tgl_PointSize = size;\n#endif\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <fog_vertex>\n}",line_frag="uniform vec3 diffuse;\nuniform float opacity;\nuniform float linePattern;\nuniform float pickState[ 1 ];\nvarying vec3 pickColor;\n#ifdef USE_PATTERN\nvarying float vPattern;\n#endif\nvarying float vDistance;\n#include <common>\n#include <color_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tif ( pickState[ 0 ] > 0.5 ) {\n\t\tgl_FragColor = vec4( pickColor, 1.0 );\n\t} else {\n\tfloat pattern;\n#ifdef USE_PATTERN\n\tpattern = floor( vPattern );\n#else\n\tpattern = linePattern;\n#endif\n\tfloat shift = pow( 2.0, floor( mod( vDistance, 16.0 ) ) );\n\tif( mod( floor( pattern / shift ), 2.0 ) < 0.5 ) {\n\t\tdiscard;\n\t}\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <color_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <premultiplied_alpha_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t}\n}",line_vert="attribute vec3 otherPosition;\nattribute float pattern;\nattribute float cellCount;\nuniform float pickState[ 1 ];\nuniform float startCell;\nuniform vec2 resolution;\n#ifdef USE_PATTERN\nvarying float vPattern;\n#endif\nvarying float vDistance;\nvarying vec3 pickColor;\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\tif ( pickState[ 0 ] > 0.5 ) {\n\t\tfloat cellNum = startCell + cellCount;\n\t\t\n\t\tfloat red = fract( cellNum / (255.0*255.0*255.0) );\n\t\tif ( pickState[ 0 ] > 1.5 ) {\n\t\n\t\t\tfloat red2 = fract( cellNum / (255.0*255.0*255.0*255.0*255.0*255.0) );\n\t\t\tfloat green2 = fract( cellNum / (255.0*255.0*255.0*255.0*255.0) );\n\t\t\tfloat blue2 = fract( cellNum / (255.0*255.0*255.0*255.0) );\n\t\n\t\t\tred2 -= green2 / 255.0;\n\t\t\tgreen2 -= blue2 / 255.0;\n\t\t\tblue2 -= red / 255.0;\n\t\t\tpickColor = vec3( red2, green2, blue2 );\n\t\t} else {\n\t\t\tfloat green = fract( cellNum / (255.0*255.0) );\n\t\t\tfloat blue = fract( cellNum / 255.0 );\n\t\t\tred -= green / 255.0;\n\t\t\tgreen -= blue / 255.0;\n\t\t\tpickColor = vec3( red, green, blue );\n\t\t}\n\t}\n\t#include <color_vertex>\n\tvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\n\tgl_Position = projectionMatrix * mvPosition;\n\tvec2 ndcPos1 = gl_Position.xy / gl_Position.w;\n\tvec4 other_Position = projectionMatrix * modelViewMatrix * vec4( otherPosition, 1.0 );\n\tvec2 ndcPos2 = other_Position.xy / other_Position.w;\n\tfloat aspect = resolution.x / resolution.y;\n\tvec2 dir = ndcPos2 - ndcPos1;\n\tdir.x *= aspect;\n\tbool end = false;\n\tif ( dir.y < -EPSILON ) {\n\t\tend = true;\n\t}\n\telse if ( dir.y > EPSILON ) {\n\t\tend = false;\n\t}\n\telse if ( dir.x < -EPSILON ) {\n\t\tend = true;\n\t}\n\tvDistance = end ? 0.0 : length( dir * resolution ) / 2.0;\n#ifdef USE_PATTERN\n\tvPattern = pattern + 0.5;\n#endif\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}",thickline_vert="attribute vec3 positionStart;\nattribute vec3 positionEnd;\nattribute vec3 colorStart;\nattribute vec3 colorEnd;\nattribute float pattern;\nattribute float linewidthStart;\nattribute float linewidthEnd;\nattribute float cellCount;\nattribute float cellOffset;\nuniform float pickState[ 1 ];\nuniform float startCell;\nuniform float linewidth;\nuniform vec2 resolution;\n#ifdef USE_PATTERN\nvarying float vPattern;\n#endif\nvarying float vDistance;\nvarying vec3 pickColor;\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\tif ( pickState[ 0 ] > 0.5 ) {\n\t\tfloat cellNum = startCell + cellCount + cellOffset;\n\t\t\n\t\tfloat red = fract( cellNum / (255.0*255.0*255.0) );\n\t\tif ( pickState[ 0 ] > 1.5 ) {\n\t\n\t\t\tfloat red2 = fract( cellNum / (255.0*255.0*255.0*255.0*255.0*255.0) );\n\t\t\tfloat green2 = fract( cellNum / (255.0*255.0*255.0*255.0*255.0) );\n\t\t\tfloat blue2 = fract( cellNum / (255.0*255.0*255.0*255.0) );\n\t\n\t\t\tred2 -= green2 / 255.0;\n\t\t\tgreen2 -= blue2 / 255.0;\n\t\t\tblue2 -= red / 255.0;\n\t\t\tpickColor = vec3( red2, green2, blue2 );\n\t\t} else {\n\t\t\tfloat green = fract( cellNum / (255.0*255.0) );\n\t\t\tfloat blue = fract( cellNum / 255.0 );\n\t\t\tred -= green / 255.0;\n\t\t\tgreen -= blue / 255.0;\n\t\t\tpickColor = vec3( red, green, blue );\n\t\t}\n\t}\n#ifdef USE_COLOR\n\tvColor.xyz = ( position.y < 0.5 ) ? colorStart.xyz : colorEnd.xyz;\n#endif\n#ifdef USE_PATTERN\n\tvPattern = pattern + 0.5;\n#endif\n\tfloat aspect = resolution.x / resolution.y;\n\tvec4 start = modelViewMatrix * vec4( positionStart, 1.0 );\n\tvec4 end = modelViewMatrix * vec4( positionEnd, 1.0 );\n\tvec4 clipStart = projectionMatrix * start;\n\tvec4 clipEnd = projectionMatrix * end;\n\tvec2 ndcStart = clipStart.xy / clipStart.w;\n\tvec2 ndcEnd = clipEnd.xy / clipEnd.w;\n\tvec2 dir = ndcEnd - ndcStart;\n\tvec2 dirOrig = dir;\n\tdir.x *= aspect;\n\tdir = normalize( dir );\n\tvec2 offset = vec2( dir.y, -dir.x );\n\tdir.x /= aspect;\n\toffset.x /= aspect;\n\tif ( position.x < 0.5 ) offset *= -1.0;\n\toffset += ( position.y < 0.5 ) ? -dir : dir;\n\tfloat widthFactor, avgWidthFactor;\n#ifdef USE_LINEWIDTH\n\twidthFactor = ( position.y < 0.5 ) ? linewidthStart : linewidthEnd;\n\tavgWidthFactor = ( linewidthStart + linewidthEnd ) / 2.0;\n#else\n\twidthFactor = avgWidthFactor = linewidth;\n#endif\n\toffset *= widthFactor;\n\tdir *= widthFactor;\n\toffset /= resolution.y;\n\tdir /= resolution.y;\n\tvec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;\n\toffset *= clip.w;\n\tclip.xy += offset;\n\tif ( clip.z > -1.0 ) {\n\t\tclip.z -= 5.0e-4;\n\t\tif ( clip.z < -1.0 ) clip.z = -1.0;\n\t}\n\tgl_Position = clip;\n\tvDistance = ( position.y < 0.5) ? 0.0 : ( length( dirOrig * resolution ) + 2.0 * length( dir * resolution ) ) / avgWidthFactor / 2.0;\n\tvec4 mvPosition = ( position.y < 0.5 ) ? start : end;\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}",meshbasic_frag="uniform float stipple;\nuniform vec3 stippleColor;\nuniform float stipplePattern[ 64 ];\nuniform vec3 diffuse;\nuniform float opacity;\nuniform float pickState[ 1 ];\nvarying vec3 pickColor;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tif ( pickState[ 0 ] > 0.5 ) {\n\t\tgl_FragColor = vec4( pickColor, 1.0 );\n\t} else {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tif( stipple > 0.5 ) {\n\t\tvec2 coord = floor( mod( gl_FragCoord.xy, 32.0 ) );\n\t\tint index = int( floor( coord.x / 16.0 ) + ( coord.y * 2.0 ) );\n\t\tfor ( int i=0; i<64; i++ ) {\n\t\t\tif ( i == index ) {\n\t\t\t\tfloat shift = pow( 2.0, floor( mod( gl_FragCoord.x, 16.0 ) ) );\n\t\t\t\tif( mod( floor( stipplePattern[ i ] / shift ), 2.0 ) > 0.5 ) {\n\t\t\t\t\tdiffuseColor = vec4( stippleColor, opacity );\n\t\t\t\t}\n\t\t\t\telse if ( stipple < 1.5 ) {\n\t\t\t\t\tdiscard;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\t#ifdef USE_LIGHTMAP\n\t\treflectedLight.indirectDiffuse += texture2D( lightMap, vUv2 ).xyz * lightMapIntensity;\n\t#else\n\t\treflectedLight.indirectDiffuse += vec3( 1.0 );\n\t#endif\n\t#include <aomap_fragment>\n\treflectedLight.indirectDiffuse *= diffuseColor.rgb;\n\tvec3 outgoingLight = reflectedLight.indirectDiffuse;\n\t#include <envmap_fragment>\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <premultiplied_alpha_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t}\n}",meshbasic_vert="attribute float cellCount;\nuniform float pickState[ 1 ];\nuniform float startCell;\nvarying vec3 pickColor;\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\tif ( pickState[ 0 ] > 0.5 ) {\n\t\tfloat cellNum = startCell + cellCount;\n\t\t\n\t\tfloat red = fract( cellNum / (255.0*255.0*255.0) );\n\t\tif ( pickState[ 0 ] > 1.5 ) {\n\t\n\t\t\tfloat red2 = fract( cellNum / (255.0*255.0*255.0*255.0*255.0*255.0) );\n\t\t\tfloat green2 = fract( cellNum / (255.0*255.0*255.0*255.0*255.0) );\n\t\t\tfloat blue2 = fract( cellNum / (255.0*255.0*255.0*255.0) );\n\t\n\t\t\tred2 -= green2 / 255.0;\n\t\t\tgreen2 -= blue2 / 255.0;\n\t\t\tblue2 -= red / 255.0;\n\t\t\tpickColor = vec3( red2, green2, blue2 );\n\t\t} else {\n\t\t\tfloat green = fract( cellNum / (255.0*255.0) );\n\t\t\tfloat blue = fract( cellNum / 255.0 );\n\t\t\tred -= green / 255.0;\n\t\t\tgreen -= blue / 255.0;\n\t\t\tpickColor = vec3( red, green, blue );\n\t\t}\n\t}\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <skinbase_vertex>\n\t#ifdef USE_ENVMAP\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <worldpos_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <envmap_vertex>\n\t#include <fog_vertex>\n}",meshphong_frag="uniform float ambientStrength;\nuniform float diffuseStrength;\nuniform float stipple;\nuniform vec3 stippleColor;\nuniform float stipplePattern[ 64 ];\nuniform float pickState[ 1 ];\nvarying vec3 pickColor;\n#define PHONG\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform vec3 specular;\nuniform float shininess;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_pars_fragment>\n#include <gradientmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <lights_phong_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tif ( pickState[ 0 ] > 0.5 ) {\n\t\tgl_FragColor = vec4( pickColor, 1.0 );\n\t} else {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\tif( stipple > 0.5 ) {\n\t\tvec2 coord = floor( mod( gl_FragCoord.xy, 32.0 ) );\n\t\tint index = int( floor( coord.x / 16.0 ) + ( coord.y * 2.0 ) );\n\t\tfor ( int i=0; i<64; i++ ) {\n\t\t\tif ( i == index ) {\n\t\t\t\tfloat shift = pow( 2.0, floor( mod( gl_FragCoord.x, 16.0 ) ) );\n\t\t\t\tif( mod( floor( stipplePattern[ i ] / shift ), 2.0 ) > 0.5 ) {\n\t\t\t\t\tdiffuseColor = vec4( stippleColor, opacity );\n\t\t\t\t}\n\t\t\t\telse if ( stipple < 1.5 ) {\n\t\t\t\t\tdiscard;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_phong_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = ( reflectedLight.directDiffuse * diffuseStrength ) + ( reflectedLight.indirectDiffuse * ambientStrength ) + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\n\t#include <envmap_fragment>\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n\t}\n}",meshphong_vert="attribute float cellCount;\nuniform float pickState[ 1 ];\nuniform float startCell;\nvarying vec3 pickColor;\n#define PHONG\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\tif ( pickState[ 0 ] > 0.5 ) {\n\t\tfloat cellNum = startCell + cellCount;\n\t\t\n\t\tfloat red = fract( cellNum / (255.0*255.0*255.0) );\n\t\tif ( pickState[ 0 ] > 1.5 ) {\n\t\n\t\t\tfloat red2 = fract( cellNum / (255.0*255.0*255.0*255.0*255.0*255.0) );\n\t\t\tfloat green2 = fract( cellNum / (255.0*255.0*255.0*255.0*255.0) );\n\t\t\tfloat blue2 = fract( cellNum / (255.0*255.0*255.0*255.0) );\n\t\n\t\t\tred2 -= green2 / 255.0;\n\t\t\tgreen2 -= blue2 / 255.0;\n\t\t\tblue2 -= red / 255.0;\n\t\t\tpickColor = vec3( red2, green2, blue2 );\n\t\t} else {\n\t\t\tfloat green = fract( cellNum / (255.0*255.0) );\n\t\t\tfloat blue = fract( cellNum / 255.0 );\n\t\t\tred -= green / 255.0;\n\t\t\tgreen -= blue / 255.0;\n\t\t\tpickColor = vec3( red, green, blue );\n\t\t}\n\t}\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",ShaderChunk={points_frag:points_frag,points_vert:points_vert,line_frag:line_frag,line_vert:line_vert,thickline_vert:thickline_vert,meshbasic_frag:meshbasic_frag,meshbasic_vert:meshbasic_vert,meshphong_frag:meshphong_frag,meshphong_vert:meshphong_vert},ShaderLib={points:{uniforms:UniformsUtils.merge([UniformsLib$1.points,UniformsLib$1.fog,UniformsLib.pick]),vertexShader:ShaderChunk.points_vert,fragmentShader:ShaderChunk.points_frag},line:{uniforms:UniformsUtils.merge([UniformsLib$1.common,UniformsLib$1.fog,UniformsLib.pick,UniformsLib.line]),vertexShader:ShaderChunk.line_vert,fragmentShader:ShaderChunk.line_frag},thick:{uniforms:UniformsUtils.merge([UniformsLib$1.common,UniformsLib$1.fog,UniformsLib.pick,UniformsLib.line,{linewidth:{value:1}}]),vertexShader:ShaderChunk.thickline_vert,fragmentShader:ShaderChunk.line_frag},basic:{uniforms:UniformsUtils.merge([UniformsLib$1.common,UniformsLib$1.fog,UniformsLib.pick,UniformsLib.mesh]),vertexShader:ShaderChunk.meshbasic_vert,fragmentShader:ShaderChunk.meshbasic_frag},phong:{uniforms:UniformsUtils.merge([UniformsLib$1.common,UniformsLib$1.fog,UniformsLib$1.lights,UniformsLib.pick,UniformsLib.mesh,{ambientStrength:{value:.31},diffuseStrength:{value:.7},specular:{value:new Color(2039583)},shininess:{value:63.8386159788056}}]),vertexShader:ShaderChunk.meshphong_vert,fragmentShader:ShaderChunk.meshphong_frag}};function PickMaterial(e){ShaderMaterial.call(this),Object.defineProperties(this,{pickState:{get:function(){return this.uniforms.pickState.value},set:function(e){this.uniforms.pickState.value=e}},startCell:{get:function(){return this.uniforms.startCell.value},set:function(e){this.uniforms.startCell.value=e}}}),this.setValues(e)}function PointsMaterial(e){PickMaterial.call(this,{uniforms:UniformsUtils.clone(ShaderLib.points.uniforms),vertexShader:ShaderLib.points.vertexShader,fragmentShader:ShaderLib.points.fragmentShader}),this.color=new Color(16777215),this.map=null,this.size=1,this.fog=!0,Object.defineProperties(this,{vertexSizes:{get:function(){return this.defines.USE_SIZE},set:function(e){this.defines.USE_SIZE=e}}}),this.setValues(e)}function LineMaterial(e){PickMaterial.call(this,{uniforms:UniformsUtils.clone(ShaderLib.line.uniforms),vertexShader:ShaderLib.line.vertexShader,fragmentShader:ShaderLib.line.fragmentShader}),this.color=new Color(16777215),this.fog=!0,Object.defineProperties(this,{pattern:{get:function(){return this.uniforms.linePattern.value},set:function(e){this.uniforms.linePattern.value=e}},vertexPatterns:{get:function(){return this.defines.USE_PATTERN},set:function(e){this.defines.USE_PATTERN=e}},resolution:{get:function(){return this.uniforms.resolution.value},set:function(e){this.uniforms.resolution.value=e}}}),this.setValues(e)}function ThickLineMaterial(e){LineMaterial.call(this,{uniforms:UniformsUtils.clone(ShaderLib.thick.uniforms),vertexShader:ShaderLib.thick.vertexShader,fragmentShader:ShaderLib.thick.fragmentShader}),Object.defineProperties(this,{linewidth:{get:function(){return this.uniforms.linewidth.value},set:function(e){this.uniforms.linewidth.value=e}},vertexLinewidths:{get:function(){return this.defines.USE_LINEWIDTH},set:function(e){this.defines.USE_LINEWIDTH=e}}}),this.setValues(e)}function MeshBasicMaterial(e){PickMaterial.call(this,{uniforms:UniformsUtils.clone(ShaderLib.basic.uniforms),vertexShader:ShaderLib.basic.vertexShader,fragmentShader:ShaderLib.basic.fragmentShader}),this.color=new Color(16777215),this.map=null,this.fog=!0,Object.defineProperties(this,{stipple:{get:function(){return this.uniforms.stipple.value},set:function(e){this.uniforms.stipple.value=e}},stippleColor:{get:function(){return this.uniforms.stippleColor.value},set:function(e){this.uniforms.stippleColor.value=e}},stipplePattern:{get:function(){return this.uniforms.stipplePattern.value},set:function(e){this.uniforms.stipplePattern.value=e}}}),this.setValues(e)}function MeshPhongMaterial(e){MeshBasicMaterial.call(this,{uniforms:UniformsUtils.clone(ShaderLib.phong.uniforms),vertexShader:ShaderLib.phong.vertexShader,fragmentShader:ShaderLib.phong.fragmentShader}),this.specular=new Color(2039583),this.shininess=63.8386159788056,this.lights=!0,Object.defineProperties(this,{ambient:{get:function(){return this.uniforms.ambientStrength.value},set:function(e){this.uniforms.ambientStrength.value=e}},diffuse:{get:function(){return this.uniforms.diffuseStrength.value},set:function(e){this.uniforms.diffuseStrength.value=e}}}),this.setValues(e)}function MaterialLoader(e){this.manager=void 0!==e?e:DefaultLoadingManager,this.textures={}}PickMaterial.prototype=Object.create(ShaderMaterial.prototype),PickMaterial.prototype.constructor=PickMaterial,PointsMaterial.prototype=Object.create(PickMaterial.prototype),PointsMaterial.prototype.constructor=PointsMaterial,PointsMaterial.prototype.isPointsMaterial=!0,PointsMaterial.prototype.copy=function(e){return PickMaterial.prototype.copy.call(this,e),this.color.copy(e.color),this.map=e.map,this.size=e.size,this},PointsMaterial.prototype.toJSON=function(e){var t=Material.prototype.toJSON.call(this,e);return t.type="PointsMaterial",0!==this.vertexSizes&&(t.vertexSizes=this.vertexSizes),t},LineMaterial.prototype=Object.create(PickMaterial.prototype),LineMaterial.prototype.constructor=LineMaterial,LineMaterial.prototype.isLineBasicMaterial=!0,LineMaterial.prototype.copy=function(e){return PickMaterial.prototype.copy.call(this,e),this.color.copy(e.color),this},LineMaterial.prototype.toJSON=function(e){var t=Material.prototype.toJSON.call(this,e);return t.type="LineMaterial",65535!==this.pattern&&(t.pattern=this.pattern),0!==this.vertexPatterns&&(t.vertexPatterns=this.vertexPatterns),t},ThickLineMaterial.prototype=Object.create(LineMaterial.prototype),ThickLineMaterial.prototype.constructor=ThickLineMaterial,ThickLineMaterial.prototype.toJSON=function(e){var t=LineMaterial.prototype.toJSON.call(this,e);return t.type="ThickLineMaterial",0!==this.vertexLinewidths&&(t.vertexLinewidths=this.vertexLinewidths),t},MeshBasicMaterial.prototype=Object.create(PickMaterial.prototype),MeshBasicMaterial.prototype.constructor=MeshBasicMaterial,MeshBasicMaterial.prototype.isMeshBasicMaterial=!0,MeshBasicMaterial.prototype.copy=function(e){return PickMaterial.prototype.copy.call(this,e),this.color.copy(e.color),this.map=e.map,this},MeshBasicMaterial.prototype.toJSON=function(e){var t=Material.prototype.toJSON.call(this,e);return t.type="MeshBasicMaterial",0!==this.stipple&&(t.stipple=this.stipple),0!==this.stippleColor.getHex()&&(t.stippleColor=this.stippleColor.getHex()),JSON.stringify(this.stipplePattern)!==JSON.stringify(new Float32Array(64))&&(t.stipplePattern=Array.prototype.slice.call(this.stipplePattern)),t},MeshPhongMaterial.prototype=Object.create(MeshBasicMaterial.prototype),MeshPhongMaterial.prototype.constructor=MeshPhongMaterial,MeshPhongMaterial.prototype.isMeshPhongMaterial=!0,MeshPhongMaterial.prototype.isMeshBasicMaterial=!1,MeshPhongMaterial.prototype.copy=function(e){return MeshBasicMaterial.prototype.copy.call(this,e),this.specular.copy(e.specular),this.shininess=e.shininess,this},MeshPhongMaterial.prototype.toJSON=function(e){var t=MeshBasicMaterial.prototype.toJSON.call(this,e);return t.type="MeshPhongMaterial",.31!==this.ambient&&(t.ambient=this.ambient),.7!==this.diffuse&&(t.diffuse=this.diffuse),2039583===this.specular.getHex()&&(t.specular=void 0),63.8386159788056===this.shininess&&(t.shininess=void 0),t},Object.assign(MaterialLoader.prototype,{load:function(e,t,i,n){var r=this,a=new FileLoader(r.manager);a.setPath(r.path),a.load(e,function(e){t(r.parse(JSON.parse(e)))},i,n)},parse:function(e){var t=this.textures;function i(e){return void 0===t[e]&&console.warn("AVS.Three.MaterialLoader: Undefined texture",e),t[e]}var n=new Materials[e.type];if(void 0!==e.uuid&&(n.uuid=e.uuid),void 0!==e.name&&(n.name=e.name),void 0!==e.color&&n.color.setHex(e.color),void 0!==e.roughness&&(n.roughness=e.roughness),void 0!==e.metalness&&(n.metalness=e.metalness),void 0!==e.emissive&&n.emissive.setHex(e.emissive),void 0!==e.specular&&n.specular.setHex(e.specular),void 0!==e.shininess&&(n.shininess=e.shininess),void 0!==e.clearCoat&&(n.clearCoat=e.clearCoat),void 0!==e.clearCoatRoughness&&(n.clearCoatRoughness=e.clearCoatRoughness),void 0!==e.vertexColors&&(n.vertexColors=e.vertexColors),void 0!==e.fog&&(n.fog=e.fog),void 0!==e.flatShading&&(n.flatShading=e.flatShading),void 0!==e.blending&&(n.blending=e.blending),void 0!==e.combine&&(n.combine=e.combine),void 0!==e.side&&(n.side=e.side),void 0!==e.opacity&&(n.opacity=e.opacity),void 0!==e.transparent&&(n.transparent=e.transparent),void 0!==e.alphaTest&&(n.alphaTest=e.alphaTest),void 0!==e.depthTest&&(n.depthTest=e.depthTest),void 0!==e.depthWrite&&(n.depthWrite=e.depthWrite),void 0!==e.colorWrite&&(n.colorWrite=e.colorWrite),void 0!==e.wireframe&&(n.wireframe=e.wireframe),void 0!==e.wireframeLinewidth&&(n.wireframeLinewidth=e.wireframeLinewidth),void 0!==e.wireframeLinecap&&(n.wireframeLinecap=e.wireframeLinecap),void 0!==e.wireframeLinejoin&&(n.wireframeLinejoin=e.wireframeLinejoin),void 0!==e.rotation&&(n.rotation=e.rotation),1!==e.linewidth&&(n.linewidth=e.linewidth),void 0!==e.dashSize&&(n.dashSize=e.dashSize),void 0!==e.gapSize&&(n.gapSize=e.gapSize),void 0!==e.scale&&(n.scale=e.scale),void 0!==e.polygonOffset&&(n.polygonOffset=e.polygonOffset),void 0!==e.polygonOffsetFactor&&(n.polygonOffsetFactor=e.polygonOffsetFactor),void 0!==e.polygonOffsetUnits&&(n.polygonOffsetUnits=e.polygonOffsetUnits),void 0!==e.skinning&&(n.skinning=e.skinning),void 0!==e.morphTargets&&(n.morphTargets=e.morphTargets),void 0!==e.dithering&&(n.dithering=e.dithering),void 0!==e.visible&&(n.visible=e.visible),void 0!==e.userData&&(n.userData=e.userData),void 0!==e.uniforms)for(var r in e.uniforms){var a=e.uniforms[r];switch(n.uniforms[r]={},a.type){case"t":n.uniforms[r].value=i(a.value);break;case"c":n.uniforms[r].value=(new Color).setHex(a.value);break;case"v2":n.uniforms[r].value=(new Vector2).fromArray(a.value);break;case"v3":n.uniforms[r].value=(new Vector3).fromArray(a.value);break;case"v4":n.uniforms[r].value=(new Vector4).fromArray(a.value);break;case"m3":n.uniforms[r].value=(new Matrix3).fromArray(a.value);break;case"m4":n.uniforms[r].value=(new Matrix4).fromArray(a.value);break;default:n.uniforms[r].value=a.value}}if(void 0!==e.defines&&(n.defines=e.defines),void 0!==e.vertexShader&&(n.vertexShader=e.vertexShader),void 0!==e.fragmentShader&&(n.fragmentShader=e.fragmentShader),void 0!==e.extensions)for(var o in e.extensions)n.extensions[o]=e.extensions[o];if(void 0!==e.shading&&(n.flatShading=1===e.shading),void 0!==e.size&&(n.size=e.size),void 0!==e.sizeAttenuation&&(n.sizeAttenuation=e.sizeAttenuation),void 0!==e.vertexSizes&&(n.vertexSizes=e.vertexSizes),void 0!==e.pattern&&(n.pattern=e.pattern),void 0!==e.vertexPatterns&&(n.vertexPatterns=e.vertexPatterns),void 0!==e.vertexLinewidths&&(n.vertexLinewidths=e.vertexLinewidths),void 0!==e.stipple&&(n.stipple=e.stipple),void 0!==e.stippleColor&&n.stippleColor.setHex(e.stippleColor),void 0!==e.stipplePattern&&(n.stipplePattern=e.stipplePattern),void 0!==e.ambient&&(n.ambient=e.ambient),void 0!==e.diffuse&&(n.diffuse=e.diffuse),void 0!==e.map&&(n.map=i(e.map)),void 0!==e.alphaMap&&(n.alphaMap=i(e.alphaMap),n.transparent=!0),void 0!==e.bumpMap&&(n.bumpMap=i(e.bumpMap)),void 0!==e.bumpScale&&(n.bumpScale=e.bumpScale),void 0!==e.normalMap&&(n.normalMap=i(e.normalMap)),void 0!==e.normalMapType&&(n.normalMapType=e.normalMapType),void 0!==e.normalScale){var s=e.normalScale;!1===Array.isArray(s)&&(s=[s,s]),n.normalScale=(new Vector2).fromArray(s)}if(void 0!==e.displacementMap&&(n.displacementMap=i(e.displacementMap)),void 0!==e.displacementScale&&(n.displacementScale=e.displacementScale),void 0!==e.displacementBias&&(n.displacementBias=e.displacementBias),void 0!==e.roughnessMap&&(n.roughnessMap=i(e.roughnessMap)),void 0!==e.metalnessMap&&(n.metalnessMap=i(e.metalnessMap)),void 0!==e.emissiveMap&&(n.emissiveMap=i(e.emissiveMap)),void 0!==e.emissiveIntensity&&(n.emissiveIntensity=e.emissiveIntensity),void 0!==e.specularMap&&(n.specularMap=i(e.specularMap)),void 0!==e.envMap&&(n.envMap=i(e.envMap)),void 0!==e.envMapIntensity&&(n.envMapIntensity=e.envMapIntensity),void 0!==e.reflectivity&&(n.reflectivity=e.reflectivity),void 0!==e.lightMap&&(n.lightMap=i(e.lightMap)),void 0!==e.lightMapIntensity&&(n.lightMapIntensity=e.lightMapIntensity),void 0!==e.aoMap&&(n.aoMap=i(e.aoMap)),void 0!==e.aoMapIntensity&&(n.aoMapIntensity=e.aoMapIntensity),void 0!==e.gradientMap&&(n.gradientMap=i(e.gradientMap)),void 0!==e.clippingPlanes){n.clippingPlanes=[];for(var l=0,c=e.clippingPlanes.length;l<c;l++){var h=e.clippingPlanes[l],d=new Plane(new Vector3(h.normal[0],h.normal[1],h.normal[2]),h.constant);n.clippingPlanes.push(d)}}return n},setPath:function(e){return this.path=e,this},setTextures:function(e){return this.textures=e,this}});var Materials={PointsMaterial:PointsMaterial,MeshPhongMaterial:MeshPhongMaterial,MeshBasicMaterial:MeshBasicMaterial,LineMaterial:LineMaterial,ThickLineMaterial:ThickLineMaterial};function LinePatternBufferGeometryLoader(e){this.bufferGeometryLoader=e}function ThickLineSegmentsBufferGeometry(){InstancedBufferGeometry.call(this),this.type="ThickLineSegmentsBufferGeometry";this.addAttribute("position",new Float32BufferAttribute([0,0,0,1,1,0,0,1,0,0,0,0,1,0,0,1,1,0],3));this.addAttribute("cellOffset",new Float32BufferAttribute([0,0,0,1,1,1],1))}function ThickLineBufferGeometryLoader(){}function ThickLineSegments(e,t){Mesh.call(this,e,t),this.type="ThickLineSegments"}function BillboardText(){Object3D.call(this),this.type="BillboardText",this.text="Label",this.fontSize=16,this.fontStyle="normal",this.fontWeight="normal",this.textDecoration="",this.fontFamily="sans-serif",this.color=new Color(0),this.textAlign="",this.transform="",this.transformOrigin="",this.div=document.createElement("div"),this.div.style.position="absolute",this.div.style.whiteSpace="nowrap",this.div.id="label",this.scene=null,this.updateStyle()}function ObjectLoader(e){this.manager=void 0!==e?e:DefaultLoadingManager,this.resourcePath=""}Object.assign(LinePatternBufferGeometryLoader.prototype,{parse:function(e){var t=this.bufferGeometryLoader.parse(e),i=t.attributes.position;if(void 0!==i){for(var n=new Float32BufferAttribute(i.array.length,3),r=i.array.length/6,a=0;a<r;a++)n.array[6*a+0]=i.array[6*a+3],n.array[6*a+1]=i.array[6*a+4],n.array[6*a+2]=i.array[6*a+5],n.array[6*a+3]=i.array[6*a+0],n.array[6*a+4]=i.array[6*a+1],n.array[6*a+5]=i.array[6*a+2];t.addAttribute("otherPosition",n)}return t}}),ThickLineSegmentsBufferGeometry.prototype=Object.assign(Object.create(InstancedBufferGeometry.prototype),{constructor:ThickLineSegmentsBufferGeometry,isThickLineSegmentsBufferGeometry:!0,applyMatrix:function(e){var t=this.attributes.positionStart,i=this.attributes.positionEnd;return void 0!==t&&(e.applyToBufferAttribute(t),e.applyToBufferAttribute(i),t.data.needsUpdate=!0,i.data.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this},setPositions:function(e){var t=new InstancedInterleavedBuffer(new Float32Array(e),6,1);this.addAttribute("positionStart",new InterleavedBufferAttribute(t,3,0)),this.addAttribute("positionEnd",new InterleavedBufferAttribute(t,3,3)),this.computeBoundingBox(),this.computeBoundingSphere()},setColors:function(e){var t=new InstancedInterleavedBuffer(new Float32Array(e),6,1);this.addAttribute("colorStart",new InterleavedBufferAttribute(t,3,0)),this.addAttribute("colorEnd",new InterleavedBufferAttribute(t,3,3))},setPatterns:function(e){var t=new InstancedInterleavedBuffer(new Float32Array(e),2,1);this.addAttribute("pattern",new InterleavedBufferAttribute(t,1,0))},setLinewidths:function(e){var t=new InstancedInterleavedBuffer(new Float32Array(e),2,1);this.addAttribute("linewidthStart",new InterleavedBufferAttribute(t,1,0)),this.addAttribute("linewidthEnd",new InterleavedBufferAttribute(t,1,1))},computeBoundingBox:function(){var e=new Box3;return function(){null===this.boundingBox&&(this.boundingBox=new Box3);var t=this.attributes.positionStart,i=this.attributes.positionEnd;void 0!==t&&void 0!==i&&(this.boundingBox.setFromBufferAttribute(t),e.setFromBufferAttribute(i),this.boundingBox.union(e))}}(),computeBoundingSphere:function(){var e=new Vector3;return function(){null===this.boundingSphere&&(this.boundingSphere=new Sphere),null===this.boundingBox&&this.computeBoundingBox();var t=this.attributes.positionStart,i=this.attributes.positionEnd;if(void 0!==t&&void 0!==i){var n=this.boundingSphere.center;this.boundingBox.getCenter(n);for(var r=0,a=0,o=t.count;a<o;a++)e.fromBufferAttribute(t,a),r=Math.max(r,n.distanceToSquared(e)),e.fromBufferAttribute(i,a),r=Math.max(r,n.distanceToSquared(e));this.boundingSphere.radius=Math.sqrt(r),isNaN(this.boundingSphere.radius)&&console.error("AVS.Three.ThickLineSegmentsBufferGeometry.computeBoundingSphere(): Computed radius is NaN. The instanced position data is likely to have NaN values.",this)}}}()}),ThickLineBufferGeometryLoader.prototype={parse:function(e){var t=new ThickLineSegmentsBufferGeometry,i=e.data.attributes;return void 0!==i.position&&t.setPositions(i.position.array),void 0!==i.color&&t.setColors(i.color.array),void 0!==i.pattern&&t.setPatterns(i.pattern.array),void 0!==i.linewidth&&t.setLinewidths(i.linewidth.array),t}},ThickLineSegments.prototype=Object.assign(Object.create(Mesh.prototype),{constructor:ThickLineSegments,isThickLineSegments:!0,raycast:function(){var e=new Matrix4,t=new Ray,i=new Sphere;return function(n,r){var a=n.linePrecision,o=this.geometry,s=this.matrixWorld;if(null===o.boundingSphere&&o.computeBoundingSphere(),i.copy(o.boundingSphere),i.applyMatrix4(s),i.radius+=a,!1!==n.ray.intersectsSphere(i)){e.getInverse(s),t.copy(n.ray).applyMatrix4(e);for(var l=a/((this.scale.x+this.scale.y+this.scale.z)/3),c=l*l,h=new Vector3,d=new Vector3,p=new Vector3,u=new Vector3,f=o.attributes.positionStart.array,m=0,g=f.length/3-1;m<g;m+=2){if(h.fromArray(f,3*m),d.fromArray(f,3*m+3),!(t.distanceSqToSegment(h,d,u,p)>c)){u.applyMatrix4(this.matrixWorld);var v=n.ray.origin.distanceTo(u);v<n.near||v>n.far||r.push({distance:v,point:p.clone().applyMatrix4(this.matrixWorld),index:m,face:null,faceIndex:null,object:this})}}}}}()}),BillboardText.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:BillboardText,isBillboardText:!0,addToScene:function(e){this.scene=e,e.labels.push(this),e.labelDiv.appendChild(this.div),this.updateStyle()},updateStyle:function(){this.div.innerHTML=decodeURIComponent(this.text.replace(/\+/g,"%20")),this.div.style.fontSize=this.fontSize+"pt",this.div.style.fontFamily=this.fontFamily,this.div.style.fontStyle=this.fontStyle,this.div.style.fontWeight=this.fontWeight,this.div.style.textDecoration=this.textDecoration,this.div.style.color="#"+this.color.getHexString(),this.div.style.textAlign=this.textAlign,this.div.style.transform=this.transform,this.div.style.transformOrigin=this.transformOrigin},updatePosition:function(){var e=(new Vector3).setFromMatrixPosition(this.matrixWorld);e.project(this.scene.camera),e.x=(e.x+1)/2*this.scene.width+this.scene.x-this.scene.scissorX,e.y=(1-(e.y+1)/2)*this.scene.height+this.scene.top-this.scene.scissorTop,this.div.style.left=e.x+"px",this.div.style.top=e.y+"px"}}),Object.assign(ObjectLoader.prototype,{crossOrigin:"anonymous",load:function(e,t,i,n,r){var a=this,o=void 0===this.path?LoaderUtils.extractUrlBase(e):this.path;this.resourcePath=this.resourcePath||o;var s=new FileLoader(a.manager);s.setPath(this.path),s.setRequestHeader({"Content-type":"application/json"}),s.load(e,function(i){var r=null;try{r=JSON.parse(i)}catch(t){return void 0!==n&&n(t),void console.error("AVS.Three.ObjectLoader: Can't parse "+e+".",t.message)}console.log(r),a.parse(r,t)},i,n,r)},setPath:function(e){return this.path=e,this},setResourcePath:function(e){return this.resourcePath=e,this},setCrossOrigin:function(e){return this.crossOrigin=e,this},parse:function(e,t,i,n,r,a,o){var s=e;if(void 0!==s.threejs&&(e=s.threejs),void 0!==s.selectionInfo)var l=s.selectionInfo;var c=this.parseGeometries(e.geometries,a),h=this.parseImages(e.images,function(){void 0!==t&&t(u,l)},i),d=this.parseTextures(e.textures,h,n),p=this.parseMaterials(e.materials,d,r),u=this.parseObject(e.object,c,p);return void 0!==o&&(o.add(u),u.saveVisible=u.visible,u.visible=!1),void 0!==e.images&&0!==e.images.length||void 0!==t&&t(u,l),u},parseGeometries:function(e,t){var i={};if(void 0!==t&&(i=t),void 0!==e)for(var n=new BufferGeometryLoader,r=new LinePatternBufferGeometryLoader(n),a=new ThickLineBufferGeometryLoader,o=0,s=e.length;o<s;o++){var l,c=e[o];switch(c.type){case"BufferGeometry":l=n.parse(c);break;case"LinePatternBufferGeometry":l=r.parse(c);break;case"ThickLineBufferGeometry":l=a.parse(c);break;default:console.warn('AVS.Three.ObjectLoader: Unsupported geometry type "'+c.type+'"');continue}l.uuid=c.uuid,void 0!==c.name&&(l.name=c.name),!0===l.isBufferGeometry&&void 0!==c.userData&&(l.userData=c.userData),i[c.uuid]=l}return i},parseMaterials:function(e,t,i){var n={},r={};if(void 0!==i&&(r=i),void 0!==e){var a=new MaterialLoader;a.setTextures(t);for(var o=0,s=e.length;o<s;o++){var l=e[o];if("MultiMaterial"===l.type){for(var c=[],h=0;h<l.materials.length;h++){var d=l.materials[h];void 0===n[d.uuid]&&(n[d.uuid]=a.parse(d)),c.push(n[d.uuid])}r[l.uuid]=c}else void 0===n[l.uuid]&&(n[l.uuid]=a.parse(l)),r[l.uuid]=n[l.uuid]}}return r},parseImages:function(e,t,i){var n=this,r={};function a(e){return n.manager.itemStart(e),s.load(e,function(){n.manager.itemEnd(e)},void 0,function(){n.manager.itemError(e),n.manager.itemEnd(e)})}if(void 0!==i&&(r=i),void 0!==e&&e.length>0){var o=new LoadingManager(t),s=new ImageLoader(o);s.setCrossOrigin(this.crossOrigin);for(var l=0,c=e.length;l<c;l++){var h=e[l],d=h.url;if(Array.isArray(d)){r[h.uuid]=[];for(var p=0,u=d.length;p<u;p++){var f=d[p],m=/^(\/\/)|([a-z]+:(\/\/)?)/i.test(f)?f:n.resourcePath+f;r[h.uuid].push(a(m))}}else{m=/^(\/\/)|([a-z]+:(\/\/)?)/i.test(h.url)?h.url:n.resourcePath+h.url;r[h.uuid]=a(m)}}}return r},parseTextures:function(e,t,i){function n(e,t){return"number"==typeof e?e:(console.warn("AVS.Three.ObjectLoader.parseTextures: Constant should be in numeric form.",e),t[e])}var r={};if(void 0!==i&&(r=i),void 0!==e)for(var a=0,o=e.length;a<o;a++){var s,l=e[a];void 0===l.image&&console.warn('AVS.Three.ObjectLoader: No "image" specified for',l.uuid),void 0===t[l.image]&&console.warn("AVS.Three.ObjectLoader: Undefined image",l.image),(s=Array.isArray(t[l.image])?new CubeTexture(t[l.image]):new Texture(t[l.image])).needsUpdate=!0,s.uuid=l.uuid,void 0!==l.name&&(s.name=l.name),void 0!==l.mapping&&(s.mapping=n(l.mapping,TEXTURE_MAPPING)),void 0!==l.offset&&s.offset.fromArray(l.offset),void 0!==l.repeat&&s.repeat.fromArray(l.repeat),void 0!==l.center&&s.center.fromArray(l.center),void 0!==l.rotation&&(s.rotation=l.rotation),void 0!==l.wrap&&(s.wrapS=n(l.wrap[0],TEXTURE_WRAPPING),s.wrapT=n(l.wrap[1],TEXTURE_WRAPPING)),void 0!==l.format&&(s.format=l.format),void 0!==l.type&&(s.type=l.type),void 0!==l.encoding&&(s.encoding=l.encoding),void 0!==l.minFilter&&(s.minFilter=n(l.minFilter,TEXTURE_FILTER)),void 0!==l.magFilter&&(s.magFilter=n(l.magFilter,TEXTURE_FILTER)),void 0!==l.anisotropy&&(s.anisotropy=l.anisotropy),void 0!==l.flipY&&(s.flipY=l.flipY),void 0!==l.premultiplyAlpha&&(s.premultiplyAlpha=l.premultiplyAlpha),void 0!==l.unpackAlignment&&(s.unpackAlignment=l.unpackAlignment),r[l.uuid]=s}return r},parseObject:function(e,t,i){var n;function r(e){return void 0===t[e]&&console.warn("AVS.Three.ObjectLoader: Undefined geometry",e),t[e]}function a(e){if(void 0!==e){if(Array.isArray(e)){for(var t=[],n=0,r=e.length;n<r;n++){var a=e[n];void 0===i[a]&&console.warn("AVS.Three.ObjectLoader: Undefined material",a),t.push(i[a])}return t}return void 0===i[e]&&console.warn("AVS.Three.ObjectLoader: Undefined material",e),i[e]}}if(void 0!==e){switch(e.type){case"Scene":n=new Scene,void 0!==e.background&&Number.isInteger(e.background)&&(n.background=new Color(e.background)),void 0!==e.fog&&("Fog"===e.fog.type?n.fog=new Fog(e.fog.color,e.fog.near,e.fog.far):"FogExp2"===e.fog.type&&(n.fog=new FogExp2(e.fog.color,e.fog.density)));break;case"PerspectiveCamera":n=new PerspectiveCamera(e.fov,e.aspect,e.near,e.far),void 0!==e.focus&&(n.focus=e.focus),void 0!==e.zoom&&(n.zoom=e.zoom),void 0!==e.filmGauge&&(n.filmGauge=e.filmGauge),void 0!==e.filmOffset&&(n.filmOffset=e.filmOffset),void 0!==e.view&&(n.view=Object.assign({},e.view));break;case"OrthographicCamera":n=new OrthographicCamera(e.left,e.right,e.top,e.bottom,e.near,e.far);break;case"AmbientLight":n=new AmbientLight(e.color,e.intensity);break;case"DirectionalLight":n=new DirectionalLight(e.color,e.intensity);break;case"PointLight":n=new PointLight(e.color,e.intensity,e.distance,e.decay);break;case"Mesh":case"Quads":var o=r(e.geometry),s=a(e.material);n=o.bones&&o.bones.length>0?new SkinnedMesh(o,s):new Mesh(o,s),void 0!==e.drawMode&&n.setDrawMode(e.drawMode),n.cellType="Quads"===e.type?CellTypeEnum.Quads:CellTypeEnum.Triangles;break;case"LineSegments":(n=new LineSegments(r(e.geometry),a(e.material))).cellType=CellTypeEnum.Lines;break;case"ThickLineSegments":(n=new ThickLineSegments(r(e.geometry),a(e.material))).cellType=CellTypeEnum.Quads;break;case"PointCloud":case"Points":(n=new Points(r(e.geometry),a(e.material))).cellType=CellTypeEnum.Points;break;case"Sprite":n=new Sprite(a(e.material));break;case"Group":n=new Group;break;case"BillboardText":n=new BillboardText,void 0!==e.text&&(n.text=e.text),void 0!==e.fontSize&&(n.fontSize=e.fontSize),void 0!==e.fontStyle&&(n.fontStyle=e.fontStyle),void 0!==e.fontWeight&&(n.fontWeight=e.fontWeight),void 0!==e.fontFamily&&(n.fontFamily=e.fontFamily),void 0!==e.textDecoration&&(n.textDecoration=e.textDecoration),void 0!==e.color&&n.color.setHex(e.color),void 0!==e.textAlign&&(n.textAlign=e.textAlign),void 0!==e.transform&&(n.transform=e.transform),void 0!==e.transformOrigin&&(n.transformOrigin=e.transformOrigin);break;default:n=new Object3D}if(n.uuid=e.uuid,void 0!==e.name&&(n.name=e.name),void 0!==e.matrix?(n.matrix.fromArray(e.matrix),void 0!==e.matrixAutoUpdate&&(n.matrixAutoUpdate=e.matrixAutoUpdate),n.matrixAutoUpdate&&n.matrix.decompose(n.position,n.quaternion,n.scale)):(void 0!==e.position&&n.position.fromArray(e.position),void 0!==e.rotation&&n.rotation.fromArray(e.rotation),void 0!==e.quaternion&&n.quaternion.fromArray(e.quaternion),void 0!==e.scale&&n.scale.fromArray(e.scale)),void 0!==e.castShadow&&(n.castShadow=e.castShadow),void 0!==e.receiveShadow&&(n.receiveShadow=e.receiveShadow),e.shadow&&(void 0!==e.shadow.bias&&(n.shadow.bias=e.shadow.bias),void 0!==e.shadow.radius&&(n.shadow.radius=e.shadow.radius),void 0!==e.shadow.mapSize&&n.shadow.mapSize.fromArray(e.shadow.mapSize),void 0!==e.shadow.camera&&(n.shadow.camera=this.parseObject(e.shadow.camera))),void 0!==e.visible&&(n.visible=e.visible),void 0!==e.frustumCulled&&(n.frustumCulled=e.frustumCulled),void 0!==e.renderOrder&&(n.renderOrder=e.renderOrder),void 0!==e.userData&&(n.userData=e.userData),void 0!==e.layers&&(n.layers.mask=e.layers),void 0!==e.children)for(var l=e.children,c=0;c<l.length;c++)n.add(this.parseObject(l[c],t,i))}return n}});var TEXTURE_MAPPING={UVMapping:UVMapping,CubeReflectionMapping:CubeReflectionMapping,CubeRefractionMapping:CubeRefractionMapping,EquirectangularReflectionMapping:EquirectangularReflectionMapping,EquirectangularRefractionMapping:EquirectangularRefractionMapping,SphericalReflectionMapping:SphericalReflectionMapping,CubeUVReflectionMapping:CubeUVReflectionMapping,CubeUVRefractionMapping:CubeUVRefractionMapping},TEXTURE_WRAPPING={RepeatWrapping:RepeatWrapping,ClampToEdgeWrapping:ClampToEdgeWrapping,MirroredRepeatWrapping:MirroredRepeatWrapping},TEXTURE_FILTER={NearestFilter:NearestFilter,NearestMipMapNearestFilter:NearestMipMapNearestFilter,NearestMipMapLinearFilter:NearestMipMapLinearFilter,LinearFilter:LinearFilter,LinearMipMapNearestFilter:LinearMipMapNearestFilter,LinearMipMapLinearFilter:LinearMipMapLinearFilter};function Viewer(e,t){var i=e;this.getID=function(){return i},this.pixelRatio=void 0!==t?t:window.devicePixelRatio,this.mainCanvas=document.createElement("canvas"),this.mainCanvas.style.position="absolute",this.mainCanvas.id="mainCanvas",this.mainCtx=this.mainCanvas.getContext("2d"),this.highlightCanvas=document.createElement("canvas"),this.highlightCanvas.style.position="absolute",this.highlightCanvas.id="highlightCanvas",this.highlightCtx=this.highlightCanvas.getContext("2d"),this.labelContainer=document.createElement("div"),this.labelContainer.style.position="absolute",this.labelContainer.style.overflow="hidden",this.labelContainer.style.width="100%",this.labelContainer.style.height="100%",this.labelContainer.id="labelDiv",this.container=document.createElement("div"),this.container.style.position="relative",this.container.style.overflow="hidden",this.container.style.width="100%",this.container.style.height="100%",this.container.appendChild(this.mainCanvas),this.container.appendChild(this.highlightCanvas),this.container.appendChild(this.labelContainer),this.container.id="avsthreeDiv",this.domElement=this.container,this.scenes=[],this.currentScene=null,this.startCell=1,this.background=null,this.interactors=[],this.raycaster=new Raycaster,this.raycaster.linePrecision=.001,this.raycaster.params.Points.threshold=.02,this.validPick=!1,this.pickType=PickTypeEnum.Ray,this.pickDepth=PickDepthEnum.Closest,this.pickRayX=0,this.pickRayY=0,this.pickRectangleLeft=0,this.pickRectangleTop=0,this.pickRectangleRight=1,this.pickRectangleBottom=1,this.selectionListeners=[],this.intersects=[],this.highlightList=[],this.updateHighlight=!1,this.highlightColor=new Color(16711680),this.updatePicking=!1,this.chunkRenderTarget=new WebGLRenderTarget,this.chunkRenderTarget.scissorTest=!0,this.pickingRenderTarget=new WebGLRenderTarget,this.pickingRenderTarget.scissorTest=!0,this.pickState=new Float32Array(1),this.resolution=new Vector2,this.loading=!1,this.cancelLoad=!1}function TransformInteractor(e){this.object=new Object3D,this.camera=null,this.domElement=void 0!==e?e:document,this.enabled=!0,this.target=new Vector3,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!0,this.keyPanSpeed=7,this.enableKeys=!0,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40},this.mouseButtons={LEFT:MOUSE.LEFT,MIDDLE:MOUSE.MIDDLE,RIGHT:MOUSE.RIGHT},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this.saveState=function(){t.target0.copy(t.target),t.position0.copy(t.object.position),t.zoom0=t.object.zoom},this.reset=function(){t.target.copy(t.target0),t.object.position.copy(t.position0),t.object.zoom=t.zoom0,t.object.updateProjectionMatrix(),t.dispatchEvent(i),t.update(),o=a.NONE},this.update=function(){var e=t.object.quaternion.clone().inverse();c.applyQuaternion(e),t.object.position.add(c);var n=(new Quaternion).setFromEuler(new Euler(s.phi,s.theta,0,"XYZ"));t.object.quaternion.premultiply(n),t.object.scale.multiplyScalar(l),s.set(0,0,0),l=1,c.set(0,0,0),t.dispatchEvent(i)},this.dispose=function(){t.domElement.removeEventListener("contextmenu",N,!1),t.domElement.removeEventListener("mousedown",C,!1),t.domElement.removeEventListener("wheel",O,!1),t.domElement.removeEventListener("touchstart",A,!1),t.domElement.removeEventListener("touchend",j,!1),t.domElement.removeEventListener("touchmove",U,!1),document.removeEventListener("mousemove",D,!1),document.removeEventListener("mouseup",R,!1),window.removeEventListener("keydown",I,!1)};var t=this,i={type:"change"},n={type:"start"},r={type:"end"},a={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_DOLLY_PAN:4},o=a.NONE,s=new Spherical,l=1,c=new Vector3,h=new Vector2,d=new Vector2,p=new Vector2,u=new Vector2,f=new Vector2,m=new Vector2,g=new Vector2,v=new Vector2,b=new Vector2;function y(){return Math.pow(.95,t.zoomSpeed)}function x(e){s.theta+=e}function S(e){s.phi+=e}var T,k,_=(T=new Vector3,function(e,t){T.setFromMatrixColumn(t,0),T.multiplyScalar(e),c.add(T)}),w=function(){var e=new Vector3;return function(i,n){!0===t.screenSpacePanning?e.setFromMatrixColumn(n,1):(e.setFromMatrixColumn(n,0),e.crossVectors(t.object.up,e)),e.multiplyScalar(-i),c.add(e)}}(),M=(k=new Vector3,function(e,i){var n=t.domElement===document?t.domElement.body:t.domElement;if(t.camera.isPerspectiveCamera){var r=t.camera.position;k.copy(r).sub(t.target);var a=k.length();a*=Math.tan(t.camera.fov/2*Math.PI/180),_(2*e*a/n.clientHeight,t.object.matrix),w(2*i*a/n.clientHeight,t.object.matrix)}else t.camera.isOrthographicCamera?(_(e*(t.camera.right-t.camera.left)/t.camera.zoom/n.clientWidth,t.object.matrix),w(i*(t.camera.top-t.camera.bottom)/t.camera.zoom/n.clientHeight,t.object.matrix)):(console.warn("WARNING: AVS.Three.TransformInteractor encountered an unknown camera type - pan disabled."),t.enablePan=!1)});function L(e){l*=e}function P(e){l/=e}function E(e){u.set(e.clientX,e.clientY)}function C(e){if(!1!==t.enabled){switch(e.preventDefault(),t.domElement.focus?t.domElement.focus():window.focus(),e.button){case t.mouseButtons.LEFT:if(e.ctrlKey||e.metaKey||e.shiftKey){if(!1===t.enablePan)return;E(e),o=a.PAN}else{if(!1===t.enableRotate)return;!function(e){h.set(e.clientX,e.clientY)}(e),o=a.ROTATE}break;case t.mouseButtons.MIDDLE:if(!1===t.enableZoom)return;!function(e){g.set(e.clientX,e.clientY)}(e),o=a.DOLLY;break;case t.mouseButtons.RIGHT:if(!1===t.enablePan)return;E(e),o=a.PAN}o!==a.NONE&&(document.addEventListener("mousemove",D,!1),document.addEventListener("mouseup",R,!1),t.dispatchEvent(n))}}function D(e){if(!1!==t.enabled)switch(e.preventDefault(),o){case a.ROTATE:if(!1===t.enableRotate)return;!function(e){d.set(e.clientX,e.clientY),p.subVectors(d,h).multiplyScalar(t.rotateSpeed);var i=t.domElement===document?t.domElement.body:t.domElement;x(2*Math.PI*p.x/i.clientHeight),S(2*Math.PI*p.y/i.clientHeight),h.copy(d),t.update()}(e);break;case a.DOLLY:if(!1===t.enableZoom)return;!function(e){v.set(e.clientX,e.clientY),b.subVectors(v,g),b.y>0?L(y()):b.y<0&&P(y()),g.copy(v),t.update()}(e);break;case a.PAN:if(!1===t.enablePan)return;!function(e){f.set(e.clientX,e.clientY),m.subVectors(f,u).multiplyScalar(t.panSpeed),M(m.x,m.y),u.copy(f),t.update()}(e)}}function R(e){!1!==t.enabled&&(document.removeEventListener("mousemove",D,!1),document.removeEventListener("mouseup",R,!1),t.dispatchEvent(r),o=a.NONE)}function O(e){!1===t.enabled||!1===t.enableZoom||o!==a.NONE&&o!==a.ROTATE||(e.preventDefault(),e.stopPropagation(),t.dispatchEvent(n),function(e){e.deltaY<0?P(y()):e.deltaY>0&&L(y()),t.update()}(e),t.dispatchEvent(r))}function I(e){!1!==t.enabled&&!1!==t.enableKeys&&!1!==t.enablePan&&function(e){var i=!1;switch(e.keyCode){case t.keys.UP:M(0,t.keyPanSpeed),i=!0;break;case t.keys.BOTTOM:M(0,-t.keyPanSpeed),i=!0;break;case t.keys.LEFT:M(t.keyPanSpeed,0),i=!0;break;case t.keys.RIGHT:M(-t.keyPanSpeed,0),i=!0}i&&(e.preventDefault(),t.update())}(e)}function A(e){if(!1!==t.enabled){switch(e.preventDefault(),e.touches.length){case 1:if(!1===t.enableRotate)return;!function(e){h.set(e.touches[0].pageX,e.touches[0].pageY)}(e),o=a.TOUCH_ROTATE;break;case 2:if(!1===t.enableZoom&&!1===t.enablePan)return;!function(e){if(t.enableZoom){var i=e.touches[0].pageX-e.touches[1].pageX,n=e.touches[0].pageY-e.touches[1].pageY,r=Math.sqrt(i*i+n*n);g.set(0,r)}if(t.enablePan){var a=.5*(e.touches[0].pageX+e.touches[1].pageX),o=.5*(e.touches[0].pageY+e.touches[1].pageY);u.set(a,o)}}(e),o=a.TOUCH_DOLLY_PAN;break;default:o=a.NONE}o!==a.NONE&&t.dispatchEvent(n)}}function U(e){if(!1!==t.enabled)switch(e.preventDefault(),e.stopPropagation(),e.touches.length){case 1:if(!1===t.enableRotate)return;if(o!==a.TOUCH_ROTATE)return;!function(e){d.set(e.touches[0].pageX,e.touches[0].pageY),p.subVectors(d,h).multiplyScalar(t.rotateSpeed);var i=t.domElement===document?t.domElement.body:t.domElement;x(2*Math.PI*p.x/i.clientHeight),S(2*Math.PI*p.y/i.clientHeight),h.copy(d),t.update()}(e);break;case 2:if(!1===t.enableZoom&&!1===t.enablePan)return;if(o!==a.TOUCH_DOLLY_PAN)return;!function(e){if(t.enableZoom){var i=e.touches[0].pageX-e.touches[1].pageX,n=e.touches[0].pageY-e.touches[1].pageY,r=Math.sqrt(i*i+n*n);v.set(0,r),b.set(0,Math.pow(v.y/g.y,t.zoomSpeed)),L(b.y),g.copy(v)}if(t.enablePan){var a=.5*(e.touches[0].pageX+e.touches[1].pageX),o=.5*(e.touches[0].pageY+e.touches[1].pageY);f.set(a,o),m.subVectors(f,u).multiplyScalar(t.panSpeed),M(m.x,m.y),u.copy(f)}t.update()}(e);break;default:o=a.NONE}}function j(e){!1!==t.enabled&&(t.dispatchEvent(r),o=a.NONE)}function N(e){!1!==t.enabled&&e.preventDefault()}t.domElement.addEventListener("contextmenu",N,!1),t.domElement.addEventListener("mousedown",C,!1),t.domElement.addEventListener("wheel",O,!1),t.domElement.addEventListener("touchstart",A,!1),t.domElement.addEventListener("touchend",j,!1),t.domElement.addEventListener("touchmove",U,!1),window.addEventListener("keydown",I,!1),this.update()}function DomainTransformInteractor(e){var t;this.object=new Object3D,this.linkObjectsBottom=[],this.linkObjectsTop=[],this.linkObjectsLeft=[],this.linkObjectsRight=[],this.linkObjectsBottomStatic=[],this.linkObjectsTopStatic=[],this.linkObjectsLeftStatic=[],this.linkObjectsRightStatic=[],this.domElement=void 0!==e?e:document,this.enabled=!0,this.target=new Vector3,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!0,this.keyPanSpeed=7,this.enableKeys=!0,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40},this.mouseButtons={LEFT:MOUSE.LEFT,MIDDLE:MOUSE.MIDDLE,RIGHT:MOUSE.RIGHT},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this.saveState=function(){i.target0.copy(i.target),i.position0.copy(i.object.position),i.zoom0=i.object.zoom},this.reset=function(){i.target.copy(i.target0),i.object.position.copy(i.position0),i.object.zoom=i.zoom0,i.object.updateProjectionMatrix(),i.dispatchEvent(n),i.update(),s=o.NONE},this.update=(t=null,function(){i.object.position.copy(c);for(var e=0;e<i.linkObjectsBottom.length;e++)(t=i.linkObjectsBottom[e]).position.x=c.x;for(e=0;e<i.linkObjectsBottomStatic.length;e++)(t=i.linkObjectsBottomStatic[e]).position.x=-c.x/t.linkBottom.scale.x;for(e=0;e<i.linkObjectsTop.length;e++)(t=i.linkObjectsTop[e]).position.x=c.x;for(e=0;e<i.linkObjectsTopStatic.length;e++)(t=i.linkObjectsTopStatic[e]).position.x=-c.x/t.linkTop.scale.x;for(e=0;e<i.linkObjectsLeft.length;e++)(t=i.linkObjectsLeft[e]).position.y=c.y;for(e=0;e<i.linkObjectsLeftStatic.length;e++)(t=i.linkObjectsLeftStatic[e]).position.y=-c.y/t.linkLeft.scale.y;for(e=0;e<i.linkObjectsRight.length;e++)(t=i.linkObjectsRight[e]).position.y=c.y;for(e=0;e<i.linkObjectsRightStatic.length;e++)(t=i.linkObjectsRightStatic[e]).position.y=-c.y/t.linkRight.scale.y;i.dispatchEvent(n)}),this.dispose=function(){i.domElement.removeEventListener("contextmenu",C,!1),i.domElement.removeEventListener("mousedown",T,!1),i.domElement.removeEventListener("wheel",w,!1),i.domElement.removeEventListener("touchstart",L,!1),i.domElement.removeEventListener("touchend",E,!1),i.domElement.removeEventListener("touchmove",P,!1),document.removeEventListener("mousemove",k,!1),document.removeEventListener("mouseup",_,!1),window.removeEventListener("keydown",M,!1)};var i=this,n={type:"change"},r={type:"start"},a={type:"end"},o={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_DOLLY_PAN:4},s=o.NONE,l=new Spherical,c=new Vector3,h=new Vector2,d=new Vector2,p=new Vector2,u=new Vector2,f=new Vector2,m=new Vector2,g=new Vector2,v=new Vector2,b=new Vector2;y=new Vector3(1,0,0),function(){var e=new Vector3(0,1,0)}();var y,x=function(){new Vector3;return function(e,t){var n=i.domElement===document?i.domElement.body:i.domElement;if(i.object.camera.isOrthographicCamera){var r=e/n.clientWidth*(i.object.camera.right-i.object.camera.left)/i.object.camera.zoom;if(c.x+=r,r<0){var a=i.object.camera.left*(i.object.scale.x-1);c.x<a&&(c.x=a)}else if(r>0){a=i.object.camera.right*(i.object.scale.x-1);c.x>a&&(c.x=a)}var o=t/n.clientHeight*(i.object.camera.top-i.object.camera.bottom)/i.object.camera.zoom;if(c.y-=o,o>0){var s=1-i.object.scale.y;c.y<s&&(c.y=s)}else if(o<0){s=i.object.scale.y-1;c.y>s&&(c.y=s)}}else console.warn("WARNING: AVS.Three.DomainTransformInteractor encountered an unknown camera type - pan disabled."),i.enablePan=!1}}();function S(e){d.set(e.touches[0].pageX,e.touches[0].pageY),p.subVectors(d,h).multiplyScalar(i.rotateSpeed);var t,n=i.domElement===document?i.domElement.body:i.domElement;t=2*Math.PI*p.x/n.clientHeight,l.theta+=t,function(e){l.phi+=e}(2*Math.PI*p.y/n.clientHeight),h.copy(d),i.update()}function T(e){if(!1!==i.enabled){switch(e.preventDefault(),e.button){case i.mouseButtons.LEFT:if(!1===i.enablePan)return;!function(e){u.set(e.clientX,e.clientY)}(e),s=o.PAN}s!==o.NONE&&(document.addEventListener("mousemove",k,!1),document.addEventListener("mouseup",_,!1),i.dispatchEvent(r))}}function k(e){if(!1!==i.enabled)switch(e.preventDefault(),s){case o.ROTATE:if(!1===i.enableRotate)return;handleMouseMoveRotate(e);break;case o.DOLLY:if(!1===i.enableZoom)return;handleMouseMoveDolly(e);break;case o.PAN:if(!1===i.enablePan)return;!function(e){f.set(e.clientX,e.clientY),m.subVectors(f,u).multiplyScalar(i.panSpeed),x(m.x,m.y),u.copy(f),i.update()}(e)}}function _(e){!1!==i.enabled&&(document.removeEventListener("mousemove",k,!1),document.removeEventListener("mouseup",_,!1),i.dispatchEvent(a),s=o.NONE)}function w(e){!1===i.enabled||!1===i.enableZoom||s!==o.NONE&&s!==o.ROTATE||(e.preventDefault(),e.stopPropagation(),i.dispatchEvent(r),handleMouseWheel(e),i.dispatchEvent(a))}function M(e){!1!==i.enabled&&!1!==i.enableKeys&&!1!==i.enablePan&&function(e){switch(e.keyCode){case i.keys.UP:x(0,i.keyPanSpeed),i.update();break;case i.keys.BOTTOM:x(0,-i.keyPanSpeed),i.update();break;case i.keys.LEFT:x(i.keyPanSpeed,0),i.update();break;case i.keys.RIGHT:x(-i.keyPanSpeed,0),i.update()}}(e)}function L(e){if(!1!==i.enabled){switch(e.preventDefault(),e.touches.length){case 1:if(!1===i.enableRotate)return;!function(e){h.set(e.touches[0].pageX,e.touches[0].pageY)}(e),s=o.TOUCH_ROTATE;break;case 2:if(!1===i.enableZoom&&!1===i.enablePan)return;!function(e){if(i.enableZoom){var t=e.touches[0].pageX-e.touches[1].pageX,n=e.touches[0].pageY-e.touches[1].pageY,r=Math.sqrt(t*t+n*n);g.set(0,r)}if(i.enablePan){var a=.5*(e.touches[0].pageX+e.touches[1].pageX),o=.5*(e.touches[0].pageY+e.touches[1].pageY);u.set(a,o)}}(e),s=o.TOUCH_DOLLY_PAN;break;default:s=o.NONE}s!==o.NONE&&i.dispatchEvent(r)}}function P(e){if(!1!==i.enabled)switch(e.preventDefault(),e.stopPropagation(),e.touches.length){case 1:if(!1===i.enableRotate)return;if(s!==o.TOUCH_ROTATE)return;S(e);break;case 2:if(!1===i.enableZoom&&!1===i.enablePan)return;if(s!==o.TOUCH_DOLLY_PAN)return;!function(e){if(i.enableZoom){var t=e.touches[0].pageX-e.touches[1].pageX,n=e.touches[0].pageY-e.touches[1].pageY,r=Math.sqrt(t*t+n*n);v.set(0,r),b.set(0,Math.pow(v.y/g.y,i.zoomSpeed)),dollyIn(b.y),g.copy(v)}if(i.enablePan){var a=.5*(e.touches[0].pageX+e.touches[1].pageX),o=.5*(e.touches[0].pageY+e.touches[1].pageY);f.set(a,o),m.subVectors(f,u).multiplyScalar(i.panSpeed),x(m.x,m.y),u.copy(f)}i.update()}(e);break;default:s=o.NONE}}function E(e){!1!==i.enabled&&(i.dispatchEvent(a),s=o.NONE)}function C(e){!1!==i.enabled&&e.preventDefault()}i.domElement.addEventListener("contextmenu",C,!1),i.domElement.addEventListener("mousedown",T,!1),i.domElement.addEventListener("wheel",w,!1),i.domElement.addEventListener("touchstart",L,!1),i.domElement.addEventListener("touchend",E,!1),i.domElement.addEventListener("touchmove",P,!1),window.addEventListener("keydown",M,!1),this.update()}Viewer.prototype={constructor:Viewer,setWebGLRenderer:function(e){this.renderer=e,this.renderer.autoClear=!1,this.renderer.setPixelRatio(this.pixelRatio),this.renderer.localClippingEnabled=!0,this.renderer.sortObjects=!1,this.renderer.setScissorTest(!0)},updateSize:function(){var e=this.container.clientWidth,t=this.container.clientHeight;if(e!==this.width||t!==this.height){this.width=e,this.height=t,this.pixelWidth=Math.floor(e*this.pixelRatio),this.pixelHeight=Math.floor(t*this.pixelRatio),this.mainCanvas.width=this.pixelWidth,this.mainCanvas.height=this.pixelHeight,this.mainCanvas.style.width=e+"px",this.mainCanvas.style.height=t+"px",this.highlightCanvas.width=this.pixelWidth,this.highlightCanvas.height=this.pixelHeight,this.highlightCanvas.style.width=e+"px",this.highlightCanvas.style.height=t+"px",this.chunkRenderTarget.setSize(this.pixelWidth,this.pixelHeight),this.chunkPixelBuffer=new Uint8Array(4*this.pixelWidth*this.pixelHeight),this.pickingRenderTarget.setSize(this.pixelWidth,this.pixelHeight),this.pickingPixelBuffer=new Uint8Array(4*this.pixelWidth*this.pixelHeight),this.pickingRenderTarget2&&(this.pickingRenderTarget2.setSize(this.pixelWidth,this.pixelHeight),this.pickingPixelBuffer2=new Uint8Array(4*this.pixelWidth*this.pixelHeight)),this.updateHighlight=!0,this.updatePicking=!0,this.validPick=!1;for(var i=0;i<this.scenes.length;i++)this.updateSceneSize(this.scenes[i])}},updateSceneSize:function(e){e.x=void 0!==e.userData.x?Math.floor(this.width*e.userData.x):0,e.width=void 0!==e.userData.width?Math.floor(this.width*e.userData.width):this.width,e.y=void 0!==e.userData.y?Math.floor(this.height*e.userData.y):0,e.height=void 0!==e.userData.height?Math.floor(this.height*e.userData.height):this.height,e.top=this.height-e.height-e.y,e.pixelX=void 0!==e.userData.x?Math.floor(this.pixelWidth*e.userData.x):0,e.pixelWidth=void 0!==e.userData.width?Math.floor(this.pixelWidth*e.userData.width):this.pixelWidth,e.pixelY=void 0!==e.userData.y?Math.floor(this.pixelHeight*e.userData.y):0,e.pixelHeight=void 0!==e.userData.height?Math.floor(this.pixelHeight*e.userData.height):this.pixelHeight,e.camera.isPerspectiveCamera&&(e.camera.aspect=e.pixelWidth/e.pixelHeight,e.camera.updateProjectionMatrix()),e.scissorX=void 0!==e.userData.scissorX?Math.floor(this.width*e.userData.scissorX+.5):e.x,e.scissorWidth=void 0!==e.userData.scissorWidth?Math.floor(this.width*e.userData.scissorWidth+.5):e.width,e.scissorY=void 0!==e.userData.scissorY?Math.floor(this.height*e.userData.scissorY+.5):e.y,e.scissorHeight=void 0!==e.userData.scissorHeight?Math.floor(this.height*e.userData.scissorHeight+.5):e.height,e.scissorTop=this.height-e.scissorHeight-e.scissorY;var t=e.labelDiv;t.style.left=e.scissorX+"px",t.style.width=e.scissorWidth+"px",t.style.top=e.scissorTop+"px",t.style.height=e.scissorHeight+"px",e.pixelScissorX=void 0!==e.userData.scissorX?Math.floor(this.pixelWidth*e.userData.scissorX+.5):e.pixelX,e.pixelScissorWidth=void 0!==e.userData.scissorWidth?Math.floor(this.pixelWidth*e.userData.scissorWidth+.5):e.pixelWidth,e.pixelScissorY=void 0!==e.userData.scissorY?Math.floor(this.pixelHeight*e.userData.scissorY+.5):e.pixelY,e.pixelScissorHeight=void 0!==e.userData.scissorHeight?Math.floor(this.pixelHeight*e.userData.scissorHeight+.5):e.pixelHeight},clearGeometry:function(){for(;this.labelContainer.lastChild;)this.labelContainer.removeChild(this.labelContainer.lastChild);this.scenes=[],this.currentScene=null,this.startCell=1},setPickDepth:function(e){void 0===e&&(e=PickDepthEnum.Closest),this.pickDepth!==e&&(this.pickDepth=e)},setPickRay:function(e,t){var i=Math.floor(e*this.pixelRatio),n=this.pixelHeight-Math.floor(t*this.pixelRatio);if(i<0||n<0||i>this.pixelWidth||n>this.pixelHeight)return this.validPick=!1,void console.error("AVS.Three.Viewer: pick ray coordinates out of range.");this.pickType=PickTypeEnum.Ray,this.pickRayX=i,this.pickRayY=n,this.validPick=!0},setPickRectangle:function(e,t,i,n){var r=Math.floor(Math.min(e,i)*this.pixelRatio),a=Math.floor(Math.max(e,i)*this.pixelRatio)-r,o=this.pixelHeight-Math.floor(Math.max(t,n)*this.pixelRatio),s=this.pixelHeight-Math.floor(Math.min(t,n)*this.pixelRatio)-o;if(r<0||o<0||a+r>this.pixelWidth||o+s>this.pixelHeight)return this.validPick=!1,void console.error("AVS.Three.Viewer: pick rectangle coordinates out of range.");this.pickType=PickTypeEnum.Rectangle,this.pickRectangleX=r,this.pickRectangleY=o,this.pickRectangleWidth=a,this.pickRectangleHeight=s,this.validPick=!0},addInteractor:function(e){var t=this;this.interactors.push(e),e.domElement=this.domElement,e.isTransformInteractor?this.transformInteractor=e:e.isDomainTransformInteractor&&(this.domainTransformInteractor=e),e.addEventListener("change",function(){t.updatePicking=!0,t.render(!0),void 0!==t.stats&&t.stats.update()})},addStats:function(){void 0===this.stats&&(this.stats=new Stats,this.container.appendChild(this.stats.dom))},updateInteractors:function(){for(var e=0;e<this.interactors.length;e++)this.interactors[e].update()},addGeometry:function(e){e.updateMatrixWorld();var t=this,i=new Vector3,n=new Vector3;new Matrix4;e.traverse(function(e){if(e.isScene){for(var r=0;r<e.children.length;r++){var a=e.children[r];if(a.isPerspectiveCamera||a.isOrthographicCamera){e.camera=a;break}}void 0==e.camera&&null!==e.background&&(e.camera=new OrthographicCamera),void 0!==e.camera&&t.addScene(e)}else if(e.userData.attachTransformInteractor&&t.transformInteractor)t.transformInteractor.object=e,t.transformInteractor.camera=t.currentScene.camera;else if(e.userData.attachDomainTransformInteractor&&t.domainTransformInteractor){var o=e.parent;o.matrix.copy(e.matrixWorld),o.matrixAutoUpdate=!1,o.isScene=!0,o.autoUpdate=!0,o.userData.is3D=t.currentScene.userData.is3D,e.camera=o.camera=t.currentScene.camera,e.scale.set(t.domainTransformInteractor.widthScale,t.domainTransformInteractor.heightScale,1);var s=o.matrix.elements[13];s*=t.domainTransformInteractor.widthScale,o.matrix.elements[13]=s;var l=o.matrix.elements[14];l*=t.domainTransformInteractor.heightScale,o.matrix.elements[14]=l,"center"===e.userData.attachDomainTransformInteractor?t.domainTransformInteractor.object=e:"bottom"===e.userData.attachDomainTransformInteractor?(e.position.y=e.camera.bottom*(1-e.scale.y),t.domainTransformInteractor.linkObjectsBottom.push(e)):"top"===e.userData.attachDomainTransformInteractor?(e.position.y=e.camera.top*(1-e.scale.y),t.domainTransformInteractor.linkObjectsTop.push(e)):"left"===e.userData.attachDomainTransformInteractor?(e.position.x=e.camera.left*(1-e.scale.x),t.domainTransformInteractor.linkObjectsLeft.push(e)):"right"===e.userData.attachDomainTransformInteractor&&(e.position.x=e.camera.right*(1-e.scale.x),t.domainTransformInteractor.linkObjectsRight.push(e));var c=e.camera.right-e.camera.left,h=e.camera.top-e.camera.bottom;i.set(-e.userData.xSize/2,-e.userData.ySize/2,0),i.multiply(e.scale),i.x+=e.camera.left*(1-e.scale.x),i.y+=e.camera.bottom*(1-e.scale.y),i.applyMatrix4(o.matrix),n.set(e.userData.xSize/2,e.userData.ySize/2,0),n.multiply(e.scale),n.x+=e.camera.right*(1-e.scale.x),n.y+=e.camera.top*(1-e.scale.y),n.applyMatrix4(o.matrix);var d=(i.x-e.camera.left)/c,p=(n.x-e.camera.left)/c,u=(i.y-e.camera.bottom)/h,f=(n.y-e.camera.bottom)/h;"center"===e.userData.attachDomainTransformInteractor?(o.userData.scissorX=d,o.userData.scissorWidth=p-d,o.userData.scissorY=u,o.userData.scissorHeight=f-u):"bottom"===e.userData.attachDomainTransformInteractor?(o.userData.scissorX=d,o.userData.scissorWidth=p-d,o.userData.scissorHeight=f):"top"===e.userData.attachDomainTransformInteractor?(o.userData.scissorX=d,o.userData.scissorWidth=p-d,o.userData.scissorY=u,o.userData.scissorHeight=1-u):"left"===e.userData.attachDomainTransformInteractor?(o.userData.scissorWidth=p,o.userData.scissorY=u,o.userData.scissorHeight=f-u):"right"===e.userData.attachDomainTransformInteractor&&(o.userData.scissorX=d,o.userData.scissorWidth=1-d,o.userData.scissorY=u,o.userData.scissorHeight=f-u),t.addScene(o)}else e.userData.attachDomainTransformInteractorStatic&&t.domainTransformInteractor&&e.traverseAncestors(function(i){"bottom"===i.userData.attachDomainTransformInteractor?(t.domainTransformInteractor.linkObjectsBottomStatic.push(e),e.linkBottom=i):"top"===i.userData.attachDomainTransformInteractor?(t.domainTransformInteractor.linkObjectsTopStatic.push(e),e.linkTop=i):"left"===i.userData.attachDomainTransformInteractor?(t.domainTransformInteractor.linkObjectsLeftStatic.push(e),e.linkLeft=i):"right"===i.userData.attachDomainTransformInteractor&&(t.domainTransformInteractor.linkObjectsRightStatic.push(e),e.linkRight=i)})}),t.updateInteractors();for(var r=0;r<this.scenes.length;r++){var a=this.scenes[r];a.parent&&a.parent.remove(a)}},addScene:function(e){this.scenes.push(e),this.currentScene=e,e.labels=[];var t=document.createElement("div");t.style.position="absolute",t.style.overflow="hidden",t.id="sceneLabelDiv",e.labelDiv=t,this.labelContainer.appendChild(t),this.addLabels(e),this.updateSceneSize(e),e.startCell=this.startCell,this.createPickingInfo(e),e.highlightScene=new Scene,e.highlightScene.add(new Group);for(var i=0;i<e.children.length;i++)e.children[i].isLight&&e.highlightScene.add(e.children[i].clone())},createPickingInfo:function(e){var t=this;e.traverse(function(e){if(void 0!==e.geometry){if(void 0===e.geometry.attributes.cellCount){var i,n;if(e.isThickLineSegments){var r=(s=e.geometry.attributes.positionStart.array.length/3)/2;n=s;for(var a=new Float32Array(r),o=0;o<r;o++)a[o]=2*o;i=new InstancedBufferAttribute(a,1)}else{var s,l=1;e.isPoints?l=1:e.isLineSegments?l=2:e.isMesh&&(l=3),n=(s=e.geometry.attributes.position.array.length/3)/l,i=new Float32BufferAttribute(s,1);for(o=0;o<n;o++)for(var c=0;c<l;c++)i.array[o*l+c]=o}e.geometry.addAttribute("cellCount",i),e.geometry.nCells=n}e.nCells=e.geometry.nCells,e.startCell=t.startCell,e.onBeforeRender=function(e,t,i,n,r,a){r.uniforms.startCell.value=this.startCell;var o=e.properties.get(r);if(o.program){var s=e.getContext();s.useProgram(o.program.program),o.program.getUniforms().setValue(s,"startCell",this.startCell)}},t.startCell+=e.nCells,!t.pickingRenderTarget2&&t.startCell>16777215&&(t.pickingRenderTarget2=new WebGLRenderTarget(t.pixelWidth,t.pixelHeight),t.pickingPixelBuffer2=new Uint8Array(4*t.pixelWidth*t.pixelHeight)),t.updatePicking=!0}})},addLabels:function(e){var t=this;e.traverse(function(e){e.isBillboardText?e.addToScene(t.currentScene):void 0!==e.material&&(e.material.pickState=t.pickState,void 0!==e.material.isLineBasicMaterial&&(e.material.resolution=t.resolution))})},loadGeometryAsJson:function(e){var t=(new ObjectLoader).parse(e);this.clearGeometry(),this.addGeometry(t)},loadGeometryAsUrl:function(e){if(void 0===e.jsonRequest.model.rendererProperties.streamProperties||"CHUNK"!==e.jsonRequest.model.rendererProperties.streamProperties.type)if(void 0===e.jsonRequest.model.rendererProperties.streamProperties||"OBOE_STREAM"!==e.jsonRequest.model.rendererProperties.streamProperties.type){var t=this;!0===this.loading&&(this.cancelLoad=!0),this.loading=!0,(new ObjectLoader).load(e.url,function(i,n){!1===t.cancelLoad&&(t.loading=!1,void 0!==i&&(t.clearGeometry(),t.addGeometry(i),t.render()),void 0!==e.success&&e.success(n)),t.cancelLoad=!1},e.progress,e.error,e.jsonRequest)}else this.loadGeometryAsUrlStream(e);else this.loadGeometryAsUrlChunk(e)},loadGeometryAsUrlChunk:function(e){var t,i=this,n=[],r=new ObjectLoader,a=new FileLoader(i.manager),o={},s={},l={},c={},h=0,d=-1,p=0,u=0;function f(t){if(u--,t.layers.set(1),t.visible=t.saveVisible,d>0&&0==u)return void 0!==e.success&&e.success(),void(i.loading=!1);p++}function m(a){if("Group"===a.type){var d=r.parse(a);void 0!==t&&t.add(d),n.push(d),t=d}else if("FinishGroup"===a.type){var p=n.pop();t=n.length>0?n[n.length-1]:p}else if("Geometry"===a.type){u++;var m=r.parse(a,f,o,s,l,c,t);h++,i.addLabels(m),i.createPickingInfo(m)}else if("Layout"===a.type){for(var g=r.parse(a),v=0;v<g.children.length;v++){var b=g.children[v];if(b.isPerspectiveCamera||b.isOrthographicCamera){g.camera=b;break}}void 0==g.camera&&null!==g.background&&(g.camera=new OrthographicCamera),void 0!==g.camera&&i.addScene(g),t=g}else console.log("ERROR: unknown type: "+a.type);void 0!==e.progress&&e.progress()}!0!==this.loading&&(this.loading=!0,this.clearGeometry(),function t(n,r){a.setRequestHeader({"Content-type":"application/json"}),a.load(n,function(a){var o=null;try{o=JSON.parse(a)}catch(t){return void 0!==e.error&&e.error(t),void console.error("AVS.Three.Viewer.loadGeometryAsUrlChunk: Can't parse chunk "+n+".",t.message)}if(void 0!==o.events){console.log("Events in chunk = "+o.events.length);for(var s=0;s<o.events.length;s++)m(o.events[s]);void 0!==r.model.rendererProperties.streamProperties.streamUpdate&&r.model.rendererProperties.streamProperties.streamUpdate(p),!0===o.moreChunks?(r.model.rendererProperties.streamProperties.chunkId=o.chunkId,t(n,r)):(d=h-1,0==u&&(void 0!==e.success&&e.success(),i.loading=!1))}else console.error("AVS.Three.Viewer.loadGeometryAsUrlChunk: Can't get events from "+n)},void 0,e.error,r)}(e.url,e.jsonRequest))},loadGeometryAsUrlStream:function(e){var t,i=this,n=[],r=new ObjectLoader,a={},o={},s={},l={},c=0,h=-1,d=0,p=0;function u(t){p--,t.visible=t.saveVisible,i.addLabels(t),i.createPickingInfo(t),void 0!=e.success&&h>0&&0==p?e.success():(void 0!=e.streamUpdate&&void 0!==e.streamUpdateStep&&(d===e.streamUpdateFirst||d>0&&d%e.streamUpdateStep==0)&&e.streamUpdate(d),d++)}oboe(e.url).fail(function(t){void 0!=e.error&&e.error()}).done(function(){h=c-1,void 0!=e.success&&0==p&&e.success()}).node("events.*",function(h){if("Group"===h.type){var d=r.parse(h);"SceneRoot"===d.userData.type?i.connectSceneRoot(d):void 0!==t&&(t.add(d),i.connectInteractor(d)),n.push(d),t=d}else if("FinishGroup"===h.type){var f=n.pop();t=n.length>0?n[n.length-1]:f}else if("Geometry"===h.type)p++,r.parse(h,u,a,o,s,l,t),c++;else if("Layout"===h.type){var m=r.parse(h);i.addScene(m),t=m}else console.log("ERROR: unknown type: "+h.type);return void 0!=e.progress&&e.progress(),oboe.drop})},highlightRender:function(){if(void 0!==this.renderer){this.renderer.setSize(this.width,this.height),this.renderer.setClearColor(0,0),this.renderer.clear();for(var e=0;e<this.scenes.length;e++){var t=this.scenes[e];this.resolution.x=t.pixelWidth,this.resolution.y=t.pixelHeight,this.renderer.setViewport(t.x,t.y,t.width,t.height),this.renderer.setScissor(t.scissorX,t.scissorY,t.scissorWidth,t.scissorHeight),this.renderer.render(t.highlightScene,t.camera)}this.highlightCtx.clearRect(0,0,this.pixelWidth,this.pixelHeight),this.highlightCtx.drawImage(this.renderer.domElement,0,0)}else console.error("AVS.Three.Viewer: WebGLRenderer not set.")},pickRender:function(){if(void 0!==this.renderer){this.renderer.setRenderTarget(this.pickingRenderTarget),this.pickState[0]=1,this.renderer.setClearColor(0,0),this.renderer.clear();for(var e=0;e<this.scenes.length;e++){var t=this.scenes[e];this.resolution.x=t.pixelWidth,this.resolution.y=t.pixelHeight,this.renderer.setViewport(t.x,t.y,t.width,t.height),this.renderer.setScissor(t.scissorX,t.scissorY,t.scissorWidth,t.scissorHeight),this.renderer.render(t,t.camera)}if(this.renderer.readRenderTargetPixels(this.pickingRenderTarget,0,0,this.pixelWidth,this.pixelHeight,this.pickingPixelBuffer),this.pickingRenderTarget2){this.renderer.setRenderTarget(this.pickingRenderTarget2),this.pickState[0]=2,this.renderer.clear();for(e=0;e<this.scenes.length;e++){t=this.scenes[e];this.resolution.x=t.pixelWidth,this.resolution.y=t.pixelHeight,this.renderer.setViewport(t.x,t.y,t.width,t.height),this.renderer.setScissor(t.scissorX,t.scissorY,t.scissorWidth,t.scissorHeight),this.renderer.render(t,t.camera)}this.renderer.readRenderTargetPixels(this.pickingRenderTarget2,0,0,this.pixelWidth,this.pixelHeight,this.pickingPixelBuffer2)}this.pickState[0]=0,this.renderer.setRenderTarget(null)}else console.error("AVS.Three.Viewer: WebGLRenderer not set.")},render:function(e){if(void 0!==this.renderer){this.updateSize();var t=this.loading,i=e||!t;t?this.renderer.setRenderTarget(this.chunkRenderTarget):this.renderer.setSize(this.width,this.height),i&&(null!==this.background?this.renderer.setClearColor(this.background,1):this.renderer.setClearColor(0,0),this.renderer.clear());for(var n=0;n<this.scenes.length;n++){var r=this.scenes[n];if(this.resolution.x=r.pixelWidth,this.resolution.y=r.pixelHeight,!i){r.camera.layers.set(1);for(var a=0;a<r.children.length;a++)r.children[a].isLight&&r.children[a].layers.set(1)}this.renderer.setViewport(r.x,r.y,r.width,r.height),this.renderer.setScissor(r.scissorX,r.scissorY,r.scissorWidth,r.scissorHeight),this.renderer.render(r,r.camera),i||r.traverse(function(e){e.layers.set(0)});for(a=0;a<r.labels.length;a++)r.labels[a].updatePosition()}if(t){this.renderer.readRenderTargetPixels(this.chunkRenderTarget,0,0,this.pixelWidth,this.pixelHeight,this.chunkPixelBuffer);var o,s,l=this.mainCtx.createImageData(this.pixelWidth,this.pixelHeight),c=4*this.pixelWidth;for(n=0;n<this.chunkPixelBuffer.length;n++)o=Math.floor(n/c),s=n%c,l.data[(this.pixelHeight-o-1)*c+s]=this.chunkPixelBuffer[n];this.mainCtx.putImageData(l,0,0),this.renderer.setRenderTarget(null)}else this.mainCtx.clearRect(0,0,this.pixelWidth,this.pixelHeight),this.mainCtx.drawImage(this.renderer.domElement,0,0);this.updateHighlight&&(this.highlightRender(),this.updateHighlight=!1)}else console.error("AVS.Three.Viewer: WebGLRenderer not set.")},addSelectionListener:function(e){void 0!==e&&this.selectionListeners.push(e)},concatObjectsFromCellNums:function(e,t,i,n){if(void 0!==i&&0!==i.length&&0!==i[0]){for(void 0===n&&(n=t.startCell,i.sort(function(e,t){return e-t}));void 0!==t.nCells&&i[0]>=n&&i[0]<n+t.nCells;)if(t.isMesh?e.push({object:t,faceIndex:i[0]-n}):e.push({object:t,index:(t.isLineSegments?2:1)*(i[0]-n)}),i.splice(0,1),0===i.length)return;void 0!==t.nCells&&(n+=t.nCells);for(var r=0;r<t.children.length&&void 0!==(n=this.concatObjectsFromCellNums(e,t.children[r],i,n));r++);return n}},pick:function(){if(!1!==this.validPick){this.pickDepth===PickDepthEnum.Closest&&this.updatePicking&&(this.pickRender(),this.updatePicking=!1),this.intersects=[];for(var e=0;e<this.scenes.length;e++){var t=this.scenes[e];if(this.pickType===PickTypeEnum.Rectangle){for(var i=Math.max(this.pickRectangleX,t.pixelScissorX),n=Math.max(this.pickRectangleY,t.pixelScissorY),r=Math.min(this.pickRectangleX+this.pickRectangleWidth,t.pixelScissorX+t.pixelScissorWidth),a=Math.min(this.pickRectangleY+this.pickRectangleHeight,t.pixelScissorY+t.pixelScissorHeight),o=[],s=i;s<r;s++)for(var l=n;l<a;l++)if(this.pickDepth===PickDepthEnum.All){var c=(s-t.pixelX)/t.pixelWidth*2-1,h=(l-t.pixelY)/t.pixelHeight*2-1;this.raycaster.setFromCamera(new Vector2(c,h),t.camera);var d=this.raycaster.intersectObjects(t.children,!0);this.intersects=this.intersects.concat(d)}else{var p=4*(s+l*this.pixelWidth),u=255*this.pickingPixelBuffer[p]*255+255*this.pickingPixelBuffer[p+1]+this.pickingPixelBuffer[p+2];this.pickingPixelBuffer2&&(u+=255*this.pickingPixelBuffer2[p]*255*255*255*255+255*this.pickingPixelBuffer2[p+1]*255*255*255+255*this.pickingPixelBuffer2[p+2]*255*255),u>0&&-1===o.indexOf(u)&&o.push(u)}this.pickDepth===PickDepthEnum.Closest&&this.concatObjectsFromCellNums(this.intersects,t,o)}else{if(this.pickRayX<t.pixelScissorX||this.pickRayX>t.pixelScissorX+t.pixelScissorWidth||this.pickRayY<t.pixelScissorY||this.pickRayY>t.pixelScissorY+t.pixelScissorHeight)continue;if(this.pickDepth===PickDepthEnum.All){c=(this.pickRayX-t.pixelX)/t.pixelWidth*2-1,h=(this.pickRayY-t.pixelY)/t.pixelHeight*2-1;this.raycaster.setFromCamera(new Vector2(c,h),t.camera);d=this.raycaster.intersectObjects(t.children,!0);this.intersects=this.intersects.concat(d)}else{p=4*(this.pickRayX+this.pickRayY*this.pixelWidth),u=255*this.pickingPixelBuffer[p]*255+255*this.pickingPixelBuffer[p+1]+this.pickingPixelBuffer[p+2];this.pickingPixelBuffer2&&(u+=255*this.pickingPixelBuffer2[p]*255*255*255*255+255*this.pickingPixelBuffer2[p+1]*255*255*255+255*this.pickingPixelBuffer2[p+2]*255*255),this.concatObjectsFromCellNums(this.intersects,t,[u])}}}for(e=0;e<this.selectionListeners.length;e++)this.selectionListeners[e]()}else console.error("AVS.Three.Viewer: invalid pick ray or rectangle.")},getPickedCells:function(){for(var e=[],t=0;t<this.intersects.length;t++){var i=this.intersects[t].object;if(!1!==i.userData.pickable){for(var n=i.isMesh?this.intersects[t].faceIndex:this.intersects[t].index,r=!1,a=0;a<e.length;a++)if(i===e[a].object){r=!0;for(var o=!1,s=0;s<e[a].indices.length;s++)if(n===e[a].indices[s]){o=!0;break}o||e[a].indices.push(n);break}r||e.push({object:i,indices:[n]})}}return e},getPickedCellSets:function(){for(var e=[],t=0;t<this.intersects.length;t++){var i=this.intersects[t].object;if(!1!==i.userData.pickable){for(var n=!1,r=0;r<e.length;r++)if(e[r].object===i){n=!0;break}n||e.push({object:i})}}return e},getPickedSceneNodes:function(){for(var e=[],t=0;t<this.intersects.length;t++){var i=this.intersects[t].object;if(!1!==i.userData.pickable){for(var n=i.parent,r=!1,a=0;a<e.length;a++)if(e[a].object===n){r=!0;break}r||e.push({object:n})}}return e},getSelectionInfo:function(e){for(var t=[],i=0;i<e.length;i++){var n=e[i].object,r=e[i].indices;if(void 0!==r)for(var a=0;a<r.length;a++){var o={nativeObject:n};t.push(s(n,o,r[a]))}else{o={nativeObject:n};t.push(s(n,o))}}function s(e,t,i){var n=!1;return void 0===t.seriesIndex&&(void 0!==e.userData.seriesIndex?t.seriesIndex=e.userData.seriesIndex:n=!0),void 0===t.itemIndex&&(void 0!==e.userData.itemIndex?void 0!==i&&Array.isArray(e.userData.itemIndex)?t.itemIndex=e.userData.itemIndex[i]:t.itemIndex=e.userData.itemIndex:n=!0),void 0===t.info&&(void 0!==e.userData.info?void 0!==i&&Array.isArray(e.userData.info)?t.info=decodeURIComponent(e.userData.info[i]):Array.isArray(e.userData.info)?t.info=decodeURIComponent("["+e.userData.info+"]"):t.info=decodeURIComponent(e.userData.info):n=!0),n&&e.parent?s(e.parent,t):t}return t},highlightObjects:function(e,t){for(var i=!1,n=0;n<this.highlightList.length;n++){void 0!==(o=this.highlightList[n]).saveMaterial&&(o.material=o.saveMaterial,o.saveMaterial=void 0,i=!0),void 0!==o.saveGeometry&&(o.geometry=o.saveGeometry,o.saveGeometry=void 0,i=!0)}for(n=0;n<this.scenes.length;n++){var r=this.scenes[n].highlightScene.children[0].children;r.length>0&&(r.length=0,this.updateHighlight=!0)}this.highlightList.length=0;var a=this;for(n=0;n<e.length;n++){var o;s(o=e[n].object,e[n].indices)}function s(e,n){if(e.isMesh||e.isLineSegments||e.isPoints){a.highlightList.push(e);var r,o=e.material.clone();if(o.opacity=1,void 0!==n){var l=e.geometry;if(o.vertexColors=VertexColors,o.color=new Color(16777215),e.isThickLineSegments){r=new InstancedBufferGeometry;var c,h=l.attributes.colorStart;if(void 0===h){c=new InstancedInterleavedBuffer(new Float32Array(l.attributes.positionStart.array.length),6,1);for(var d=0,p=0;p<c.array.length/3;p++)c.array[d++]=e.material.color.r,c.array[d++]=e.material.color.g,c.array[d++]=e.material.color.b}else c=h.data.clone();d=null;var u=null;for(p=0;p<n.length;p++){d=6*Math.floor(n[p]/6),u=2;for(var f=0;f<u;f++)c.array[d++]=a.highlightColor.r,c.array[d++]=a.highlightColor.g,c.array[d++]=a.highlightColor.b}for(var m in r.addAttribute("colorStart",new InterleavedBufferAttribute(c,3,0)),r.addAttribute("colorEnd",new InterleavedBufferAttribute(c,3,3)),l.attributes)"colorStart"!==m&&"colorEnd"!==m&&r.addAttribute(m,l.attributes[m])}else{r=new BufferGeometry;var g=l.attributes.color,v=null;if(void 0===g){v=new Float32BufferAttribute(l.attributes.position.array.length,3);for(d=0,p=0;p<v.array.length/3;p++)v.array[d++]=e.material.color.r,v.array[d++]=e.material.color.g,v.array[d++]=e.material.color.b}else v=g.clone();for(d=null,u=null,p=0;p<n.length;p++){e.cellType===CellTypeEnum.Points?(d=3*n[p],u=1):e.cellType===CellTypeEnum.Lines?(d=3*n[p],u=2):e.cellType===CellTypeEnum.Triangles?(d=9*n[p],u=3):(d=18*Math.floor(n[p]/2),u=6);for(f=0;f<u;f++)v.array[d++]=a.highlightColor.r,v.array[d++]=a.highlightColor.g,v.array[d++]=a.highlightColor.b}for(var m in r.addAttribute("color",v),l.attributes)"color"!==m&&r.addAttribute(m,l.attributes[m])}}else o.vertexColors=NoColors,o.color=a.highlightColor,r=e.geometry;var b=a.getObjectScene(e);if(void 0!==b.userData.is3D&&!1===b.userData.is3D&&void 0!==t&&!0===t){var y=e.clone();y.material=o,y.geometry=r,y.matrixAutoUpdate=!1,y.matrix.copy(e.matrixWorld),b.highlightScene.children[0].add(y),a.updateHighlight=!0}else e.saveMaterial=e.material,e.material=o,e.saveGeometry=e.geometry,e.geometry=r,i=!0}for(var x=0;x<e.children.length;x++)s(e.children[x])}i?this.render(!0):this.updateHighlight&&(this.highlightRender(),this.updateHighlight=!1)},getObjectScene:function(e){return e.isScene?e:this.getObjectScene(e.parent)}},TransformInteractor.prototype=Object.create(EventDispatcher.prototype),TransformInteractor.prototype.constructor=TransformInteractor,TransformInteractor.prototype.isTransformInteractor=!0,Object.defineProperties(TransformInteractor.prototype,{center:{get:function(){return console.warn("AVS.Three.TransformInteractor: .center has been renamed to .target"),this.target}},noZoom:{get:function(){return console.warn("AVS.Three.TransformInteractor: .noZoom has been deprecated. Use .enableZoom instead."),!this.enableZoom},set:function(e){console.warn("AVS.Three.TransformInteractor: .noZoom has been deprecated. Use .enableZoom instead."),this.enableZoom=!e}},noRotate:{get:function(){return console.warn("AVS.Three.TransformInteractor: .noRotate has been deprecated. Use .enableRotate instead."),!this.enableRotate},set:function(e){console.warn("AVS.Three.TransformInteractor: .noRotate has been deprecated. Use .enableRotate instead."),this.enableRotate=!e}},noPan:{get:function(){return console.warn("AVS.Three.TransformInteractor: .noPan has been deprecated. Use .enablePan instead."),!this.enablePan},set:function(e){console.warn("AVS.Three.TransformInteractor: .noPan has been deprecated. Use .enablePan instead."),this.enablePan=!e}},noKeys:{get:function(){return console.warn("AVS.Three.TransformInteractor: .noKeys has been deprecated. Use .enableKeys instead."),!this.enableKeys},set:function(e){console.warn("AVS.Three.TransformInteractor: .noKeys has been deprecated. Use .enableKeys instead."),this.enableKeys=!e}},staticMoving:{get:function(){return console.warn("AVS.Three.TransformInteractor: .staticMoving has been deprecated. Use .enableDamping instead."),!this.enableDamping},set:function(e){console.warn("AVS.Three.TransformInteractor: .staticMoving has been deprecated. Use .enableDamping instead."),this.enableDamping=!e}},dynamicDampingFactor:{get:function(){return console.warn("AVS.Three.TransformInteractor: .dynamicDampingFactor has been renamed. Use .dampingFactor instead."),this.dampingFactor},set:function(e){console.warn("AVS.Three.TransformInteractor: .dynamicDampingFactor has been renamed. Use .dampingFactor instead."),this.dampingFactor=e}}}),DomainTransformInteractor.prototype=Object.create(EventDispatcher.prototype),DomainTransformInteractor.prototype.constructor=DomainTransformInteractor,DomainTransformInteractor.prototype.isDomainTransformInteractor=!0,Object.defineProperties(DomainTransformInteractor.prototype,{center:{get:function(){return console.warn("AVS.Three.DomainTransformInteractor: .center has been renamed to .target"),this.target}},noZoom:{get:function(){return console.warn("AVS.Three.DomainTransformInteractor: .noZoom has been deprecated. Use .enableZoom instead."),!this.enableZoom},set:function(e){console.warn("AVS.Three.DomainTransformInteractor: .noZoom has been deprecated. Use .enableZoom instead."),this.enableZoom=!e}},noRotate:{get:function(){return console.warn("AVS.Three.DomainTransformInteractor: .noRotate has been deprecated. Use .enableRotate instead."),!this.enableRotate},set:function(e){console.warn("AVS.Three.DomainTransformInteractor: .noRotate has been deprecated. Use .enableRotate instead."),this.enableRotate=!e}},noPan:{get:function(){return console.warn("AVS.Three.DomainTransformInteractor: .noPan has been deprecated. Use .enablePan instead."),!this.enablePan},set:function(e){console.warn("AVS.Three.DomainTransformInteractor: .noPan has been deprecated. Use .enablePan instead."),this.enablePan=!e}},noKeys:{get:function(){return console.warn("AVS.Three.DomainTransformInteractor: .noKeys has been deprecated. Use .enableKeys instead."),!this.enableKeys},set:function(e){console.warn("AVS.Three.DomainTransformInteractor: .noKeys has been deprecated. Use .enableKeys instead."),this.enableKeys=!e}},staticMoving:{get:function(){return console.warn("AVS.Three.DomainTransformInteractor: .staticMoving has been deprecated. Use .enableDamping instead."),!this.enableDamping},set:function(e){console.warn("AVS.Three.DomainTransformInteractor: .staticMoving has been deprecated. Use .enableDamping instead."),this.enableDamping=!e}},dynamicDampingFactor:{get:function(){return console.warn("AVS.Three.DomainTransformInteractor: .dynamicDampingFactor has been renamed. Use .dampingFactor instead."),this.dampingFactor},set:function(e){console.warn("AVS.Three.DomainTransformInteractor: .dynamicDampingFactor has been renamed. Use .dampingFactor instead."),this.dampingFactor=e}}});export{Viewer,TransformInteractor,DomainTransformInteractor,REVISION,DEFAULT_VIEWER_WIDTH,DEFAULT_VIEWER_HEIGHT,RAYCASTER_LINE_PRECISION,PickDepthEnum,PickTypeEnum,PickLevelEnum,CellTypeEnum};
